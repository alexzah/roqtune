import { Button, VerticalBox, StandardTableView, ComboBox } from "std-widgets.slint";

component TrackRow inherits Rectangle {
    in property <[StandardListViewItem]> data;
    in property <bool> is-playing;
    in property <bool> is-selected;
    in property <bool> is-dragging;
    in property <bool> is-drop-target;
    in property <int> index;
    
    callback clicked(PointerEvent);
    callback drag-started(int);
    callback drag-moved(length);
    callback drag-ended();
    
    height: 30px;
    background: is-dragging ? #444 : is-selected ? #3d3d3d : is-drop-target ? #2a6def : transparent;
    
    HorizontalLayout {
        padding-left: 8px;
        padding-right: 8px;
        spacing: 10px;
        
        // Status Column
        Rectangle {
            width: 40px;
            Text {
                text: root.data[0].text;
                color: #2a6def;
                font-size: 14px;
                horizontal-alignment: center;
            }
        }
        
        // Title Column
        Text {
            text: root.data[1].text;
            color: #eee;
            font-size: 13px;
            vertical-alignment: center;
            horizontal-stretch: 1;
            overflow: elide;
        }
        
        // Artist Column
        Text {
            text: root.data[2].text;
            color: #aaa;
            font-size: 13px;
            vertical-alignment: center;
            width: 200px;
            overflow: elide;
        }
        
        // Album Column
        Text {
            text: root.data[3].text;
            color: #888;
            font-size: 13px;
            vertical-alignment: center;
            width: 200px;
            overflow: elide;
        }
    }
    
    ta := TouchArea {
        property <length> start-y;
        property <bool> dragging: false;
        property <bool> was-selected-on-down: false;

        pointer-event(event) => {
            if (event.button == PointerEventButton.left) {
                if (event.kind == PointerEventKind.down) {
                    self.start-y = self.mouse-y;
                    self.was-selected-on-down = root.is-selected;
                    
                    // If not already selected, select it immediately to allow dragging
                    if (!self.was-selected-on-down) {
                        root.clicked(event);
                    }
                } else if (event.kind == PointerEventKind.up) {
                    if (self.dragging) {
                        self.dragging = false;
                        root.drag-ended();
                    } else {
                        // Clicked but didn't drag. 
                        // If it was already selected, we now clear other selections (if no modifiers)
                        if (self.was-selected-on-down) {
                            root.clicked(event);
                        }
                    }
                }
            }
        }
        
        moved => {
            if (self.pressed) {
                if (!self.dragging && abs(self.mouse-y - self.start-y) > 5px) {
                    self.dragging = true;
                    root.drag-started(root.index);
                }
                
                if (self.dragging) {
                    // Send total Y offset relative to start of list
                    root.drag-moved(root.index * 30px + self.mouse-y);
                }
            }
        }
    }
}

component PlayerButton inherits Rectangle {
    width: 32px;
    height: 32px;
    background: touch-area.pressed ? #444 : touch-area.has-hover ? #666 : transparent;
    animate background { duration: 150ms; }
    in property <string> icon-text;
    in property <bool> enabled: true;
    in property <bool> is-primary: false;
    in property <length> font-size: 16px;
    callback clicked;
    Text {
        text: root.icon-text;
        font-size: root.font-size;
        color: root.is-primary ? #2a6def : #eee;
        horizontal-alignment: center;
        opacity: root.enabled ? 1.0 : 0.5;
    }

    touch-area := TouchArea {
        clicked => {
            if (root.enabled) {
                root.clicked();
            }
        }
    }
}

export component AppWindow inherits Window {
    width: 900px;
    height: 650px;
    title: "fooBar-like Music Player";
    background: #282828;

    key-handler := FocusScope {
        width: 0px;
        height: 0px;
        key-pressed(event) => {
            if (event.text == Key.Delete) {
                root.delete_track(root.selected_track_index);
                return accept;
            }
            reject
        }
    }
    
    // Status display at the bottom showing the currently playing track
    in-out property <string> status-text: "No track selected";

    VerticalLayout {
        // Toolbar with open and playback controls
        Rectangle {
            height: 42px;
            background: #202020;
            HorizontalLayout {
                padding-left: 8px;
                padding-right: 8px;
                padding-top: 8px;
                padding-bottom: 8px;
                spacing: 8px;
                
                // Open file button
                Rectangle {
                    width: 80px;
                    height: 28px;
                    border-radius: 2px;
                    background: #373737;
                    HorizontalLayout {
                        alignment: center;
                        spacing: 4px;
                        Text {
                            text: "ðŸ“‚"; 
                            color: #ddd;
                            font-size: 14px;
                        }

                        Text {
                            text: "Open";
                            color: #ddd;
                            font-size: 14px;
                        }
                    }

                    TouchArea {
                        clicked => {
                            root.open_file();
                        }
                    }
                }
                
                // Playback controls
                HorizontalLayout {
                    alignment: center;
                    spacing: 14px;
                    PlayerButton {
                        icon-text: "â®";
                        clicked => {
                            root.previous();
                        }
                    }

                    PlayerButton {
                        icon-text: "â–¶";
                        is-primary: true;
                        clicked => {
                            root.play();
                        }
                    }

                    PlayerButton {
                        icon-text: "â¸";
                        clicked => {
                            root.pause();
                        }
                    }

                    PlayerButton {
                        icon-text: "â¹";
                        clicked => {
                            root.stop();
                        }
                    }

                    PlayerButton {
                        icon-text: "â­";
                        clicked => {
                            root.next();
                        }
                    }
                }
                
                // Playback mode selection
                HorizontalLayout {
                    spacing: 8px;
                    Text {
                        text: "Order:";
                        color: #aaa;
                        font-size: 14px;
                    }

                    ComboBox {
                        width: 200px;
                        height: 28px;
                        model: ["Default", "Shuffle", "Random"];
                        current-index: root.playback_order_index;
                        selected => {
                            root.playback_order_changed(self.current-index);
                        }
                    }

                    Text {
                        text: "Repeat:";
                        color: #aaa;
                        font-size: 14px;
                    }

                    PlayerButton {
                        icon-text: root.repeat_on ? "ðŸ”" : "â†©";
                        font-size: 14px;
                        is-primary: root.repeat_on;
                        clicked => {
                            root.toggle_repeat();
                        }
                    }
                }
                
                // Spacer to push notification area to the right
                Rectangle { }
                
                // Status area
                Text {
                    text: status;
                    color: #aaa;
                    font-size: 13px;
                }
            }
        }
        
        // Progress bar section
        Rectangle {
            height: 36px;
            background: #242424;
            HorizontalLayout {
                padding-left: 16px;
                padding-right: 16px;
                padding-top: 10px;
                padding-bottom: 10px;
                spacing: 8px;
                
                // Current time display
                Rectangle {
                    background: #444;
                    border-radius: 2px;
                    width: 70px;
                    Text {
                        text: root.current-position-text;
                        color: #bbb;
                        font-size: 13px;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                }
                
                // Improved interactive seek bar
                seekbar := Rectangle {
                    height: 16px;
                    border-radius: 3px;
                    background: #333;
                    horizontal-stretch: 1;
                    
                    // Progress indicator
                    Rectangle {
                        x: 0;
                        y: 0;
                        width: seekbar.width * root.position-percentage;
                        height: parent.height;
                        background: #2a6def;
                        border-radius: 3px;
                        animate width {
                            duration: 150ms;
                            easing: ease-out;
                        }
                    }
                    
                    // Position percentage label for debugging
                    Text {
                        text: round(root.position-percentage * 100) + "%";
                        color: white;
                        font-size: 10px;
                        y: -16px;
                        x: seekbar.width / 2 - self.width / 2;
                    }
                    
                    // Handle over the progress bar
                    handle := Rectangle {
                        width: 10px;
                        height: parent.height;
                        x: (seekbar.width * root.position-percentage) - self.width / 2;
                        y: 0px;
                        background: white;
                        border-radius: 5px;
                        drop-shadow-offset-y: 1px;
                        drop-shadow-blur: 2px;
                        drop-shadow-color: #00000080;
                        
                        // Smooth animation for handle position updates
                        animate x {
                            duration: 150ms;
                            easing: ease-out;
                        }
                    }
                    
                    // Focus highlighting when hovering
                    states [
                        hover when ta-seek.has-hover || ta-seek.pressed: {
                            handle.background: #ffffff;
                        }
                    ]
                    
                    // Simple touch area for seeking
                    ta-seek := TouchArea {
                        width: parent.width;
                        height: parent.height + 10px; // Make touch area slightly larger
                        mouse-cursor: pointer;
                        clicked => {
                            // Calculate position as percentage of width and send seek command
                            root.seek-to(max(0, min(1, self.mouse-x / seekbar.width)));
                        }
                        moved => {
                            if (self.pressed) {
                                // Update while dragging
                                root.seek-to(max(0, min(1, self.mouse-x / seekbar.width)));
                            }
                        }
                    }
                }
                
                // Total duration display
                Text {
                    text: root.total-duration-text;
                    color: #bbb;
                    font-size: 13px;
                    vertical-alignment: center;
                    width: 45px;
                }
            }
        }
        
        // Main content: Playlist 
        Rectangle {
            vertical-stretch: 1;
            background: #282828;
            
            VerticalLayout {
                // Header
                Rectangle {
                    height: 25px;
                    background: #202020;
                    HorizontalLayout {
                        padding-left: 8px;
                        padding-right: 8px;
                        spacing: 10px;
                        Text { text: ""; width: 40px; }
                        Text { text: "Title"; color: #888; font-size: 12px; horizontal-stretch: 1; }
                        Text { text: "Artist"; color: #888; font-size: 12px; width: 200px; }
                        Text { text: "Album"; color: #888; font-size: 12px; width: 200px; }
                    }
                }
                
                flick := Flickable {
                    interactive: root.drag-index == -1;
                    viewport-height: root.track_model.length * 30px;
                    
                    VerticalLayout {
                        alignment: start;
                        for track[i] in root.track_model : TrackRow {
                            index: i;
                            data: track;
                            is-playing: root.playing_track_index == i;
                            is-selected: root.selection_model[i];
                            is-dragging: root.drag-index == i;
                            // Dim selected items while dragging to clarify the drop line
                            opacity: root.drag-index != -1 && root.selection_model[i] ? 0.5 : 1.0;
                            
                            clicked(event) => {
                                root.playlist_item_click(i, event, {x: 0, y: 0});
                                key-handler.focus();
                            }
                            
                            drag-started(idx) => {
                                root.drag-index = idx;
                            }
                            
                            drag-moved(y-offset) => {
                                // y-offset is relative to start of list. 
                                // (y + half_row) / row_height gives the gap index.
                                root.drop-index = max(0, min(root.track_model.length, floor((y-offset + 15px) / 30px)));
                            }
                            
                            drag-ended() => {
                                if (root.drop-index != -1) {
                                    // If dragging a selected item, move all selected items
                                    if (root.selection_model[root.drag-index]) {
                                        root.reorder_tracks(root.selected_indices, root.drop-index);
                                    } else {
                                        // Dragging a non-selected item
                                        root.reorder_tracks([root.drag-index], root.drop-index);
                                    }
                                }
                                root.drag-index = -1;
                                root.drop-index = -1;
                            }
                        }
                    }
                }
            }
            
            // Visual Drop Indicator (horizontal line between tracks)
            if (root.drag-index != -1 && root.drop-index != -1) : Rectangle {
                x: 0;
                // Position line between rows. flickering.viewport-y is negative when scrolled down.
                y: 25px + (root.drop-index * 30px) + flick.viewport-y - 1px;
                width: 100%;
                height: 2px;
                background: #2a6def;
            }
        }
        
        // Status bar
        Rectangle {
            height: 28px;
            background: #1a1a1a;
            HorizontalLayout {
                padding-left: 10px;
                padding-right: 10px;
                Text {
                    text: "Now Playing: " + root.status-text;
                    color: #bbb;
                    font-size: 13px;
                }
                
                // Technical info area
                Rectangle { }
                Text {
                    text: root.technical-info;
                    color: #888;
                    font-size: 12px;
                }
                Text {
                    text: root.time-info;
                    color: #aaa;
                    font-size: 13px;
                    width: 100px;
                    horizontal-alignment: right;
                }
            }
        }
    }

    // Properties to communicate with Rust
    in-out property <string> file_path: "";
    in-out property <string> status: "Ready";
    in-out property <[[StandardListViewItem]]> track_model: []; // holds rows of strings
    in-out property <[bool]> selection_model: []; 
    in-out property <int> playback_order_index: 0;
    in-out property <bool> repeat_on: false;
    in-out property <int> selected_track_index: -1;
    in-out property <[int]> selected_indices: [];
    in-out property <int> playing_track_index: -1;
    
    // Drag and drop state
    property <int> drag-index: -1;
    property <int> drop-index: -1;
    
    // Seek bar properties
    in-out property <float> current-position: 0.0; // in seconds
    in-out property <float> total-duration: 0.0; // in seconds
    in-out property <float> position-percentage: 0.0; // between 0.0 and 1.0
    in-out property <string> current-position-text: "0:00";
    in-out property <string> total-duration-text: "0:00";
    in-out property <string> technical-info: "";
    in-out property <string> time-info: "";

    // Callback declarations
    callback open_file();
    callback play();
    callback pause();
    callback stop();
    callback next();
    callback previous();
    callback playlist_item_click(int, PointerEvent, Point);
    callback playback_order_changed(int);
    callback toggle_repeat();
    callback seek-to(float); // Position between 0.0 and 1.0
    callback delete_track(int);
    callback reorder_tracks([int], int); // indices, to
}
