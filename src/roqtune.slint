import { Button, ComboBox, VerticalBox, StandardTableView, ScrollView, LineEdit, TextEdit, ListView, Switch, Slider } from "std-widgets.slint";

import {
    LayoutAlbumArtViewerPanelModel,
    LayoutButtonClusterPanelModel,
    LayoutMetadataViewerPanelModel,
    LayoutSplitterModel,
    LibraryRowData,
    MetadataEditorField,
    TrackRowData
} from "ui/types.slint";
import { ColumnHeaderMenu, ConfirmationDialog, InfoDialog } from "ui/components/menus.slint";
import { PlayerButton, ButtonCluster, TooltipHoverArea } from "ui/components/controls.slint";
import { VolumeSliderControl, SeekBarControl, TextPanel, ImagePanel } from "ui/components/media.slint";
import { PlaylistRow, TrackRow } from "ui/components/playlist.slint";
import { ModeTabs } from "ui/components/tabs.slint";
import { LibraryRow } from "ui/components/library.slint";
import { SettingsDropdownControl } from "ui/components/settings.slint";
import { StatusBar } from "ui/components/status.slint";
import { AppIcons } from "ui/icons.slint";
import { AppPalette } from "ui/theme_palette.slint";
export { AppPalette } from "ui/theme_palette.slint";

export component AppWindow inherits Window {
    preferred-width: 900px;
    preferred-height: 650px;
    min-width: 600px;
    min-height: 400px;
    in-out property <string> app_window_title: "roqtune";
    title: root.app_window_title;
    in-out property <bool> ui_dark_mode: true;
    property <brush> theme_window_bg: AppPalette.window-bg;
    property <brush> theme_surface_bg: AppPalette.panel-bg;
    property <brush> theme_surface_alt_bg: AppPalette.panel-bg-alt;
    property <brush> theme_border: AppPalette.border;
    property <brush> theme_separator: AppPalette.separator;
    property <brush> theme_text_primary: AppPalette.text-primary;
    property <brush> theme_text_secondary: AppPalette.text-secondary;
    property <brush> theme_text_muted: AppPalette.text-muted;
    background: root.theme_window_bg;

    key-handler := FocusScope {
        width: 0px;
        height: 0px;
        key-pressed(event) => {
            root.playlist-link-modifier-active = event.modifiers.control || event.modifiers.meta;
            if (event.text == Key.F6 || ((event.text == "l" || event.text == "L") && event.modifiers.control)) {
                root.open_layout_editor();
                return accept;
            }
            if ((event.text == "f" || event.text == "F") && event.modifiers.control) {
                if (root.collection_mode == 1) {
                    root.open_library_search();
                } else {
                    root.open_playlist_search();
                }
                return accept;
            }
            if ((event.text == "z" || event.text == "Z") && event.modifiers.control) {
                if (event.modifiers.shift) {
                    if (root.layout_edit_mode) {
                        root.layout_redo_last_action();
                    } else {
                        root.redo_last_action();
                    }
                } else {
                    if (root.layout_edit_mode) {
                        root.layout_undo_last_action();
                    } else {
                        root.undo_last_action();
                    }
                }
                return accept;
            }
            if ((event.text == "c" || event.text == "C") && event.modifiers.control) {
                root.copy_selected_tracks();
                return accept;
            }
            if ((event.text == "x" || event.text == "X") && event.modifiers.control) {
                root.cut_selected_tracks();
                return accept;
            }
            if ((event.text == "v" || event.text == "V") && event.modifiers.control) {
                root.paste_copied_tracks();
                return accept;
            }
            if ((event.text == "a" || event.text == "A") && event.modifiers.control) {
                root.select_all();
                return accept;
            }
            if (event.text == Key.UpArrow) {
                root.arrow_key_navigate(-1, event.modifiers.shift);
                return accept;
            }
            if (event.text == Key.DownArrow) {
                root.arrow_key_navigate(1, event.modifiers.shift);
                return accept;
            }
            if (event.text == Key.Home) {
                let visible-rows = root.collection_mode == 1 ? root.library-visible-row-count : root.playlist-visible-row-count;
                root.page_navigate(0, event.modifiers.shift, visible-rows);
                return accept;
            }
            if (event.text == Key.End) {
                let visible-rows = root.collection_mode == 1 ? root.library-visible-row-count : root.playlist-visible-row-count;
                root.page_navigate(1, event.modifiers.shift, visible-rows);
                return accept;
            }
            if (event.text == Key.PageUp) {
                let visible-rows = root.collection_mode == 1 ? root.library-visible-row-count : root.playlist-visible-row-count;
                root.page_navigate(2, event.modifiers.shift, visible-rows);
                return accept;
            }
            if (event.text == Key.PageDown) {
                let visible-rows = root.collection_mode == 1 ? root.library-visible-row-count : root.playlist-visible-row-count;
                root.page_navigate(3, event.modifiers.shift, visible-rows);
                return accept;
            }
            if (event.text == Key.Escape && root.show_import_menu) {
                root.show_import_menu = false;
                return accept;
            }
            if (event.text == Key.Escape && root.show_library_folder_menu) {
                root.show_library_folder_menu = false;
                return accept;
            }
            if (event.text == Key.Escape && root.show_settings_menu) {
                root.show_settings_menu = false;
                return accept;
            }
            if (event.text == Key.Escape && root.show_cast_menu) {
                root.show_cast_menu = false;
                return accept;
            }
            if (event.text == Key.Escape && root.show_viewer_panel_settings_menu) {
                root.show_viewer_panel_settings_menu = false;
                return accept;
            }
            if (event.text == Key.Escape && root.show_collection_panel_settings_menu) {
                root.show_collection_panel_settings_menu = false;
                return accept;
            }
            if (event.text == Key.Escape && root.show_template_language_reference) {
                root.show_template_language_reference = false;
                return accept;
            }
            if (event.text == Key.Escape && root.show_library_context_menu) {
                root.show_library_context_menu = false;
                return accept;
            }
            if (event.text == Key.Escape && root.show_playlist_track_context_menu) {
                root.show_playlist_track_context_menu = false;
                return accept;
            }
            if (event.text == Key.Escape && root.show_library_remove_confirm) {
                root.library_cancel_remove_selection();
                root.show_library_remove_confirm = false;
                return accept;
            }
            if (event.text == Key.Escape && root.library_add_to_dialog_visible) {
                root.library_cancel_add_to_playlists();
                return accept;
            }
            if (event.text == Key.Escape && root.show_properties_dialog && !root.properties_busy) {
                root.properties_cancel();
                return accept;
            }
            if (event.text == Key.Escape && root.show_subsonic_session_password_prompt) {
                root.subsonic_session_password_cancel();
                return accept;
            }
            if (event.text == Key.Escape && root.show_subsonic_keyring_notice) {
                root.show_subsonic_keyring_notice = false;
                root.refocus_main();
                return accept;
            }
            if (event.text == Key.Escape && root.layout_edit_mode) {
                root.show_layout_editor_dialog = false;
                root.show_layout_leaf_context_menu = false;
                root.show_layout_splitter_context_menu = false;
                root.open_layout_editor();
                return accept;
            }
            if (event.text == Key.Escape && root.library_search_visible) {
                root.close_library_search();
                key-handler.focus();
                return accept;
            }
            if (event.text == Key.Escape && root.playlist_search_visible) {
                root.close_playlist_search();
                key-handler.focus();
                return accept;
            }
            if (event.text == Key.Escape && root.playlist_filter_active) {
                root.clear_playlist_filter_view();
                key-handler.focus();
                return accept;
            }
            if (event.text == Key.Delete) {
                if (root.collection_mode == 1) {
                    if (root.show_library_remove_confirm
                            || root.show_confirm_dialog
                            || root.show_remote_detach_confirm
                            || root.show_apply_filter_view_confirm) {
                        return reject;
                    }
                    root.delete_selected_tracks();
                    return accept;
                } else {
                    if (root.editing_playlist_index != -1
                            || root.show_confirm_dialog
                            || root.show_remote_detach_confirm
                            || root.show_apply_filter_view_confirm) {
                        return reject;
                    }
                    if (root.sidebar_has_focus) {
                        root.confirm_delete_playlist(root.active_playlist_index);
                    } else {
                        root.delete_selected_tracks();
                    }
                    return accept;
                }
            }
            if (event.text == Key.F2) {
                root.editing_playlist_index = root.active_playlist_index;
                root.new_playlist_edit_index = -1;
                return accept;
            }
            reject
        }
        key-released(event) => {
            root.playlist-link-modifier-active = event.modifiers.control || event.modifiers.meta;
            accept
        }
    }

    init => {
        key-handler.focus();
    }
    
    public function refocus_main() {
        key-handler.focus();
    }

    public function focus_library_search_input() {
        root.library_search_focus_token += 1;
    }

    public function confirm_delete_playlist(index: int) {
        if (index >= 0 && index < root.playlists.length) {
            root.delete_target_index = index;
            root.delete_confirm_message = "Are you sure you want to delete the playlist '" + root.playlists[index].text + "'?";
            root.show_confirm_dialog = true;
        }
    }

    public function confirm_apply_filter_view() {
        if (root.playlist_filter_active) {
            root.apply_filter_view_confirm_message = "Save read-only view into playlist? This will overwrite the playlist contents.";
            root.show_apply_filter_view_confirm = true;
        }
    }

    property <int> delete_target_index: -1;
    property <string> delete_confirm_message: "";
    in-out property <bool> show_confirm_dialog: false;
    in-out property <bool> show_remote_detach_confirm: false;
    in-out property <string> remote_detach_confirm_message: "";
    in-out property <string> remote_detach_target_playlist_id: "";
    in-out property <bool> show_apply_filter_view_confirm: false;
    in-out property <bool> show_library_remove_confirm: false;
    in-out property <string> library_remove_confirm_message:
        "Remove from library? This will not delete any files\n\nNote: tracks may be re-added in a rescan if files remain in library folders";
    in-out property <string> apply_filter_view_confirm_message: "";
    in-out property <int> delete_custom_column_index: -1;
    in-out property <string> delete_custom_column_message: "";
    in-out property <bool> show_delete_custom_column_confirm: false;
    in-out property <bool> sidebar_has_focus: false;
    property <length> null-column-width: 120px;
    property <length> playlist-row-padding-x: 8px;
    property <length> playlist-column-spacing: 10px;
    property <length> playlist-status-lane-width: 40px;
    property <length> playlist-columns-band-offset-x: root.playlist-row-padding-x
        + root.playlist-status-lane-width
        + root.playlist-column-spacing;
    property <length> playlist-fixed-chrome-width: root.playlist-row-padding-x * 2
        + root.playlist-status-lane-width
        + root.null-column-width
        + root.playlist-column-spacing * 3;
    property <length> column-menu-x: 0px;
    property <length> column-menu-y: 0px;
    in-out property <int> column_drag_from: -1;
    in-out property <int> column_drop_gap: -1;
    in-out property <int> column_resize_index: -1;
    in-out property <bool> column_resize_active: false;
    in-out property <int> column_hover_divider: -1;
    in-out property <int> column_resize_start_width_px: 0;
    in-out property <int> column_resize_min_width_px: 1;
    in-out property <int> column_resize_max_width_px: 1024;
    in-out property <int> column_resize_preview_width_px: 0;
    in-out property <int> column_click_candidate: -1;
    in-out property <bool> column_drag_moved: false;
    property <length> column_resize_start_mouse_x: 0px;
    property <length> column_click_start_x: 0px;
    in-out property <bool> show_custom_column_dialog: false;
    in-out property <string> custom_column_name: "";
    in-out property <string> custom_column_format: "";
    in-out property <bool> show_template_language_reference: false;
    in-out property <[int]> playlist_column_widths_px: [];
    in-out property <[int]> playlist_column_gap_positions_px: [];
    in-out property <int> playlist_columns_content_width_px: 0;
    in-out property <int> playlist_columns_available_width_px: 0;
    property <length> playlist-content-width: root.playlist-fixed-chrome-width
        + max(0px, root.playlist_columns_content_width_px * 1px);
    in-out property <[LayoutButtonClusterPanelModel]> layout_button_cluster_panels: [];
    in-out property <[LayoutMetadataViewerPanelModel]> layout_metadata_viewer_panels: [];
    in-out property <[LayoutAlbumArtViewerPanelModel]> layout_album_art_viewer_panels: [];
    in-out property <[int]> layout_region_collection_modes: [];
    in-out property <bool> show_import_menu: false;
    property <length> import_menu_width: 176px;
    property <length> import_menu_height: 104px;
    property <length> import_menu_x: 0px;
    property <length> import_menu_y: 0px;
    in-out property <bool> show_library_folder_menu: false;
    property <length> library_folder_menu_width: 196px;
    property <length> library_folder_menu_height: 70px;
    property <length> library_folder_menu_x: 0px;
    property <length> library_folder_menu_y: 0px;
    in-out property <bool> show_settings_menu: false;
    property <length> settings_menu_x: 0px;
    property <length> settings_menu_y: 0px;
    in-out property <bool> show_cast_menu: false;
    property <length> cast_menu_x: 0px;
    property <length> cast_menu_y: 0px;
    in-out property <bool> show_control_cluster_menu: false;
    in-out property <string> control_cluster_menu_target_leaf_id: "";
    in-out property <[int]> control_cluster_menu_actions: [];
    in-out property <int> control_cluster_add_option_index: 0;
    in-out property <length> control_cluster_menu_x: 0px;
    in-out property <length> control_cluster_menu_y: 0px;
    in-out property <bool> show_viewer_panel_settings_menu: false;
    in-out property <string> viewer_panel_settings_target_leaf_id: "";
    in-out property <int> viewer_panel_settings_target_panel_kind: root.panel_kind_none;
    in-out property <int> viewer_panel_settings_display_priority_index: 0;
    in-out property <int> viewer_panel_settings_metadata_source_index: 0;
    in-out property <string> viewer_panel_settings_metadata_text_format: "";
    in-out property <int> viewer_panel_settings_image_source_index: 0;
    in-out property <length> viewer_panel_settings_x: 0px;
    in-out property <length> viewer_panel_settings_y: 0px;
    in-out property <bool> show_collection_panel_settings_menu: false;
    in-out property <string> collection_panel_settings_target_leaf_id: "";
    in-out property <int> collection_panel_settings_target_panel_kind: root.panel_kind_none;
    in-out property <int> collection_panel_settings_mode_index: 0;
    in-out property <length> collection_panel_settings_x: 0px;
    in-out property <length> collection_panel_settings_y: 0px;
    property <[string]> viewer_panel_display_priority_options: [
        "Balanced (Default)",
        "Prefer Selection",
        "Prefer Now Playing",
        "Selection Only",
        "Now Playing Only"
    ];
    property <[string]> viewer_panel_metadata_source_options: [
        "Track (Default)",
        "Album Description",
        "Artist Bio",
        "Custom Text"
    ];
    property <[string]> viewer_panel_image_source_options: [
        "Album Art (Default)",
        "Artist Image"
    ];
    property <[string]> collection_panel_mode_options: [
        "Both (Default)",
        "Playlist Only",
        "Library Only"
    ];
    property <string> template_language_reference_text:
        "Template Language Reference\n\n"
        + "Plain text\n"
        + "Any characters outside placeholders/tags are emitted unchanged.\n\n"
        + "Escaping\n"
        + "Use backslash to force literal output: \\{ \\} \\[ \\] \\\\.\n"
        + "Example: \\{artist\\} \\[b\\]x\\[/b\\] \\\\ -> {artist} [b]x[/b] \\\n\n"
        + "Line breaks\n"
        + "Use either \\n or [br]. Both render one new line.\n\n"
        + "Placeholders\n"
        + "Syntax: {field} or {field1;field2;field3}\n"
        + "Fallback chains return the first non-empty field.\n"
        + "Supported fields: title, artist, album, album_artist, date, year, genre,\n"
        + "track_number, file_name, path.\n"
        + "Unknown/invalid placeholders are rendered literally.\n\n"
        + "Style tags\n"
        + "[b] [/b] bold\n"
        + "[i] [/i] italic\n"
        + "[u] [/u] underline\n"
        + "[font=Family Name] [/font] font family\n"
        + "[color=name] [/color] palette color key (for example accent, text_muted)\n"
        + "[color=#rrggbb] [/color] hex color\n"
        + "Tags are nestable and apply to enclosed content only.\n\n"
        + "Size tags\n"
        + "[size=<value>] [/size]\n"
        + "Numeric values (for example 18) are fixed px and non-responsive.\n"
        + "Role values are responsive relative scales:\n"
        + "micro=70%, caption=82%, body=100%, body_large=115%,\n"
        + "title=130%, h3=150%, h2=175%, h1=205%, spotlight=245%\n\n"
        + "Lenient parsing\n"
        + "Unknown tags, mismatched closing tags, and malformed placeholders\n"
        + "never crash rendering. Invalid pieces are shown as literal text.\n\n"
        + "Examples\n"
        + "[b][size=title]{title;file_name}[/size][/b]\\n"
        + "[i]{artist;album_artist}[/i] • {album}\\n"
        + "[color=text_muted]{date;year} • {genre}[/color]";
    in-out property <int> sidebar_width_px: 220;
    in-out property <int> collection_mode: 0; // 0: Playlist, 1: Library
    property <int> playlist-visible-row-count: 1;
    property <int> library-visible-row-count: 1;
    in-out property <int> library_root_index: 0; // 0: Tracks, 1: Artists, 2: Albums, 3: Genres, 4: Decades, 5: Favorites
    in-out property <[int]> library_root_counts: [0, 0, 0, 0, 0, 0];
    in-out property <bool> library_can_go_back: false;
    in-out property <bool> library_scan_in_progress: false;
    in-out property <string> library_view_title: "Tracks";
    in-out property <string> library_view_subtitle: "";
    in-out property <string> library_status_text: "";
    in-out property <string> library_toast_text: "";
    in-out property <bool> library_toast_visible: false;
    in-out property <bool> library_album_header_visible: false;
    in-out property <bool> library_album_header_has_art: false;
    in-out property <image> library_album_header_art;
    in-out property <string> library_album_header_meta: "";
    in-out property <string> library_detail_header_blurb: "";
    in-out property <string> library_detail_header_source_name: "";
    in-out property <string> library_detail_header_source_url: "";
    in-out property <bool> library_detail_header_source_visible: false;
    in-out property <bool> library_detail_header_loading: false;
    in-out property <bool> library_online_prompt_visible: false;
    in-out property <int> playlist_scroll_target_row: 0;
    in-out property <int> playlist_scroll_center_token: 0;
    in-out property <int> library_scroll_target_row: 0;
    in-out property <int> library_scroll_restore_token: 0;
    in-out property <int> library_scroll_center_token: 0;
    in-out property <[LibraryRowData]> library_model: [];
    in-out property <bool> show_library_context_menu: false;
    property <length> library_context_menu_x: 0px;
    property <length> library_context_menu_y: 0px;
    in-out property <bool> show_playlist_track_context_menu: false;
    property <length> playlist_track_context_menu_x: 0px;
    property <length> playlist_track_context_menu_y: 0px;
    // Context menu sizing constants
    property <length> context-menu-item-height: 24px;
    property <int> context-menu-item-count: 6;
    property <length> context-menu-padding: 8px;
    property <length> context-menu-spacing-total: 10px;
    property <length> context-menu-margin: 8px;
    property <length> context-menu-height: context-menu-item-height * context-menu-item-count + context-menu-spacing-total + context-menu-padding;
    in-out property <bool> playlist_properties_enabled: false;
    in-out property <bool> library_properties_enabled: false;
    in-out property <bool> library_add_to_dialog_visible: false;
    in-out property <[string]> library_add_to_playlist_labels: [];
    in-out property <[bool]> library_add_to_playlist_checked: [];
    in-out property <int> library_selected_count: 0;
    in-out property <bool> library_add_to_confirm_enabled: false;
    in-out property <bool> show_properties_dialog: false;
    in-out property <bool> properties_busy: false;
    in-out property <string> properties_error_text: "";
    in-out property <string> properties_target_title: "";
    in-out property <[MetadataEditorField]> properties_fields: [];
    in-out property <bool> properties_save_enabled: false;
    in-out property <[string]> settings_library_folders: [];
    in-out property <int> settings_library_selected_folder_index: -1;
    in-out property <bool> settings_library_online_metadata_enabled: false;
    in-out property <bool> settings_library_include_playlist_tracks_in_library: true;
    in-out property <bool> library_has_any_content: false;
    in-out property <bool> layout_edit_mode: false;
    in-out property <bool> show_layout_editor_dialog: false;
    in-out property <bool> show_layout_leaf_context_menu: false;
    in-out property <bool> show_layout_leaf_replace_submenu: false;
    in-out property <bool> layout_leaf_replace_submenu_hover: false;
    in-out property <bool> show_layout_leaf_panels_submenu: false;
    in-out property <bool> layout_leaf_panels_submenu_hover: false;
    in-out property <bool> show_layout_leaf_presets_submenu: false;
    in-out property <bool> layout_leaf_presets_submenu_hover: false;
    in-out property <bool> show_layout_splitter_context_menu: false;
    in-out property <bool> layout_intro_dont_show_again: false;
    in-out property <string> layout_context_splitter_id: "";
    property <length> layout_leaf_context_menu_x: 0px;
    property <length> layout_leaf_context_menu_y: 0px;
    property <length> layout_splitter_context_menu_x: 0px;
    property <length> layout_splitter_context_menu_y: 0px;
    property <length> layout_exit_editor_button_width: 114px;
    property <length> layout_exit_editor_button_height: 24px;
    in-out property <length> layout_exit_editor_button_x: 0px;
    in-out property <length> layout_exit_editor_button_y: 8px;
    property <length> layout_exit_editor_drag_last_abs_x: 0px;
    property <length> layout_exit_editor_drag_last_abs_y: 0px;
    in-out property <bool> layout_exit_editor_dragging: false;
    property <int> panel_kind_none: 0;
    property <int> panel_kind_button_cluster: 1;
    property <int> panel_kind_transport_button_cluster: 2;
    property <int> panel_kind_utility_button_cluster: 3;
    property <int> panel_kind_volume_slider: 4;
    property <int> panel_kind_seek_bar: 5;
    property <int> panel_kind_playlist_switcher: 6;
    property <int> panel_kind_track_list: 7;
    property <int> panel_kind_metadata_viewer: 8;
    property <int> panel_kind_album_art_viewer: 9;
    property <int> panel_kind_spacer: 10;
    property <int> panel_kind_status_bar: 11;
    property <int> panel_kind_import_button_cluster: 12;
    property <int> panel_mode_both: 0;
    property <int> panel_mode_playlist_only: 1;
    property <int> panel_mode_library_only: 2;
    property <int> panel_preset_text_track_details: 101;
    property <int> panel_preset_text_album_description: 102;
    property <int> panel_preset_text_artist_bio: 103;
    property <int> panel_preset_image_album_art: 111;
    property <int> panel_preset_image_artist_image: 112;
    in-out property <[string]> layout_panel_options: [];
    in-out property <int> layout_editor_replace_panel_kind: root.panel_kind_none;
    in-out property <int> layout_editor_split_panel_kind: root.panel_kind_spacer;
    in-out property <int> layout_editor_new_root_panel_kind: root.panel_kind_track_list;
    in-out property <int> layout_editor_split_axis: 1;
    in-out property <[string]> layout_leaf_ids: [];
    in-out property <int> layout_selected_leaf_index: -1;
    in-out property <[int]> layout_region_panel_kinds: [];
    in-out property <[int]> layout_region_x_px: [];
    in-out property <[int]> layout_region_y_px: [];
    in-out property <[int]> layout_region_width_px: [];
    in-out property <[int]> layout_region_height_px: [];
    in-out property <[bool]> layout_region_visible: [];
    property <[string]> layout_panel_submenu_labels: [
        "Button Cluster",
        "Volume Slider",
        "Seek Bar",
        "Collection Panel",
        "Track List",
        "Text Panel",
        "Image Panel",
        "Status Bar"
    ];
    property <[int]> layout_panel_submenu_codes: [
        root.panel_kind_button_cluster,
        root.panel_kind_volume_slider,
        root.panel_kind_seek_bar,
        root.panel_kind_playlist_switcher,
        root.panel_kind_track_list,
        root.panel_kind_metadata_viewer,
        root.panel_kind_album_art_viewer,
        root.panel_kind_status_bar
    ];
    property <[string]> layout_replace_preset_labels: [
        "Button Cluster",
        "Import Controls",
        "Transport Controls",
        "Utility Controls",
        "Text Panel",
        "Track Details",
        "Album Description",
        "Artist Bio",
        "Image Panel",
        "Album Art",
        "Artist Image"
    ];
    property <[int]> layout_replace_preset_codes: [
        -1,
        root.panel_kind_import_button_cluster,
        root.panel_kind_transport_button_cluster,
        root.panel_kind_utility_button_cluster,
        -3,
        root.panel_preset_text_track_details,
        root.panel_preset_text_album_description,
        root.panel_preset_text_artist_bio,
        -5,
        root.panel_preset_image_album_art,
        root.panel_preset_image_artist_image
    ];
    in-out property <[LayoutSplitterModel]> layout_splitters: [];
    in-out property <int> layout_active_splitter_index: -1;
    property <length> layout_splitter_drag_start_mouse_x: 0px;
    property <length> layout_splitter_drag_start_mouse_y: 0px;
    in-out property <float> layout_splitter_drag_start_ratio: 0.5;

    pure function playlist-column-width(index: int) -> length {
        if index >= 0 && index < root.playlist_column_widths_px.length {
            return max(1px, root.playlist_column_widths_px[index] * 1px);
        }
        return 140px;
    }

    pure function playlist-column-divider-x(index: int) -> int {
        if index < 0 || index >= root.playlist_column_widths_px.length {
            return 0;
        }
        let gap_index = index + 1;
        if gap_index < 0 || gap_index >= root.playlist_column_gap_positions_px.length {
            return 0;
        }
        let gap_position = root.playlist_column_gap_positions_px[gap_index];
        return gap_index < root.playlist_column_widths_px.length ? gap_position - 10 : gap_position;
    }

    pure function layout-region-is-visible(region: int) -> bool {
        if region >= 0 && region < root.layout_region_visible.length {
            return root.layout_region_visible[region];
        }
        return false;
    }

    pure function layout-region-x(region: int) -> length {
        if region >= 0 && region < root.layout_region_x_px.length {
            return root.layout_region_x_px[region] * 1px;
        }
        return 0px;
    }

    pure function layout-region-y(region: int) -> length {
        if region >= 0 && region < root.layout_region_y_px.length {
            return root.layout_region_y_px[region] * 1px;
        }
        return 0px;
    }

    pure function layout-region-width(region: int) -> length {
        if region >= 0 && region < root.layout_region_width_px.length {
            return max(0px, root.layout_region_width_px[region] * 1px);
        }
        return 0px;
    }

    pure function layout-region-height(region: int) -> length {
        if region >= 0 && region < root.layout_region_height_px.length {
            return max(0px, root.layout_region_height_px[region] * 1px);
        }
        return 0px;
    }

    pure function layout-region-panel-kind(region: int) -> int {
        if region >= 0 && region < root.layout_region_panel_kinds.length {
            return root.layout_region_panel_kinds[region];
        }
        return root.panel_kind_none;
    }

    pure function layout-region-collection-mode(region: int) -> int {
        if region >= 0 && region < root.layout_region_collection_modes.length {
            return root.layout_region_collection_modes[region];
        }
        return root.panel_mode_both;
    }

    pure function layout-region-active-collection-mode(region: int) -> int {
        let panel-mode = root.layout-region-collection-mode(region);
        if panel-mode == root.panel_mode_playlist_only {
            return 0;
        }
        if panel-mode == root.panel_mode_library_only {
            return 1;
        }
        return root.collection_mode;
    }

    pure function layout-panel-label(panel-kind: int) -> string {
        if panel-kind == root.panel_kind_button_cluster {
            return "Button Cluster";
        }
        if panel-kind == root.panel_kind_transport_button_cluster {
            return "Transport Preset";
        }
        if panel-kind == root.panel_kind_utility_button_cluster {
            return "Utility Preset";
        }
        if panel-kind == root.panel_kind_volume_slider {
            return "Volume Slider";
        }
        if panel-kind == root.panel_kind_seek_bar {
            return "Seek Bar";
        }
        if panel-kind == root.panel_kind_playlist_switcher {
            return "Collection Panel";
        }
        if panel-kind == root.panel_kind_track_list {
            return "Track List";
        }
        if panel-kind == root.panel_kind_metadata_viewer {
            return "Text Panel";
        }
        if panel-kind == root.panel_kind_album_art_viewer {
            return "Image Panel";
        }
        if panel-kind == root.panel_kind_spacer {
            return "Spacer";
        }
        if panel-kind == root.panel_kind_status_bar {
            return "Status Bar";
        }
        return "None";
    }

    pure function layout-selected-panel-kind() -> int {
        if root.layout_selected_leaf_index >= 0
            && root.layout_selected_leaf_index < root.layout_region_panel_kinds.length {
            return root.layout_region_panel_kinds[root.layout_selected_leaf_index];
        }
        return root.panel_kind_none;
    }

    pure function layout-selected-panel-has-settings() -> bool {
        let panel-kind = root.layout-selected-panel-kind();
        return panel-kind == root.panel_kind_button_cluster
            || panel-kind == root.panel_kind_playlist_switcher
            || panel-kind == root.panel_kind_track_list
            || panel-kind == root.panel_kind_metadata_viewer
            || panel-kind == root.panel_kind_album_art_viewer;
    }

    pure function control-action-label(action-id: int) -> string {
        if action-id == 1 { return "Import (+)"; }
        if action-id == 2 { return "Back"; }
        if action-id == 3 { return "Play"; }
        if action-id == 4 { return "Pause"; }
        if action-id == 5 { return "Stop"; }
        if action-id == 6 { return "Next"; }
        if action-id == 7 { return "Shuffle"; }
        if action-id == 8 { return "Repeat"; }
        if action-id == 9 { return "Layout Editor"; }
        if action-id == 10 { return "Settings"; }
        if action-id == 11 { return "Cast"; }
        if action-id == 12 { return "Favorite"; }
        return "Unknown";
    }

    pure function control-cluster-label() -> string {
        return "Button Cluster";
    }

    changed width => {
        root.layout_exit_editor_button_x = min(
            max(0px, root.layout_exit_editor_button_x),
            max(0px, root.width - root.layout_exit_editor_button_width)
        );
        root.window_resized(max(0, floor(self.width / 1px)), max(0, floor(self.height / 1px)));
    }
    changed height => {
        root.layout_exit_editor_button_y = min(
            max(0px, root.layout_exit_editor_button_y),
            max(0px, root.height - root.layout_exit_editor_button_height)
        );
        root.window_resized(max(0, floor(self.width / 1px)), max(0, floor(self.height / 1px)));
    }

    // Status display at the bottom showing the currently playing track
    in-out property <string> status-text: "";
    in-out property <string> status-selection-summary: "";

    VerticalLayout {
        layout-workspace := Rectangle {
            vertical-stretch: 1;
            background: root.theme_window_bg;
            clip: true;
            changed width => {
                root.layout_workspace_resized(max(0, floor(self.width / 1px)), max(0, floor(self.height / 1px)));
            }
            changed height => {
                root.layout_workspace_resized(max(0, floor(self.width / 1px)), max(0, floor(self.height / 1px)));
            }

            for leaf-id[i] in root.layout_leaf_ids : Rectangle {
                x: root.layout-region-x(i);
                y: root.layout-region-y(i);
                width: root.layout-region-width(i);
                height: root.layout-region-height(i);
                visible: root.layout-region-is-visible(i)
                    && root.layout-region-panel-kind(i) == root.panel_kind_spacer;
                background: root.layout_edit_mode ? AppPalette.panel-bg-alt : AppPalette.panel-bg;
                border-width: root.layout_edit_mode ? 1px : 0px;
                border-color: root.theme_border;
                if root.layout_edit_mode : Text {
                    text: "Spacer";
                    color: root.theme_text_muted;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            for cluster-panel in root.layout_button_cluster_panels : Rectangle {
                x: cluster-panel.x_px * 1px;
                y: cluster-panel.y_px * 1px;
                width: cluster-panel.width_px * 1px;
                height: cluster-panel.height_px * 1px;
                visible: cluster-panel.visible;
                clip: true;
                background: root.theme_surface_bg;
                property <length> content-height: min(32px, parent.height);
                HorizontalLayout {
                    x: 0px;
                    y: (parent.height - self.height) / 2;
                    width: parent.width;
                    height: parent.content-height;
                    padding-left: 8px;
                    padding-right: 8px;
                    alignment: center;
                    dynamic-cluster := ButtonCluster {
                        cluster-leaf-id: cluster-panel.leaf_id;
                        button-actions: cluster-panel.actions;
                        playback-order-index: root.playback_order_index;
                        repeat-mode: root.repeat_mode;
                        cast-connected: root.cast_connected;
                        cast-connecting: root.cast_connecting;
                        collection-mode: root.collection_mode;
                        layout-edit-mode: root.layout_edit_mode;
                        has-current-track-context: root.has_current_track_context;
                        now-playing-favorited: root.now_playing_favorited;
                        action-invoked(action-id) => {
                            if (action-id == 1 && root.collection_mode == 0) {
                                root.show_settings_menu = false;
                                root.show_library_folder_menu = false;
                                root.show_import_menu = true;
                                root.import_menu_x = min(
                                    root.width - root.import_menu_width,
                                    max(8px, cluster-panel.x_px * 1px + 8px)
                                );
                                root.import_menu_y = min(
                                    root.height - root.import_menu_height,
                                    max(8px, cluster-panel.y_px * 1px + cluster-panel.height_px * 1px + 4px)
                                );
                            }
                            if (action-id == 2) { root.previous(); }
                            if (action-id == 3) { root.play(); }
                            if (action-id == 4) { root.pause(); }
                            if (action-id == 5) { root.stop(); }
                            if (action-id == 6) { root.next(); }
                            if (action-id == 7) {
                                let next-order = root.playback_order_index == 0 ? 1 : root.playback_order_index == 1 ? 2 : 0;
                                root.playback_order_index = next-order;
                                root.playback_order_changed(next-order);
                            }
                            if (action-id == 8) { root.toggle_repeat(); }
                            if (action-id == 9) { root.open_layout_editor(); }
                            if (action-id == 10) {
                                root.show_import_menu = false;
                                root.show_library_folder_menu = false;
                                root.show_cast_menu = false;
                                root.show_settings_menu = true;
                                root.settings_menu_x = min(root.width - 220px, max(8px, cluster-panel.x_px * 1px + 8px));
                                root.settings_menu_y = min(
                                    root.height - 120px,
                                    max(8px, cluster-panel.y_px * 1px + cluster-panel.height_px * 1px + 4px)
                                );
                            }
                            if (action-id == 11) {
                                root.show_settings_menu = false;
                                root.show_import_menu = false;
                                root.show_library_folder_menu = false;
                                root.show_cast_menu = true;
                                root.cast_menu_x = min(root.width - 300px, max(8px, cluster-panel.x_px * 1px + 8px));
                                root.cast_menu_y = min(
                                    root.height - 260px,
                                    max(8px, cluster-panel.y_px * 1px + cluster-panel.height_px * 1px + 4px)
                                );
                                root.cast_refresh_devices();
                            }
                            if (action-id == 12) {
                                root.toggle_favorite_now_playing();
                            }
                        }
                        request-add-menu(cluster-leaf-id) => {
                            root.open_control_cluster_menu_for_leaf(
                                cluster-leaf-id,
                                max(8, cluster-panel.x_px + 8),
                                max(8, cluster-panel.y_px + cluster-panel.height_px + 4)
                            );
                        }
                        tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                            root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                        }
                    }
                }
            }

            for leaf-id[i] in root.layout_leaf_ids : Rectangle {
                x: root.layout-region-x(i);
                y: root.layout-region-y(i);
                width: root.layout-region-width(i);
                height: root.layout-region-height(i);
                visible: root.layout-region-is-visible(i)
                    && root.layout-region-panel-kind(i) == root.panel_kind_volume_slider;
                clip: true;
                background: root.theme_surface_bg;
                property <length> content-height: min(24px, parent.height);
                VolumeSliderControl {
                    x: 8px;
                    y: (parent.height - self.height) / 2;
                    height: parent.content-height;
                    width: max(0px, parent.width - 16px);
                    value <=> root.volume-level;
                    changed(next-volume) => { root.volume-changed(next-volume); }
                }
            }

            for leaf-id[i] in root.layout_leaf_ids : Rectangle {
                x: root.layout-region-x(i);
                y: root.layout-region-y(i);
                width: root.layout-region-width(i);
                height: root.layout-region-height(i);
                visible: root.layout-region-is-visible(i)
                    && root.layout-region-panel-kind(i) == root.panel_kind_seek_bar;
                clip: true;
                background: root.theme_surface_bg;
                property <length> content-height: min(30px, parent.height);
                property <length> horizontal-inset: min(16px, max(8px, self.width / 24));
                property <length> content-width: max(0px, self.width - self.horizontal-inset * 2);
                SeekBarControl {
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    width: parent.content-width;
                    height: parent.content-height;
                    position-percentage: root.position-percentage;
                    elapsed-text: root.format-time(root.elapsed-ms);
                    total-text: root.format-time(root.total-ms);
                    panel-bg: AppPalette.panel-bg;
                    text-muted: AppPalette.text-muted;
                    track-bg: AppPalette.separator;
                    progress-bg: AppPalette.accent;
                    handle-bg: AppPalette.text-primary;
                    handle-border: AppPalette.border;
                    handle-shadow: AppPalette.overlay-scrim;
                    seek-requested(next-pos) => { root.seek-to(next-pos); }
                }
            }

            for leaf-id[i] in root.layout_leaf_ids : collection-switcher-panel := Rectangle {
                x: root.layout-region-x(i);
                y: root.layout-region-y(i);
                width: root.layout-region-width(i);
                height: root.layout-region-height(i);
                visible: root.layout-region-is-visible(i)
                    && root.layout-region-panel-kind(i) == root.panel_kind_playlist_switcher;
                clip: true;
                background: root.theme_surface_bg;
                property <int> panel-mode: root.layout-region-collection-mode(i);
                property <int> active-mode: root.layout-region-active-collection-mode(i);
                VerticalLayout {
                    padding: 8px;
                    spacing: 6px;

                    if collection-switcher-panel.panel-mode == root.panel_mode_both : ModeTabs {
                        labels: ["Playlists", "Library"];
                        selected_index: root.collection_mode;
                        selected(index) => { root.switch_collection_mode(index); }
                    }

                    if collection-switcher-panel.active-mode == 0 : VerticalLayout {
                        spacing: 4px;
                        HorizontalLayout {
                            Text {
                                text: "Playlists";
                                color: root.theme_text_muted;
                                font-size: 12px;
                                font-weight: 700;
                                vertical-alignment: center;
                            }
                            Rectangle { horizontal-stretch: 1; }
                            playlist-switcher-import-button := PlayerButton {
                                icon-source: AppIcons.plus;
                                icon-text: "";
                                font-size: 18px;
                                tooltip-text: "Import tracks or folders";
                                tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                    root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                }
                                clicked => {
                                    root.show_settings_menu = false;
                                    root.show_library_folder_menu = false;
                                    root.show_import_menu = true;
                                    root.import_menu_x = min(
                                        root.width - root.import_menu_width,
                                        max(8px, playlist-switcher-import-button.absolute-position.x)
                                    );
                                    root.import_menu_y = min(
                                        root.height - root.import_menu_height,
                                        max(
                                            8px,
                                            playlist-switcher-import-button.absolute-position.y
                                                + playlist-switcher-import-button.height
                                                + 4px
                                        )
                                    );
                                }
                            }
                        }

                        Rectangle { height: 1px; background: root.theme_separator; }
                        ScrollView {
                            vertical-stretch: 1;
                            VerticalLayout {
                                alignment: start;
                                for p[i] in root.playlists : PlaylistRow {
                                    name: p.text;
                                    is-active: root.active_playlist_index == i;
                                    is-editing: root.editing_playlist_index == i;
                                    is-remote: i < root.playlist_is_remote.length && root.playlist_is_remote[i];
                                    is-new-playlist-edit: root.new_playlist_edit_index == i;
                                    can-sync-opensubsonic: i < root.playlist_can_sync_opensubsonic.length
                                        && root.playlist_can_sync_opensubsonic[i];
                                    clicked => {
                                        root.switch_playlist(i);
                                        root.editing_playlist_index = -1;
                                        root.new_playlist_edit_index = -1;
                                        root.sidebar_has_focus = true;
                                        root.refocus_main();
                                    }
                                    renamed(new-name) => {
                                        root.rename_playlist(i, new-name);
                                        root.editing_playlist_index = -1;
                                        root.new_playlist_edit_index = -1;
                                        root.refocus_main();
                                    }
                                    cancel-edit() => {
                                        root.editing_playlist_index = -1;
                                        root.new_playlist_edit_index = -1;
                                        root.refocus_main();
                                    }
                                    context-menu-rename() => {
                                        root.editing_playlist_index = i;
                                        root.new_playlist_edit_index = -1;
                                    }
                                    context-menu-delete() => {
                                        root.new_playlist_edit_index = -1;
                                        root.confirm_delete_playlist(i);
                                    }
                                    context-menu-sync() => {
                                        root.new_playlist_edit_index = -1;
                                        root.sync_playlist_to_opensubsonic(i);
                                    }
                                }
                            }
                        }
                    }

                    if collection-switcher-panel.active-mode == 1 : VerticalLayout {
                        spacing: 6px;

                        HorizontalLayout {
                            Text {
                                text: "Library";
                                color: root.theme_text_primary;
                                font-size: 12px;
                                font-weight: 700;
                                vertical-alignment: center;
                                horizontal-stretch: 1;
                            }
                            PlayerButton {
                                icon-source: AppIcons.search;
                                icon-text: "";
                                font-size: 14px;
                                tooltip-text: "Search entire library";
                                tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                    root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                }
                                clicked => { root.open_global_library_search(); }
                            }
                            library-switcher-folder-button := PlayerButton {
                                icon-source: AppIcons.folder;
                                icon-text: "";
                                font-size: 18px;
                                tooltip-text: "Library folder options";
                                tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                    root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                }
                                clicked => {
                                    root.show_settings_menu = false;
                                    root.show_import_menu = false;
                                    root.show_library_folder_menu = true;
                                    root.library_folder_menu_x = min(
                                        root.width - root.library_folder_menu_width,
                                        max(8px, library-switcher-folder-button.absolute-position.x)
                                    );
                                    root.library_folder_menu_y = min(
                                        root.height - root.library_folder_menu_height,
                                        max(
                                            8px,
                                            library-switcher-folder-button.absolute-position.y
                                                + library-switcher-folder-button.height
                                                + 4px
                                        )
                                    );
                                }
                            }
                            PlayerButton {
                                icon-source: AppIcons.refresh;
                                icon-text: "";
                                font-size: 14px;
                                tooltip-text: "Rescan library folders";
                                tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                    root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                }
                                clicked => { root.library_rescan(); }
                            }
                        }

                        VerticalLayout {
                            spacing: 2px;
                            for root-label[index] in ["Tracks", "Artists", "Albums", "Genres", "Decades", "Favorites"] : Rectangle {
                                property <int> root-count: index < root.library_root_counts.length ? root.library_root_counts[index] : 0;
                                height: 24px;
                                border-radius: 2px;
                                background: root.library_root_index == index
                                    ? AppPalette.selection-bg
                                    : library-root-ta.has-hover
                                        ? AppPalette.control-hover-bg
                                        : transparent;

                                HorizontalLayout {
                                    x: 8px;
                                    width: parent.width - 16px;
                                    spacing: 8px;

                                    Text {
                                        text: root-label;
                                        color: root.library_root_index == index
                                            ? root.theme_text_primary
                                            : root.theme_text_secondary;
                                        font-size: 13px;
                                        vertical-alignment: center;
                                        horizontal-alignment: left;
                                        horizontal-stretch: 1;
                                    }

                                    Text {
                                        text: root-count + "";
                                        color: root.library_root_index == index
                                            ? AppPalette.text-secondary
                                            : AppPalette.text-muted;
                                        font-size: 12px;
                                        vertical-alignment: center;
                                        horizontal-alignment: right;
                                    }
                                }

                                library-root-ta := TouchArea {
                                    clicked => { root.library_select_root(index); }
                                }
                            }
                        }

                        Rectangle { height: 1px; background: root.theme_separator; }

                        if root.library_scan_in_progress : Text {
                            text: "Scanning library...";
                            color: AppPalette.text-secondary;
                            font-size: 11px;
                            height: 16px;
                            overflow: elide;
                        }
                    }
                }

            }

            for panel in root.layout_metadata_viewer_panels : Rectangle {
                x: panel.x_px * 1px;
                y: panel.y_px * 1px;
                width: panel.width_px * 1px;
                height: panel.height_px * 1px;
                visible: panel.visible;
                clip: true;
                background: root.theme_surface_bg;
                property <length> content-inset: panel.width_px < 180 || panel.height_px < 120
                    ? 4px
                    : 10px;
                TextPanel {
                    x: parent.content-inset;
                    y: parent.content-inset;
                    width: max(0px, parent.width - parent.content-inset * 2);
                    height: max(0px, parent.height - parent.content-inset * 2);
                    text-primary: AppPalette.text-primary;
                    text-secondary: AppPalette.text-secondary;
                    text-muted: AppPalette.text-muted;
                    text-disabled: AppPalette.text-disabled;
                    display-text: panel.display_text;
                    tooltip-text: panel.display_text_full;
                    tooltip-enabled: panel.display_text_elided;
                    empty-state-text: panel.display_priority == 4
                        ? "No track playing"
                        : "No track selected";
                    tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                        root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                    }
                    metadata_link_activated(kind, value, album, album_artist, track_path) => {
                        root.activate_metadata_link(
                            kind,
                            value,
                            album,
                            album_artist,
                            track_path,
                            true
                        );
                    }
                }
            }

            for panel in root.layout_album_art_viewer_panels : Rectangle {
                x: panel.x_px * 1px;
                y: panel.y_px * 1px;
                width: panel.width_px * 1px;
                height: panel.height_px * 1px;
                visible: panel.visible;
                clip: true;
                background: root.theme_surface_bg;
                property <length> content-inset: panel.width_px < 180 || panel.height_px < 120
                    ? 4px
                    : 10px;
                ImagePanel {
                    x: parent.content-inset;
                    y: parent.content-inset;
                    width: max(0px, parent.width - parent.content-inset * 2);
                    height: max(0px, parent.height - parent.content-inset * 2);
                    panel-bg: AppPalette.panel-bg-alt;
                    frame-border: AppPalette.border;
                    frame-bg: AppPalette.panel-bg-elevated;
                    frame-inner-border: AppPalette.separator;
                    frame-inner-bg: AppPalette.panel-bg-alt;
                    placeholder-icon: AppPalette.text-muted;
                    placeholder-text: AppPalette.text-disabled;
                    art-source: panel.art_source;
                    has-art: panel.has_art;
                }
            }

            for leaf-id[i] in root.layout_leaf_ids : track-list-panel := Rectangle {
                x: root.layout-region-x(i);
                y: root.layout-region-y(i);
                width: root.layout-region-width(i);
                height: root.layout-region-height(i);
                visible: root.layout-region-is-visible(i)
                    && root.layout-region-panel-kind(i) == root.panel_kind_track_list;
                clip: true;
                background: root.theme_window_bg;
                property <int> active-mode: root.layout-region-active-collection-mode(i);

                if track-list-panel.active-mode == 0 : VerticalLayout {
                    Rectangle {
                        height: 28px;
                        clip: true;
                        background: root.theme_surface_bg;
                        property <length> columns-band-width: max(0px, track-list.visible-width - root.playlist-fixed-chrome-width);
                        property <int> columns-band-width-px: max(0, floor(self.columns-band-width / 1px));
                        changed columns-band-width-px => {
                            if !(root.layout-region-is-visible(i)
                                    && root.layout-region-panel-kind(i) == root.panel_kind_track_list) {
                                return;
                            }
                            if self.columns-band-width-px != root.playlist_columns_available_width_px {
                                root.playlist_columns_available_width_px = self.columns-band-width-px;
                                root.playlist_columns_viewport_resized(self.columns-band-width-px);
                            }
                        }
                        HorizontalLayout {
                            x: track-list.viewport-x;
                            width: max(track-list.visible-width, root.playlist-content-width);
                            height: parent.height;
                            padding-left: root.playlist-row-padding-x;
                            padding-right: root.playlist-row-padding-x;
                            spacing: root.playlist-column-spacing;
                            Rectangle {
                                width: root.playlist-status-lane-width;
                                Image {
                                    source: AppIcons.player-play;
                                    width: 11px;
                                    height: 11px;
                                    x: (parent.width - self.width) / 2;
                                    y: (parent.height - self.height) / 2;
                                    image-fit: contain;
                                    colorize: root.theme_text_muted;
                                }
                            }
                            for column-header[i] in root.playlist_visible_column_headers : Rectangle {
                                property <bool> is-drag-source: root.column_drag_from == i;
                                property <bool> is-resize-target: root.column_resize_active && root.column_resize_index == i;
                                property <int> sort-state: i < root.playlist_column_sort_states.length ? root.playlist_column_sort_states[i] : 0;
                                property <bool> is-favorite-column: i < root.playlist_visible_column_kinds.length
                                    && root.playlist_visible_column_kinds[i] == 2;
                                property <color> header-color: (self.is-drag-source || self.is-resize-target || self.sort-state != 0)
                                    ? AppPalette.accent
                                    : root.theme_text_muted;
                                width: root.playlist-column-width(i);
                                border-radius: 2px;
                                background: self.is-drag-source || self.is-resize-target || self.sort-state != 0
                                    ? AppPalette.selection-bg
                                    : transparent;
                                border-width: (self.is-drag-source || self.is-resize-target) ? 1px : 0px;
                                border-color: AppPalette.selection-border;
                                if !(i < root.playlist_visible_column_kinds.length
                                        && root.playlist_visible_column_kinds[i] == 2) : Text {
                                    text: parent.sort-state == 1 ? column-header + " ▲"
                                        : parent.sort-state == 2 ? column-header + " ▼"
                                        : column-header;
                                    color: parent.header-color;
                                    font-size: 12px;
                                    x: 0px;
                                    width: parent.width;
                                    vertical-alignment: center;
                                    horizontal-alignment: left;
                                    overflow: elide;
                                }
                                if i < root.playlist_visible_column_kinds.length
                                        && root.playlist_visible_column_kinds[i] == 2 : Image {
                                    source: AppIcons.heart-filled;
                                    width: 12px;
                                    height: 12px;
                                    x: (parent.width - self.width) / 2;
                                    y: (parent.height - self.height) / 2;
                                    image-fit: contain;
                                    colorize: parent.header-color;
                                }
                                Rectangle {
                                    x: parent.width - 1px;
                                    y: 4px;
                                    width: 1px;
                                    height: parent.height - 8px;
                                    background: (root.column_resize_active && root.column_resize_index == i)
                                        || (!root.column_resize_active && root.column_hover_divider == i)
                                        ? AppPalette.accent
                                        : root.theme_border;
                                }
                            }
                            Rectangle { horizontal-stretch: 1; }
                            Rectangle {
                                width: root.null-column-width;
                                background: root.theme_surface_bg;
                            }
                        }

                        column-header-drag-ta := TouchArea {
                            x: root.playlist-columns-band-offset-x + track-list.viewport-x;
                            y: 0px;
                            width: root.playlist_columns_content_width_px > 0
                                ? min(self.max-drag-width, root.playlist_columns_content_width_px * 1px)
                                : self.max-drag-width;
                            height: parent.height;
                            property <length> max-drag-width: max(0px, track-list.visible-width - root.playlist-fixed-chrome-width);
                            property <int> visible_column_count: root.playlist_visible_column_headers.length;
                            property <int> content-mouse-x-px: floor(self.mouse-x / 1px);
                            mouse-cursor: (root.column_resize_active || root.column_hover_divider != -1) ? col-resize : default;
                            pointer-event(event) => {
                                if (event.button == PointerEventButton.right && event.kind == PointerEventKind.down) {
                                    let click-x = root.layout-region-x(i) + parent.x + self.x + self.mouse-x;
                                    let click-y = root.layout-region-y(i) + parent.y + self.y + self.mouse-y;
                                    let menu-height = 16px + root.playlist_column_menu_labels.length * 24px + 32px;
                                    root.column-menu-x = min(root.width - 220px, max(8px, click-x));
                                    root.column-menu-y = min(root.height - menu-height, max(8px, click-y));
                                    column-header-menu.show();
                                } else if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                                    let hovered_divider = visible_column_count > 0
                                        && self.mouse-x >= 0px && self.mouse-x < self.width
                                        ? root.playlist_header_divider_at(self.content-mouse-x-px)
                                        : -1;
                                    root.column_hover_divider = hovered_divider;
                                    let hovered_column = visible_column_count > 0
                                        && self.mouse-x >= 0px && self.mouse-x < self.width
                                        ? root.playlist_header_column_at(self.content-mouse-x-px)
                                        : -1;
                                    let hovered_gap = visible_column_count > 0
                                        && self.mouse-x >= 0px && self.mouse-x < self.width
                                        ? root.playlist_header_gap_at(self.content-mouse-x-px)
                                        : -1;
                                    if (hovered_divider != -1 && hovered_divider < root.playlist_column_widths_px.length) {
                                        root.column_resize_index = hovered_divider;
                                        root.column_resize_active = true;
                                        root.column_resize_start_width_px = root.playlist_column_widths_px[hovered_divider];
                                        root.column_resize_preview_width_px = root.column_resize_start_width_px;
                                        root.column_resize_min_width_px = root.playlist_header_column_min_width(hovered_divider);
                                        root.column_resize_max_width_px = root.playlist_header_column_max_width(hovered_divider);
                                        root.column_resize_start_mouse_x = self.mouse-x;
                                        root.column_drag_from = -1;
                                        root.column_drop_gap = -1;
                                        root.column_click_candidate = -1;
                                        root.column_drag_moved = false;
                                    } else if (hovered_column != -1) {
                                        root.column_drag_from = hovered_column;
                                        root.column_drop_gap = hovered_gap;
                                        root.column_click_candidate = hovered_column;
                                        root.column_click_start_x = self.mouse-x;
                                        root.column_drag_moved = false;
                                    }
                                } else if (event.kind == PointerEventKind.move) {
                                    let hovered_divider = visible_column_count > 0
                                        && self.mouse-x >= 0px && self.mouse-x < self.width
                                        ? root.playlist_header_divider_at(self.content-mouse-x-px)
                                        : -1;
                                    root.column_hover_divider = hovered_divider;
                                    if (root.column_resize_active && root.column_resize_index != -1) {
                                        let delta_px = floor((self.mouse-x - root.column_resize_start_mouse_x) / 1px);
                                        let min_width_px = max(1, root.column_resize_min_width_px);
                                        let max_width_px = max(min_width_px, root.column_resize_max_width_px);
                                        let new_width_px = min(max_width_px, max(min_width_px, root.column_resize_start_width_px + delta_px));
                                        root.column_resize_preview_width_px = new_width_px;
                                        root.preview_playlist_column_width(root.column_resize_index, new_width_px);
                                    } else {
                                        let hovered_gap = visible_column_count > 0
                                            && self.mouse-x >= 0px && self.mouse-x < self.width
                                            ? root.playlist_header_gap_at(self.content-mouse-x-px)
                                            : -1;
                                        if (root.column_click_candidate != -1 && abs(self.mouse-x - root.column_click_start_x) > 4px) {
                                            root.column_click_candidate = -1;
                                            root.column_drag_moved = true;
                                        }
                                        if (root.column_drag_from != -1 && hovered_gap != -1) {
                                            root.column_drop_gap = hovered_gap;
                                        }
                                    }
                                } else if (event.kind == PointerEventKind.up) {
                                    let hovered_column = visible_column_count > 0
                                        && self.mouse-x >= 0px && self.mouse-x < self.width
                                        ? root.playlist_header_column_at(self.content-mouse-x-px)
                                        : -1;
                                    if (root.column_resize_active && root.column_resize_index != -1) {
                                        let new_width_px = root.column_resize_preview_width_px;
                                        root.commit_playlist_column_width(root.column_resize_index, new_width_px);
                                        root.column_resize_active = false;
                                        root.column_resize_index = -1;
                                        root.column_hover_divider = -1;
                                    } else if (root.column_drag_from != -1) {
                                        let hovered_gap = visible_column_count > 0
                                            && self.mouse-x >= 0px && self.mouse-x < self.width
                                            ? root.playlist_header_gap_at(self.content-mouse-x-px)
                                            : -1;
                                        let final_gap = hovered_gap != -1 ? hovered_gap : root.column_drop_gap;
                                        let final_drop_index = final_gap <= root.column_drag_from ? final_gap : final_gap - 1;
                                        if (final_drop_index != -1 && root.column_drag_from != final_drop_index) {
                                            root.reorder_playlist_columns(root.column_drag_from, final_drop_index);
                                        }
                                    }
                                    if (!root.column_resize_active
                                            && !root.column_drag_moved
                                            && root.column_click_candidate != -1
                                            && hovered_column == root.column_click_candidate) {
                                        root.cycle_playlist_sort_by_column(root.column_click_candidate);
                                    }
                                    root.column_drag_from = -1;
                                    root.column_drop_gap = -1;
                                    root.column_click_candidate = -1;
                                    root.column_drag_moved = false;
                                } else if (event.kind == PointerEventKind.cancel) {
                                    if (root.column_resize_active && root.column_resize_index != -1) {
                                        root.preview_playlist_column_width(root.column_resize_index, root.column_resize_start_width_px);
                                        root.column_resize_active = false;
                                        root.column_resize_index = -1;
                                        root.column_resize_preview_width_px = root.column_resize_start_width_px;
                                    }
                                    root.column_drag_from = -1;
                                    root.column_drop_gap = -1;
                                    root.column_hover_divider = -1;
                                    root.column_click_candidate = -1;
                                    root.column_drag_moved = false;
                                }
                            }

                            double-clicked => {
                                if (visible_column_count > 0 && self.mouse-x >= 0px && self.mouse-x < self.width) {
                                    let hovered_divider = root.playlist_header_divider_at(self.content-mouse-x-px);
                                    if (hovered_divider != -1) {
                                        root.column_resize_active = false;
                                        root.column_resize_index = -1;
                                        root.column_hover_divider = -1;
                                        root.reset_playlist_column_width(hovered_divider);
                                    }
                                }
                            }
                        }

                        if root.column_drag_from != -1
                                && root.column_drop_gap != -1
                                && column-header-drag-ta.visible_column_count > 0
                                && root.column_drop_gap < root.playlist_column_gap_positions_px.length : Rectangle {
                            x: column-header-drag-ta.x
                                + root.playlist_column_gap_positions_px[root.column_drop_gap] * 1px - 1px;
                            y: 3px;
                            width: 2px;
                            height: parent.height - 6px;
                            border-radius: 1px;
                            background: AppPalette.accent;
                        }

                        if root.column_resize_active
                                && root.column_resize_index >= 0
                                && root.column_resize_index < root.playlist_column_widths_px.length : Rectangle {
                            x: column-header-drag-ta.x
                                + root.playlist-column-divider-x(root.column_resize_index) * 1px - 1px;
                            y: 3px;
                            width: 2px;
                            height: parent.height - 6px;
                            border-radius: 1px;
                            background: AppPalette.accent;
                        }

                    }

                    track-list-container := Rectangle {
                        clip: true;
                        property <length> stack-base-y: 6px;
                        property <length> stack-gap-y: 6px;
                        property <int> first-visible-row: max(
                            0,
                            floor(max(0px, -track-list.viewport-y) / track-list.row-height)
                        );
                        property <int> visible-row-count: max(
                            1,
                            floor(track-list.height / track-list.row-height)
                        );
                        property <bool> has-partial-bottom-row: ceil(track-list.height / track-list.row-height)
                            > floor(track-list.height / track-list.row-height);
                        property <bool> last-track-partially-visible-at-bottom: self.has-playing-row
                            && self.has-partial-bottom-row
                            && root.playing_track_index == root.track_model.length - 1
                            && root.playing_track_index == self.first-visible-row + self.visible-row-count;
                        property <bool> has-playing-row: root.playing_track_index >= 0
                            && root.playing_track_index < root.track_model.length;
                        property <bool> playing-above-viewport: self.has-playing-row
                            && root.playing_track_index < self.first-visible-row;
                        property <bool> playing-below-viewport: self.has-playing-row
                            && root.playing_track_index >= self.first-visible-row + self.visible-row-count
                            && !self.last-track-partially-visible-at-bottom;
                        property <bool> show-scroll-to-playing-toast: self.playing-above-viewport
                            || self.playing-below-viewport;
                        property <length> scroll-toast-y: self.stack-base-y
                            + (root.playlist_filter_active ? (26px + self.stack-gap-y) : 0px)
                            + (root.playlist_search_visible ? (30px + self.stack-gap-y) : 0px);
                        changed visible-row-count => {
                            root.playlist-visible-row-count = self.visible-row-count;
                        }

                        if root.playlist_filter_active : Rectangle {
                            x: max(8px, parent.width - self.width - 8px);
                            y: track-list-container.stack-base-y;
                            width: 156px;
                            height: 26px;
                            border-radius: 4px;
                            background: root.playlist_filter_blocked_feedback
                                ? AppPalette.warning.mix(AppPalette.panel-bg, 0.78)
                                : AppPalette.accent-soft-bg;
                            border-width: 1px;
                            border-color: root.playlist_filter_blocked_feedback ? AppPalette.warning : AppPalette.accent-soft-border;
                            z: 6;
                            animate background { duration: 120ms; }
                            animate border-color { duration: 120ms; }

                            Text {
                                x: 8px;
                                width: 90px;
                                height: parent.height;
                                text: "Read only view";
                                color: root.playlist_filter_blocked_feedback ? AppPalette.warning : AppPalette.text-primary;
                                font-size: 11px;
                                vertical-alignment: center;
                                horizontal-alignment: left;
                                animate color { duration: 120ms; }
                            }

                            save-view-button := Rectangle {
                                x: parent.width - 38px;
                                y: (parent.height - self.height) / 2;
                                width: 16px;
                                height: 16px;
                                border-radius: 2px;
                                background: save-view-ta.has-hover ? AppPalette.control-pressed-bg : AppPalette.control-hover-bg;
                                border-width: 1px;
                                border-color: AppPalette.accent-soft-border;
                                Image {
                                    source: AppIcons.pencil-down;
                                    width: 12px;
                                    height: 12px;
                                    x: (parent.width - self.width) / 2;
                                    y: (parent.height - self.height) / 2;
                                    image-fit: contain;
                                    colorize: AppPalette.text-primary;
                                }
                                save-view-ta := TouchArea {
                                    clicked => {
                                        root.confirm_apply_filter_view();
                                    }
                                }
                            }

                            clear-view-button := Rectangle {
                                x: parent.width - 18px;
                                y: (parent.height - self.height) / 2;
                                width: 16px;
                                height: 16px;
                                border-radius: 2px;
                                background: clear-view-ta.has-hover ? AppPalette.control-pressed-bg : AppPalette.control-hover-bg;
                                border-width: 1px;
                                border-color: AppPalette.accent-soft-border;
                                Image {
                                    source: AppIcons.close;
                                    width: 10px;
                                    height: 10px;
                                    x: (parent.width - self.width) / 2;
                                    y: (parent.height - self.height) / 2;
                                    image-fit: contain;
                                    colorize: AppPalette.text-primary;
                                }
                                clear-view-ta := TouchArea {
                                    clicked => {
                                        root.clear_playlist_filter_view();
                                        root.refocus_main();
                                    }
                                }
                            }
                        }

                        if root.playlist_search_visible : Rectangle {
                            x: max(8px, parent.width - self.width - 8px);
                            y: track-list-container.stack-base-y
                                + (root.playlist_filter_active ? (26px + track-list-container.stack-gap-y) : 0px);
                            width: 320px;
                            height: 30px;
                            border-radius: 4px;
                            background: AppPalette.panel-bg-elevated;
                            border-width: 1px;
                            border-color: AppPalette.border;
                            z: 6;

                            HorizontalLayout {
                                spacing: 6px;
                                padding-left: 8px;
                                padding-right: 6px;

                                LineEdit {
                                    text <=> root.playlist_search_query;
                                    placeholder-text: "Search tracks...";
                                    horizontal-stretch: 1;
                                    init => { self.focus(); }
                                    edited => {
                                        root.set_playlist_search_query(self.text);
                                    }
                                }
                                Text {
                                    text: root.playlist_search_result_text;
                                    color: AppPalette.text-muted;
                                    font-size: 11px;
                                    width: 54px;
                                    horizontal-alignment: right;
                                    vertical-alignment: center;
                                }

                                PlayerButton {
                                    icon-source: AppIcons.close;
                                    icon-text: "";
                                    font-size: 12px;
                                    tooltip-text: "Close playlist search";
                                    tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                        root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                    }
                                    clicked => {
                                        root.close_playlist_search();
                                        root.refocus_main();
                                    }
                                }
                            }
                        }

                        if track-list-container.show-scroll-to-playing-toast : Rectangle {
                            x: max(8px, parent.width - self.width - 8px);
                            y: track-list-container.scroll-toast-y;
                            width: max(146px, min(parent.width - 16px, playlist-scroll-toast-text.preferred-width + 24px));
                            height: 26px;
                            border-radius: 4px;
                            border-width: 1px;
                            border-color: AppPalette.accent-soft-border;
                            background: AppPalette.accent-soft-bg;
                            z: 6;

                            playlist-scroll-toast-text := Text {
                                text: (track-list-container.playing-above-viewport ? "▲ " : "▼ ") + "Scroll to playing";
                                color: AppPalette.text-primary;
                                font-size: 11px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                                overflow: elide;
                            }

                            playlist-scroll-toast-ta := TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    if (track-list-container.has-playing-row) {
                                        let max-first-row = max(
                                            0,
                                            root.track_model.length - track-list-container.visible-row-count
                                        );
                                        let centered-first-row = min(
                                            max-first-row,
                                            max(
                                                0,
                                                root.playing_track_index
                                                    - floor(track-list-container.visible-row-count / 2)
                                            )
                                        );
                                        track-list.viewport-y = 0px - centered-first-row * track-list.row-height;
                                    }
                                }
                            }
                        }

                        track-list := ListView {
                            y: 0px;
                            height: parent.height;
                            property <length> row-height: max(30px, root.playlist_row_height_px * 1px);
                            property <length> header-height: 28px;
                            property <int> center-token: root.playlist_scroll_center_token;
                            changed viewport-y => {
                                let scroll-offset-y = max(0px, -self.viewport-y);
                                let first-row = max(0, floor(scroll-offset-y / self.row-height));
                                let visible-rows = max(1, floor(self.height / self.row-height) + 6);
                                root.playlist_viewport_changed(first-row, visible-rows);
                            }
                            changed height => {
                                let scroll-offset-y = max(0px, -self.viewport-y);
                                let first-row = max(0, floor(scroll-offset-y / self.row-height));
                                let visible-rows = max(1, floor(self.height / self.row-height) + 6);
                                root.playlist_viewport_changed(first-row, visible-rows);
                            }
                            changed row-height => {
                                let scroll-offset-y = max(0px, -self.viewport-y);
                                let first-row = max(0, floor(scroll-offset-y / self.row-height));
                                let visible-rows = max(1, floor(self.height / self.row-height) + 6);
                                root.playlist_viewport_changed(first-row, visible-rows);
                            }
                            init => {
                                let visible-rows = max(1, floor(self.height / self.row-height) + 6);
                                root.playlist_viewport_changed(0, visible-rows);
                            }
                            changed center-token => {
                                let row-height = self.row-height;
                                let first-visible-row = track-list-container.first-visible-row;
                                let visible-rows = track-list-container.visible-row-count;
                                if root.playlist_scroll_target_row >= first-visible-row
                                        && root.playlist_scroll_target_row < first-visible-row + visible-rows {
                                    return;
                                }
                                let max-first-row = max(0, root.track_model.length - visible-rows);
                                let centered-first-row = min(
                                    max-first-row,
                                    max(
                                        0,
                                        root.playlist_scroll_target_row - floor(visible-rows / 2)
                                    )
                                );
                                self.viewport-y = 0px - centered-first-row * row-height;
                            }
                            for track[i] in root.track_model : TrackRow {
                                width: max(track-list.visible-width, root.playlist-content-width);
                                data: track;
                                is-playing: root.playing_track_index == i;
                                is-hover: root.hover-index == i && !root.is-dragging;
                                headers: root.playlist_visible_column_headers;
                                column-kinds: root.playlist_visible_column_kinds;
                                column-widths-px: root.playlist_column_widths_px;
                                row-height: track-list.row-height;
                                null-column-width: root.null-column-width;
                                horizontal-padding: root.playlist-row-padding-x;
                                column-spacing: root.playlist-column-spacing;
                                status-lane-width: root.playlist-status-lane-width;
                                hover-column-index: root.playlist-link-hover-row == i
                                    ? root.playlist-link-hover-column
                                    : -1;
                                modifier-link-mode-active: root.playlist-link-modifier-active;
                                metadata_link_activated(kind, value, album, album_artist, track_path) => {
                                    root.activate_metadata_link(
                                        kind,
                                        value,
                                        album,
                                        album_artist,
                                        track_path,
                                        true
                                    );
                                }
                            }
                        }

                        track-list-overlay := TouchArea {
                            x: 0;
                            y: 0px;
                            // Reserve fixed lanes for scrollbars so the overlay never steals scrollbar clicks.
                            property <length> scrollbar-lane-reserve: 18px;
                            width: max(0px, parent.width - self.scrollbar-lane-reserve);
                            height: max(0px, parent.height - self.scrollbar-lane-reserve);
                            property <length> row-height: track-list.row-height;
                            property <length> header-height: 28px;
                            property <bool> in-viewport: self.mouse-x >= 0px
                                && self.mouse-y >= 0px
                                && self.mouse-x < self.width
                                && self.mouse-y < self.height;
                            property <length> content-y: self.mouse-y - track-list.viewport-y;
                            property <int> raw-row: floor(content-y / row-height);
                            property <bool> is-in-rows: self.in-viewport && raw-row >= 0 && raw-row < root.track_model.length;
                            property <bool> in-null-column: self.in-viewport
                                && self.mouse-x >= (track-list.visible-width - root.null-column-width);
                            property <int> hovered-row: is-in-rows ? raw-row : -1;
                            property <int> drop-gap: max(0, min(root.track_model.length, floor((content-y + row-height / 2) / row-height)));
                            property <int> hovered-column: -1;
                            property <bool> hovered-column-has-link: self.is-in-rows
                                && !self.in-null-column
                                && self.hovered-column >= 0
                                && self.hovered-column < root.track_model[self.hovered-row].rich_values.length
                                && root.track_model[self.hovered-row].rich_values[self.hovered-column].lines.length > 0
                                && root.track_model[self.hovered-row].rich_values[self.hovered-column].lines[0].runs.length > 0
                                && root.track_model[self.hovered-row].rich_values[self.hovered-column].lines[0].runs[0].link_kind != 0;
                            property <bool> hovered-link-activatable: self.hovered-column-has-link
                                && root.playlist-link-modifier-active;
                            mouse-cursor: self.hovered-link-activatable ? pointer : default;

                            pointer-event(event) => {
                                let content-mouse-x-px = floor(
                                    (
                                        self.mouse-x
                                            - root.playlist-columns-band-offset-x
                                            - track-list.viewport-x
                                    ) / 1px
                                );
                                self.hovered-column = content-mouse-x-px >= 0
                                    ? root.playlist_header_column_at(content-mouse-x-px)
                                    : -1;
                                root.playlist-link-modifier-active = event.modifiers.control || event.modifiers.meta;
                                if (self.hovered-link-activatable) {
                                    root.playlist-link-hover-row = self.hovered-row;
                                    root.playlist-link-hover-column = self.hovered-column;
                                } else {
                                    root.playlist-link-hover-row = -1;
                                    root.playlist-link-hover-column = -1;
                                }
                                if (event.button == PointerEventButton.left) {
                                    if (event.kind == PointerEventKind.down) {
                                        root.show_playlist_track_context_menu = false;
                                        root.show_library_context_menu = false;
                                        if (self.hovered-link-activatable) {
                                            let run = root.track_model[self.hovered-row].rich_values[self.hovered-column].lines[0].runs[0];
                                            root.activate_metadata_link(
                                                run.link_kind,
                                                run.link_value,
                                                run.link_album,
                                                run.link_album_artist,
                                                run.link_track_path,
                                                true
                                            );
                                            return;
                                        }
                                        if (!self.is-in-rows || self.in-null-column) {
                                            root.sidebar_has_focus = false;
                                            key-handler.focus();
                                            root.pressed-index = -1;
                                            root.hover-index = -1;
                                            root.playlist-link-hover-row = -1;
                                            root.playlist-link-hover-column = -1;
                                            root.deselect_all();
                                            return;
                                        }
                                        if (self.hovered-column >= 0
                                                && self.hovered-column < root.playlist_visible_column_kinds.length
                                                && root.playlist_visible_column_kinds[self.hovered-column] == 2) {
                                            root.toggle_favorite_for_playlist_row(self.hovered-row);
                                            root.pressed-index = -1;
                                            root.hover-index = -1;
                                            return;
                                        }
                                        root.pressed-index = self.hovered-row;
                                        root.press-y = self.mouse-y;
                                        root.filter-blocked-shown = false;
                                        root.sidebar_has_focus = false;
                                        key-handler.focus();
                                        root.on_pointer_down(self.hovered-row, event.modifiers.control, event.modifiers.shift);
                                    } else if (event.kind == PointerEventKind.up) {
                                        // Always notify the backend on pointer-up so that
                                        // deferred single-select (cancel multiselect on click)
                                        // works even when a filter/sort view is active.
                                        // The backend blocks drag-reorder in filter mode but
                                        // still needs to process the pending click-to-select.
                                        // Pass filter-blocked-shown to prevent collapse when
                                        // a drag was attempted.
                                        if (root.pressed-index != -1) {
                                            root.on_drag_end(self.drop-gap, root.filter-blocked-shown);
                                        }
                                        root.hover-index = -1;
                                        root.playlist-link-hover-row = -1;
                                        root.playlist-link-hover-column = -1;
                                    }
                                }
                                if (event.button == PointerEventButton.right
                                        && event.kind == PointerEventKind.down
                                        && self.is-in-rows
                                        && !self.in-null-column) {
                                    root.show_library_context_menu = false;
                                    root.sidebar_has_focus = false;
                                    key-handler.focus();

                                    let row-selected = self.hovered-row >= 0
                                        && self.hovered-row < root.track_model.length
                                        && root.track_model[self.hovered-row].selected;
                                    if (!row-selected || event.modifiers.control || event.modifiers.shift) {
                                        root.on_pointer_down(
                                            self.hovered-row,
                                            event.modifiers.control,
                                            event.modifiers.shift
                                        );
                                    }

                                    let click-x = root.layout-region-x(i) + parent.x + self.x + self.mouse-x;
                                    let click-y = root.layout-region-y(i) + parent.y + self.y + self.mouse-y;
                                    root.playlist_track_context_menu_x = min(root.width - 170px, max(root.context-menu-margin, click-x));
                                    root.playlist_track_context_menu_y = min(root.height - root.context-menu-height - root.context-menu-margin, max(root.context-menu-margin, click-y));
                                    root.show_playlist_track_context_menu = true;
                                }
                            }

                            moved => {
                                let content-mouse-x-px = floor(
                                    (
                                        self.mouse-x
                                            - root.playlist-columns-band-offset-x
                                            - track-list.viewport-x
                                    ) / 1px
                                );
                                self.hovered-column = content-mouse-x-px >= 0
                                    ? root.playlist_header_column_at(content-mouse-x-px)
                                    : -1;
                                if (self.hovered-link-activatable) {
                                    root.playlist-link-hover-row = self.hovered-row;
                                    root.playlist-link-hover-column = self.hovered-column;
                                } else {
                                    root.playlist-link-hover-row = -1;
                                    root.playlist-link-hover-column = -1;
                                }
                                if (root.playlist_filter_active) {
                                    if (self.pressed && root.pressed-index != -1 && !root.filter-blocked-shown && abs(self.mouse-y - root.press-y) > 5px) {
                                        root.playlist_modification_blocked();
                                        root.filter-blocked-shown = true;
                                    }
                                    root.is-dragging = false;
                                    root.drop-index = -1;
                                    return;
                                }
                                if (!self.pressed) {
                                    root.hover-index = (self.is-in-rows && !self.in-null-column) ? self.hovered-row : -1;
                                } else {
                                    if (root.pressed-index != -1 && !root.is-dragging && abs(self.mouse-y - root.press-y) > 5px) {
                                        root.is-dragging = true;
                                        root.on_drag_start(root.pressed-index);
                                    }
                                    if (root.is-dragging && root.pressed-index != -1) {
                                        root.on_drag_move(self.drop-gap);
                                    }
                                }
                            }

                            double-clicked => {
                                if (self.is-in-rows && !self.in-null-column) {
                                    root.playlist_item_double_click(self.hovered-row);
                                }
                            }
                        }

                        if (root.is-dragging && root.drop-index != -1) : Rectangle {
                            x: 0;
                            y: max(0 , track-list.header-height + (root.drop-index - 1) * track-list.row-height) + track-list.viewport-y;
                            width: 100%;
                            height: 2px;
                            background: AppPalette.accent;
                        }
                    }
                }

                if track-list-panel.active-mode == 1 : Rectangle {
                    background: transparent;

                    VerticalLayout {
                        padding: 8px;
                        spacing: 6px;

                    HorizontalLayout {
                        if root.library_can_go_back : PlayerButton {
                            icon-source: AppIcons.arrow-left;
                            icon-text: "";
                            font-size: 14px;
                            tooltip-text: "Back";
                            tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                            }
                            clicked => { root.library_back(); }
                        }
                        if root.library_album_header_visible && root.library_can_go_back : Text {
                            text: root.library_root_index == 1 ? "Back to Artists" : "Back to Albums";
                            color: AppPalette.text-secondary;
                            font-size: 11px;
                            vertical-alignment: center;
                        }
                        if !root.library_album_header_visible : Text {
                            text: root.library_view_title;
                            color: root.theme_text_primary;
                            font-size: 16px;
                            font-weight: 800;
                            horizontal-stretch: 1;
                            horizontal-alignment: left;
                            vertical-alignment: bottom;
                            overflow: elide;
                        }
                        if root.library_scan_in_progress : Text {
                            text: "Scanning...";
                            color: AppPalette.text-secondary;
                            font-size: 11px;
                            vertical-alignment: center;
                        }
                    }

                    if !root.library_album_header_visible : Text {
                        text: root.library_view_subtitle;
                        color: root.theme_text_muted;
                        font-size: 11px;
                        height: 16px;
                        overflow: elide;
                    }

                    if root.library_album_header_visible : Rectangle {
                        height: 220px;
                        HorizontalLayout {
                            spacing: 14px;
                            Rectangle {
                                width: 176px;
                                height: 176px;
                                border-radius: 4px;
                                border-width: 1px;
                                border-color: root.theme_border;
                                background: AppPalette.panel-bg-elevated;
                                if root.library_album_header_has_art : Image {
                                    width: parent.width;
                                    height: parent.height;
                                    source: root.library_album_header_art;
                                    image-fit: contain;
                                }
                                if !root.library_album_header_has_art : Image {
                                    source: root.library_root_index == 1 ? AppIcons.user : AppIcons.disc;
                                    width: 22px;
                                    height: 22px;
                                    x: (parent.width - self.width) / 2;
                                    y: (parent.height - self.height) / 2;
                                    image-fit: contain;
                                    colorize: AppPalette.text-secondary;
                                }
                            }
                            Rectangle {
                                horizontal-stretch: 1;
                                VerticalLayout {
                                    spacing: 4px;
                                    Rectangle { vertical-stretch: 1; }
                                    Text {
                                        text: root.library_view_title;
                                        color: root.theme_text_primary;
                                        font-size: 20px;
                                        font-weight: 800;
                                        overflow: elide;
                                        horizontal-alignment: left;
                                    }
                                    Text {
                                        text: root.library_view_subtitle;
                                        color: root.theme_text_secondary;
                                        font-size: 12px;
                                        overflow: elide;
                                        horizontal-alignment: left;
                                    }
                                    Text {
                                        text: root.library_album_header_meta;
                                        color: AppPalette.text-secondary;
                                        font-size: 11px;
                                        overflow: elide;
                                        horizontal-alignment: left;
                                    }
                                    Text {
                                        text: root.library_detail_header_loading
                                            ? "Loading internet metadata..."
                                            : root.library_detail_header_blurb;
                                        color: AppPalette.text-secondary;
                                        font-size: 11px;
                                        wrap: word-wrap;
                                        max-height: 76px;
                                        overflow: clip;
                                        horizontal-alignment: left;
                                    }
                                    if root.library_detail_header_source_visible : Rectangle {
                                        height: 18px;
                                        background: library-source-link-ta.has-hover
                                            ? AppPalette.control-hover-bg
                                            : transparent;
                                        border-radius: 3px;
                                        Text {
                                            x: 6px;
                                            width: max(0px, parent.width - 12px);
                                            text: "Source: " + root.library_detail_header_source_name;
                                            color: AppPalette.accent;
                                            font-size: 10px;
                                            vertical-alignment: center;
                                            overflow: elide;
                                        }
                                        library-source-link-ta := TouchArea {
                                            clicked => {
                                                if root.library_detail_header_source_url != "" {
                                                    root.open_external_url(root.library_detail_header_source_url);
                                                }
                                            }
                                        }
                                    }
                                    Rectangle { vertical-stretch: 1; }
                                }
                            }
                        }
                    }

                    library-search-container := Rectangle {
                        height: root.library_search_visible ? 30px : 0px;
                        visible: root.library_search_visible;
                        property <int> focus-token: root.library_search_focus_token;
                        changed focus-token => {
                            if (root.library_search_visible) {
                                library-search-input.focus();
                            }
                        }
                        border-radius: 4px;
                        background: AppPalette.panel-bg-elevated;
                        border-width: 1px;
                        border-color: root.theme_border;

                        HorizontalLayout {
                            spacing: 6px;
                            padding-left: 8px;
                            padding-right: 6px;

                            library-search-input := LineEdit {
                                text <=> root.library_search_query;
                                placeholder-text: "Search this library view...";
                                horizontal-stretch: 1;
                                edited(text) => {
                                    root.library_search_query_edited(text);
                                }
                            }
                            Text {
                                text: root.library_search_result_text;
                                color: root.theme_text_secondary;
                                font-size: 11px;
                                width: 54px;
                                horizontal-alignment: right;
                                vertical-alignment: center;
                            }

                            PlayerButton {
                                icon-source: AppIcons.close;
                                icon-text: "";
                                font-size: 12px;
                                tooltip-text: "Close library search";
                                tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                    root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                }
                                clicked => {
                                    root.close_library_search();
                                    root.refocus_main();
                                }
                            }
                        }
                    }

                    Rectangle { height: 1px; background: root.theme_separator; }

                    library-list-container := Rectangle {
                        vertical-stretch: 1;
                        clip: true;
                        property <bool> has-configured-folders: root.settings_library_folders.length > 0;
                        property <bool> has-any-content: root.library_has_any_content;
                        property <int> first-visible-row: max(
                            0,
                            floor(max(0px, -library-list-view.viewport-y) / (library-list-view.row-height-px * 1px))
                        );
                        property <int> visible-row-count: max(
                            1,
                            floor(
                                library-list-view.height / (library-list-view.row-height-px * 1px)
                            )
                        );
                        property <bool> has-partial-bottom-row: ceil(
                            library-list-view.height / (library-list-view.row-height-px * 1px)
                        ) > floor(
                            library-list-view.height / (library-list-view.row-height-px * 1px)
                        );
                        property <bool> last-track-partially-visible-at-bottom: self.has-playing-row
                            && self.has-partial-bottom-row
                            && root.library_playing_track_index == root.library_model.length - 1
                            && root.library_playing_track_index == self.first-visible-row + self.visible-row-count;
                        property <bool> has-playing-row: self.has-any-content
                            && root.library_playing_track_index >= 0
                            && root.library_playing_track_index < root.library_model.length;
                        property <bool> playing-above-viewport: self.has-playing-row
                            && root.library_playing_track_index < self.first-visible-row;
                        property <bool> playing-below-viewport: self.has-playing-row
                            && root.library_playing_track_index >= self.first-visible-row + self.visible-row-count
                            && !self.last-track-partially-visible-at-bottom;
                        property <bool> show-scroll-to-playing-toast: self.playing-above-viewport
                            || self.playing-below-viewport;
                        property <length> stack-base-y: 6px;
                        property <length> stack-gap-y: 6px;
                        changed visible-row-count => {
                            root.library-visible-row-count = self.visible-row-count;
                        }
                        property <length> online-prompt-y: self.stack-base-y;
                        property <length> scroll-toast-y: self.stack-base-y
                            + (root.library_online_prompt_visible ? (34px + self.stack-gap-y) : 0px);

                        library-list-view := ListView {
                            y: 0px;
                            width: parent.width;
                            height: parent.height;
                            visible: library-list-container.has-any-content;
                            property <int> row-height-px: root.library_root_index == 2 ? 38
                                : root.library_root_index == 0 ? 32
                                : 34;
                            property <int> restore-token: root.library_scroll_restore_token;
                            property <int> center-token: root.library_scroll_center_token;
                            changed restore-token => {
                                let clamped-row = min(max(0, root.library_scroll_target_row), max(0, root.library_model.length - 1));
                                self.viewport-y = 0px - clamped-row * (self.row-height-px * 1px);
                            }
                            changed center-token => {
                                let row-height = self.row-height-px * 1px;
                                let clamped-row = min(max(0, root.library_scroll_target_row), max(0, root.library_model.length - 1));
                                let first-visible-row = library-list-container.first-visible-row;
                                let visible-rows = library-list-container.visible-row-count;
                                if clamped-row >= first-visible-row
                                        && clamped-row < first-visible-row + visible-rows {
                                    return;
                                }
                                let max-first-row = max(0, root.library_model.length - visible-rows);
                                let centered-first-row = min(
                                    max-first-row,
                                    max(0, clamped-row - floor(visible-rows / 2))
                                );
                                self.viewport-y = 0px - centered-first-row * row-height;
                            }
                            changed viewport-y => {
                                let scroll-offset-y = max(0px, -self.viewport-y);
                                let first-row = max(0, floor(scroll-offset-y / (self.row-height-px * 1px)));
                                let visible-rows = max(1, floor(self.height / (self.row-height-px * 1px)) + 6);
                                root.library_viewport_changed(first-row, visible-rows);
                            }
                            changed height => {
                                let scroll-offset-y = max(0px, -self.viewport-y);
                                let first-row = max(0, floor(scroll-offset-y / (self.row-height-px * 1px)));
                                let visible-rows = max(1, floor(self.height / (self.row-height-px * 1px)) + 6);
                                root.library_viewport_changed(first-row, visible-rows);
                            }
                            changed row-height-px => {
                                let scroll-offset-y = max(0px, -self.viewport-y);
                                let first-row = max(0, floor(scroll-offset-y / (self.row-height-px * 1px)));
                                let visible-rows = max(1, floor(self.height / (self.row-height-px * 1px)) + 6);
                                root.library_viewport_changed(first-row, visible-rows);
                            }
                            init => {
                                let visible-rows = max(1, floor(self.height / (self.row-height-px * 1px)) + 6);
                                root.library_viewport_changed(0, visible-rows);
                            }
                            for item[row] in root.library_model : Rectangle {
                                horizontal-stretch: 1;
                                height: item.item_kind == 2 ? 38px
                                    : item.item_kind == 0 ? 32px
                                    : 34px;
                                library-list-row-ta := TouchArea {
                                    pointer-event(event) => {
                                        if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                                            if (item.favoritable && self.mouse-x >= self.width - 30px) {
                                                root.toggle_favorite_for_library_row(row);
                                                return;
                                            }
                                            root.show_library_context_menu = false;
                                            root.show_playlist_track_context_menu = false;
                                            root.sidebar_has_focus = false;
                                            key-handler.focus();
                                            root.library_select_list_item(
                                                row,
                                                event.modifiers.control,
                                                event.modifiers.shift,
                                                false
                                            );
                                        } else if (event.kind == PointerEventKind.down && event.button == PointerEventButton.right) {
                                            root.show_playlist_track_context_menu = false;
                                            root.sidebar_has_focus = false;
                                            key-handler.focus();
                                            root.library_select_list_item(
                                                row,
                                                event.modifiers.control,
                                                event.modifiers.shift,
                                                true
                                            );
                                            let row-height = library-list-view.row-height-px * 1px;
                                            let row-y = row * row-height + library-list-view.viewport-y;
                                            let click-x = root.layout-region-x(i) + library-list-container.x + self.mouse-x;
                                            let click-y = root.layout-region-y(i) + library-list-container.y + row-y + self.mouse-y;
                                            root.library_context_menu_x = min(root.width - 190px, max(root.context-menu-margin, click-x));
                                            root.library_context_menu_y = min(root.height - root.context-menu-height - root.context-menu-margin, max(root.context-menu-margin, click-y));
                                            root.show_library_context_menu = true;
                                        }
                                    }
                                    double-clicked => {
                                        root.show_library_context_menu = false;
                                        root.sidebar_has_focus = false;
                                        key-handler.focus();
                                        root.library_item_activated(row);
                                    }
                                }
                                LibraryRow {
                                    width: parent.width;
                                    height: parent.height;
                                    data: item;
                                    is-hover: library-list-row-ta.has-hover;
                                    metadata_link_activated(kind, value, album, album_artist, track_path) => {
                                        root.activate_metadata_link(
                                            kind,
                                            value,
                                            album,
                                            album_artist,
                                            track_path,
                                            false
                                        );
                                    }
                                }
                            }
                        }

                        if !library-list-container.has-any-content : Rectangle {
                            x: 12px;
                            y: 12px;
                            width: max(0px, parent.width - 24px);
                            height: max(0px, parent.height - 24px);
                            border-radius: 8px;
                            border-width: 1px;
                            border-color: AppPalette.border;
                            background: AppPalette.panel-bg;

                            Rectangle {
                                width: min(parent.width - 28px, 540px);
                                height: 170px;
                                x: (parent.width - self.width) / 2;
                                y: (parent.height - self.height) / 2;

                                VerticalLayout {
                                    spacing: 12px;

                                    Text {
                                        text: "Add folders to get started";
                                        color: AppPalette.text-primary;
                                        font-size: 26px;
                                        font-weight: 800;
                                        horizontal-alignment: center;
                                    }

                                    Text {
                                        text: "Library mode is empty. Add folders, playlist tracks, or remote tracks to populate it.";
                                        color: AppPalette.text-secondary;
                                        font-size: 13px;
                                        horizontal-alignment: center;
                                        wrap: word-wrap;
                                    }

                                    HorizontalLayout {
                                        Rectangle { horizontal-stretch: 1; }
                                        Button {
                                            text: "Add Folder";
                                            primary: true;
                                            clicked => {
                                                root.library_add_folder();
                                            }
                                        }
                                        Rectangle { horizontal-stretch: 1; }
                                    }
                                }
                            }
                        }

                        if library-list-container.has-any-content
                                && library-list-container.show-scroll-to-playing-toast : Rectangle {
                            x: max(8px, parent.width - self.width - 8px);
                            y: library-list-container.scroll-toast-y;
                            width: max(146px, min(parent.width - 16px, library-scroll-toast-text.preferred-width + 24px));
                            height: 26px;
                            border-radius: 4px;
                            border-width: 1px;
                            border-color: AppPalette.accent-soft-border;
                            background: AppPalette.accent-soft-bg;
                            z: 6;

                            library-scroll-toast-text := Text {
                                text: (library-list-container.playing-above-viewport ? "▲ " : "▼ ") + "Scroll to playing";
                                color: AppPalette.text-primary;
                                font-size: 11px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                                overflow: elide;
                            }

                            library-scroll-toast-ta := TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    if (library-list-container.has-playing-row) {
                                        let max-first-row = max(
                                            0,
                                            root.library_model.length - library-list-container.visible-row-count
                                        );
                                        let centered-first-row = min(
                                            max-first-row,
                                            max(
                                                0,
                                                root.library_playing_track_index
                                                    - floor(library-list-container.visible-row-count / 2)
                                            )
                                        );
                                        library-list-view.viewport-y = 0px - centered-first-row * (library-list-view.row-height-px * 1px);
                                    }
                                }
                            }
                        }

                        if root.library_online_prompt_visible : Rectangle {
                            z: 7;
                            x: max(8px, parent.width - self.width - 8px);
                            y: library-list-container.online-prompt-y;
                            width: min(parent.width - 16px, 460px);
                            height: 34px;
                            border-radius: 4px;
                            border-width: 1px;
                            border-color: AppPalette.accent-soft-border;
                            background: AppPalette.accent-soft-bg;

                            HorizontalLayout {
                                spacing: 8px;
                                padding-left: 10px;
                                padding-right: 6px;

                                Text {
                                    text: "Fetch artist/album page metadata from internet";
                                    color: AppPalette.text-primary;
                                    font-size: 11px;
                                    horizontal-stretch: 1;
                                    vertical-alignment: center;
                                    overflow: elide;
                                }

                                Rectangle {
                                    width: 22px;
                                    height: 22px;
                                    border-radius: 3px;
                                    background: prompt-accept-ta.has-hover
                                        ? AppPalette.control-pressed-bg
                                        : AppPalette.control-hover-bg;
                                    Image {
                                        source: AppIcons.check;
                                        width: 12px;
                                        height: 12px;
                                        x: (parent.width - self.width) / 2;
                                        y: (parent.height - self.height) / 2;
                                        image-fit: contain;
                                        colorize: AppPalette.text-primary;
                                    }
                                    prompt-accept-ta := TouchArea {
                                        clicked => { root.library_online_metadata_prompt_accept(); }
                                    }
                                }

                                Rectangle {
                                    width: 22px;
                                    height: 22px;
                                    border-radius: 3px;
                                    background: prompt-deny-ta.has-hover
                                        ? AppPalette.danger.mix(AppPalette.panel-bg, 0.72)
                                        : AppPalette.danger.mix(AppPalette.panel-bg, 0.82);
                                    Image {
                                        source: AppIcons.close;
                                        width: 11px;
                                        height: 11px;
                                        x: (parent.width - self.width) / 2;
                                        y: (parent.height - self.height) / 2;
                                        image-fit: contain;
                                        colorize: AppPalette.danger;
                                    }
                                    prompt-deny-ta := TouchArea {
                                        clicked => { root.library_online_metadata_prompt_deny(); }
                                    }
                                }
                            }
                        }
                    }
                    }

                }

                Rectangle {
                    z: 20;
                    x: (parent.width - self.width) / 2;
                    y: parent.height - self.height - 14px;
                    width: max(180px, min(parent.width - 24px, track-panel-toast-text.preferred-width + 24px));
                    height: 30px;
                    border-radius: 4px;
                    border-width: 1px;
                    border-color: AppPalette.border;
                    background: AppPalette.panel-bg-elevated;
                    opacity: root.library_toast_visible ? 1 : 0;
                    visible: root.library_toast_visible;
                    animate opacity { duration: 220ms; easing: ease-in-out; }

                    track-panel-toast-text := Text {
                        text: root.library_toast_text;
                        color: AppPalette.text-primary;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        overflow: elide;
                    }
                }

            }

            for leaf-id[i] in root.layout_leaf_ids : StatusBar {
                x: root.layout-region-x(i);
                y: root.layout-region-y(i);
                width: root.layout-region-width(i);
                height: root.layout-region-height(i);
                visible: root.layout-region-is-visible(i)
                    && root.layout-region-panel-kind(i) == root.panel_kind_status_bar;
                status-text: root.status-text;
                technical-info: root.technical-info;
                selection-summary: root.status-selection-summary;
            }

            for leaf-id[i] in root.layout_leaf_ids : Rectangle {
                property <int> panel-kind: root.layout-region-panel-kind(i);
                x: root.layout-region-x(i);
                y: root.layout-region-y(i);
                width: root.layout-region-width(i);
                height: root.layout-region-height(i);
                visible: root.layout_edit_mode
                    && root.layout-region-is-visible(i)
                    && self.panel-kind != root.panel_kind_none;
                background: leaf-select-ta.has-hover
                    ? AppPalette.control-hover-bg.mix(transparent, 0.55)
                    : transparent;
                border-width: 1px;
                border-color: i == root.layout_selected_leaf_index ? AppPalette.selection-border : AppPalette.border;
                z: 100;
                Text {
                    visible: leaf-select-ta.has-hover || i == root.layout_selected_leaf_index;
                    text: root.layout-panel-label(parent.panel-kind);
                    color: i == root.layout_selected_leaf_index ? AppPalette.text-primary : AppPalette.text-disabled;
                    font-size: 11px;
                    x: 6px;
                    y: 4px;
                    width: max(0px, parent.width - 12px);
                    overflow: elide;
                }
                leaf-select-ta := TouchArea {
                    x: 0px;
                    y: 0px;
                    width: parent.width;
                    height: parent.height;
                    pointer-event(event) => {
                        if (event.kind == PointerEventKind.down && event.button == PointerEventButton.right) {
                            root.layout_select_leaf(leaf-id);
                            root.show_layout_splitter_context_menu = false;
                            root.layout_leaf_context_menu_x = min(root.width - 430px, max(8px, parent.x + self.mouse-x + 6px));
                            root.layout_leaf_context_menu_y = min(max(8px, root.height - 372px), max(8px, parent.y + self.mouse-y + 6px));
                            root.show_layout_leaf_replace_submenu = false;
                            root.layout_leaf_replace_submenu_hover = false;
                            root.show_layout_leaf_panels_submenu = false;
                            root.layout_leaf_panels_submenu_hover = false;
                            root.show_layout_leaf_presets_submenu = false;
                            root.layout_leaf_presets_submenu_hover = false;
                            root.show_layout_leaf_context_menu = true;
                        } else if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                            root.layout_select_leaf(leaf-id);
                            root.show_layout_leaf_replace_submenu = false;
                            root.layout_leaf_replace_submenu_hover = false;
                            root.show_layout_leaf_panels_submenu = false;
                            root.layout_leaf_panels_submenu_hover = false;
                            root.show_layout_leaf_presets_submenu = false;
                            root.layout_leaf_presets_submenu_hover = false;
                            root.show_layout_leaf_context_menu = false;
                            root.show_layout_splitter_context_menu = false;
                        }
                    }
                }
            }

            for splitter[i] in root.layout_splitters : Rectangle {
                visible: root.layout_edit_mode;
                x: splitter.x_px * 1px;
                y: splitter.y_px * 1px;
                width: splitter.width_px * 1px;
                height: splitter.height_px * 1px;
                z: 120;
                background: splitter-ta.has-hover || root.layout_active_splitter_index == i
                    ? AppPalette.selection-border
                    : AppPalette.separator;
                splitter-ta := TouchArea {
                    x: splitter.axis == 1 ? -4px : 0px;
                    y: splitter.axis == 0 ? -4px : 0px;
                    width: splitter.axis == 1 ? parent.width + 8px : parent.width;
                    height: splitter.axis == 0 ? parent.height + 8px : parent.height;
                    mouse-cursor: splitter.axis == 1 ? col-resize : row-resize;
                    pointer-event(event) => {
                        if (event.kind == PointerEventKind.down && event.button == PointerEventButton.right) {
                            root.layout_active_splitter_index = -1;
                            root.layout_context_splitter_id = splitter.id;
                            root.show_layout_leaf_replace_submenu = false;
                            root.layout_leaf_replace_submenu_hover = false;
                            root.show_layout_leaf_panels_submenu = false;
                            root.layout_leaf_panels_submenu_hover = false;
                            root.show_layout_leaf_presets_submenu = false;
                            root.layout_leaf_presets_submenu_hover = false;
                            root.show_layout_leaf_context_menu = false;
                            root.layout_splitter_context_menu_x = min(root.width - 220px, max(8px, parent.x + self.x + self.mouse-x + 6px));
                            root.layout_splitter_context_menu_y = min(root.height - 120px, max(8px, parent.y + self.y + self.mouse-y + 6px));
                            root.show_layout_splitter_context_menu = true;
                        } else if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                            root.show_layout_leaf_replace_submenu = false;
                            root.layout_leaf_replace_submenu_hover = false;
                            root.show_layout_leaf_panels_submenu = false;
                            root.layout_leaf_panels_submenu_hover = false;
                            root.show_layout_leaf_presets_submenu = false;
                            root.layout_leaf_presets_submenu_hover = false;
                            root.show_layout_leaf_context_menu = false;
                            root.show_layout_splitter_context_menu = false;
                            root.layout_active_splitter_index = i;
                            // Include touch-area offsets to store the true absolute pointer position.
                            root.layout_splitter_drag_start_mouse_x = parent.x + self.x + self.mouse-x;
                            root.layout_splitter_drag_start_mouse_y = parent.y + self.y + self.mouse-y;
                            root.layout_splitter_drag_start_ratio = splitter.ratio;
                        } else if (event.kind == PointerEventKind.up && event.button == PointerEventButton.left && root.layout_active_splitter_index == i) {
                            let current-mouse-x = parent.x + self.x + self.mouse-x;
                            let current-mouse-y = parent.y + self.y + self.mouse-y;
                            let delta-px = splitter.axis == 1
                                ? (current-mouse-x - root.layout_splitter_drag_start_mouse_x) / 1px
                                : (current-mouse-y - root.layout_splitter_drag_start_mouse_y) / 1px;
                            let ratio-delta = delta-px / (max(1, splitter.track_length_px) * 1.0);
                            let target-ratio = root.layout_splitter_drag_start_ratio + ratio-delta;
                            let committed-ratio = min(splitter.max_ratio, max(splitter.min_ratio, target-ratio));
                            root.preview_layout_splitter_ratio(splitter.id, committed-ratio);
                            root.commit_layout_splitter_ratio(splitter.id, committed-ratio);
                            root.layout_active_splitter_index = -1;
                        } else if (event.kind == PointerEventKind.cancel && root.layout_active_splitter_index == i) {
                            root.preview_layout_splitter_ratio(splitter.id, root.layout_splitter_drag_start_ratio);
                            root.layout_active_splitter_index = -1;
                        }
                    }
                    moved => {
                        if (root.layout_active_splitter_index == i && self.pressed) {
                            let current-mouse-x = parent.x + self.x + self.mouse-x;
                            let current-mouse-y = parent.y + self.y + self.mouse-y;
                            let delta-px = splitter.axis == 1
                                ? (current-mouse-x - root.layout_splitter_drag_start_mouse_x) / 1px
                                : (current-mouse-y - root.layout_splitter_drag_start_mouse_y) / 1px;
                            let ratio-delta = delta-px / (max(1, splitter.track_length_px) * 1.0);
                            let target-ratio = root.layout_splitter_drag_start_ratio + ratio-delta;
                            let clamped-ratio = min(splitter.max_ratio, max(splitter.min_ratio, target-ratio));
                            root.preview_layout_splitter_ratio(splitter.id, clamped-ratio);
                        }
                    }
                }
            }
        }
    }

    column-header-menu := ColumnHeaderMenu {
        x: root.column-menu-x;
        y: root.column-menu-y;
        labels: root.playlist_column_menu_labels;
        checked: root.playlist_column_menu_checked;
        custom: root.playlist_column_menu_is_custom;
        toggle-column(index) => {
            root.toggle_playlist_column(index);
        }
        delete-column(index) => {
            if (index >= 0 && index < root.playlist_column_menu_labels.length
                    && index < root.playlist_column_menu_is_custom.length
                    && root.playlist_column_menu_is_custom[index]) {
                root.delete_custom_column_index = index;
                root.delete_custom_column_message = "Delete custom column '" + root.playlist_column_menu_labels[index] + "'?";
                root.show_delete_custom_column_confirm = true;
                column-header-menu.close();
            }
        }
        add-custom() => {
            root.show_custom_column_dialog = true;
            root.custom_column_name = "";
            root.custom_column_format = "";
            column-header-menu.close();
        }
    }

    if root.layout_edit_mode && (root.show_layout_leaf_context_menu || root.show_layout_splitter_context_menu) : Rectangle {
        z: 129;
        background: transparent;
        touch-to-dismiss-layout-menu := TouchArea {
            clicked => {
                root.show_layout_leaf_replace_submenu = false;
                root.layout_leaf_replace_submenu_hover = false;
                root.show_layout_leaf_panels_submenu = false;
                root.layout_leaf_panels_submenu_hover = false;
                root.show_layout_leaf_presets_submenu = false;
                root.layout_leaf_presets_submenu_hover = false;
                root.show_layout_leaf_context_menu = false;
                root.show_layout_splitter_context_menu = false;
            }
        }
    }

    if root.layout_edit_mode : Rectangle {
        z: 128;
        width: root.layout_exit_editor_button_width;
        height: root.layout_exit_editor_button_height;
        x: min(max(0px, root.layout_exit_editor_button_x), max(0px, root.width - self.width));
        y: min(max(0px, root.layout_exit_editor_button_y), max(0px, root.height - self.height));
        background: transparent;
        opacity: 0.86;

        drag-handle-chip := Rectangle {
            x: 0px;
            y: 0px;
            width: 20px;
            height: parent.height;
            border-radius: 4px;
            border-width: 1px;
            border-color: AppPalette.warning;
            background: root.layout_exit_editor_dragging || drag-handle-ta.has-hover
                ? AppPalette.warning.mix(AppPalette.panel-bg-elevated, 0.34)
                : AppPalette.warning.mix(AppPalette.panel-bg-elevated, 0.46);

            Rectangle {
                width: 3px;
                height: 3px;
                border-radius: 1px;
                x: (parent.width - self.width) / 2;
                y: (parent.height - 11px) / 2;
                background: AppPalette.text-primary;
            }
            Rectangle {
                width: 3px;
                height: 3px;
                border-radius: 1px;
                x: (parent.width - self.width) / 2;
                y: (parent.height - 11px) / 2 + 4px;
                background: AppPalette.text-primary;
            }
            Rectangle {
                width: 3px;
                height: 3px;
                border-radius: 1px;
                x: (parent.width - self.width) / 2;
                y: (parent.height - 11px) / 2 + 8px;
                background: AppPalette.text-primary;
            }

            drag-handle-ta := TouchArea {
                mouse-cursor: root.layout_exit_editor_dragging ? grabbing : grab;
                pointer-event(event) => {
                    if (event.button == PointerEventButton.left && event.kind == PointerEventKind.down) {
                        root.layout_exit_editor_dragging = true;
                        root.layout_exit_editor_drag_last_abs_x = root.layout_exit_editor_button_x + self.mouse-x;
                        root.layout_exit_editor_drag_last_abs_y = root.layout_exit_editor_button_y + self.mouse-y;
                    }
                    if (event.button == PointerEventButton.left
                            && (event.kind == PointerEventKind.up || event.kind == PointerEventKind.cancel)) {
                        root.layout_exit_editor_dragging = false;
                    }
                }
                moved => {
                    if (root.layout_exit_editor_dragging && self.pressed) {
                        let current-abs-x = root.layout_exit_editor_button_x + self.mouse-x;
                        let current-abs-y = root.layout_exit_editor_button_y + self.mouse-y;
                        let delta-x = current-abs-x - root.layout_exit_editor_drag_last_abs_x;
                        let delta-y = current-abs-y - root.layout_exit_editor_drag_last_abs_y;
                        root.layout_exit_editor_button_x = min(
                            max(0px, root.layout_exit_editor_button_x + delta-x),
                            max(0px, root.width - root.layout_exit_editor_button_width)
                        );
                        root.layout_exit_editor_button_y = min(
                            max(0px, root.layout_exit_editor_button_y + delta-y),
                            max(0px, root.height - root.layout_exit_editor_button_height)
                        );
                        root.layout_exit_editor_drag_last_abs_x = current-abs-x;
                        root.layout_exit_editor_drag_last_abs_y = current-abs-y;
                    }
                }
            }
        }

        exit-editor-chip := Rectangle {
            x: drag-handle-chip.width + 4px;
            y: 0px;
            width: max(0px, parent.width - self.x);
            height: parent.height;
            border-radius: 4px;
            border-width: 1px;
            border-color: AppPalette.warning;
            background: exit-editor-ta.has-hover
                ? AppPalette.warning.mix(AppPalette.panel-bg-elevated, 0.28)
                : AppPalette.warning.mix(AppPalette.panel-bg-elevated, 0.40);

            Text {
                text: "Exit editor";
                color: AppPalette.text-primary;
                font-size: 11px;
                font-weight: 700;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            exit-editor-ta := TouchArea {
                mouse-cursor: pointer;
                clicked => {
                    root.open_layout_editor();
                }
            }
        }
    }

    if root.show_layout_editor_dialog : Rectangle {
        background: AppPalette.overlay-scrim;
        z: 130;

        TouchArea {}

        Rectangle {
            width: min(root.width - 40px, 560px);
            height: min(root.height - 40px, 280px);
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            border-radius: 6px;
            background: AppPalette.panel-bg-elevated;
            border-width: 1px;
            border-color: AppPalette.border;

            VerticalLayout {
                padding: 16px;
                spacing: 12px;

                HorizontalLayout {
                    Text {
                        text: "Layout Edit Mode";
                        color: AppPalette.text-primary;
                        font-size: 16px;
                        font-weight: 700;
                        vertical-alignment: center;
                    }
                    Rectangle { horizontal-stretch: 1; }
                }

                Rectangle { height: 1px; background: AppPalette.separator; }

                Text {
                    text: "You are entering layout editing mode. Right-click a panel to replace, split, or delete it. Drag splitters to resize. Right-click a splitter for divider actions.";
                    color: AppPalette.text-secondary;
                    font-size: 12px;
                    wrap: word-wrap;
                }

                Rectangle { vertical-stretch: 1; }

                HorizontalLayout {
                    spacing: 8px;
                    Rectangle {
                        width: 16px;
                        height: 16px;
                        border-radius: 3px;
                        border-width: 1px;
                        border-color: AppPalette.border;
                        background: layout-intro-checkbox-ta.has-hover ? AppPalette.control-hover-bg : AppPalette.panel-bg-alt;
                        if root.layout_intro_dont_show_again : Image {
                            source: AppIcons.check;
                            width: 10px;
                            height: 10px;
                            x: (parent.width - self.width) / 2;
                            y: (parent.height - self.height) / 2;
                            image-fit: contain;
                            colorize: AppPalette.accent;
                        }
                        layout-intro-checkbox-ta := TouchArea {
                            clicked => {
                                root.layout_intro_dont_show_again = !root.layout_intro_dont_show_again;
                            }
                        }
                    }
                    Text {
                        text: "Don't show this again";
                        color: AppPalette.text-primary;
                        font-size: 12px;
                        vertical-alignment: center;
                    }
                    Rectangle { horizontal-stretch: 1; }
                }

                HorizontalLayout {
                    spacing: 10px;
                    Button {
                        text: "Go Back";
                        clicked => {
                            root.layout_intro_cancel(root.layout_intro_dont_show_again);
                            root.show_layout_editor_dialog = false;
                        }
                    }
                    Rectangle { horizontal-stretch: 1; }
                    Button {
                        text: "Start Editing";
                        primary: true;
                        clicked => {
                            root.layout_intro_proceed(root.layout_intro_dont_show_again);
                            root.show_layout_editor_dialog = false;
                        }
                    }
                }
            }
        }
    }

    if root.layout_edit_mode && root.show_layout_leaf_context_menu : Rectangle {
        z: 140;
        x: root.layout_leaf_context_menu_x;
        y: root.layout_leaf_context_menu_y;
        width: 236px;
        height: root.layout-selected-panel-has-settings() ? 142px : 116px;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: AppPalette.border;

        VerticalLayout {
            padding: 6px;
            spacing: 2px;

            Rectangle {
                height: 24px;
                border-radius: 3px;
                background: replace-action-ta.has-hover || root.show_layout_leaf_replace_submenu ? AppPalette.control-hover-bg : transparent;
                Text {
                    text: "Replace panel with";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    x: 8px;
                    vertical-alignment: center;
                }
                Image {
                    source: AppIcons.arrow-right;
                    width: 10px;
                    height: 10px;
                    x: parent.width - self.width - 8px;
                    y: (parent.height - self.height) / 2;
                    image-fit: contain;
                    colorize: AppPalette.text-muted;
                }
                replace-action-ta := TouchArea {
                    changed has-hover => {
                        if (self.has-hover) {
                            root.show_layout_leaf_replace_submenu = true;
                        }
                    }
                    moved => {
                        root.show_layout_leaf_replace_submenu = true;
                    }
                    clicked => {
                        root.show_layout_leaf_replace_submenu = true;
                    }
                }
            }

            Rectangle {
                height: 24px;
                border-radius: 3px;
                background: split-vertical-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    text: "Split panel vertically";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    x: 8px;
                    vertical-alignment: center;
                }
                split-vertical-ta := TouchArea {
                    clicked => {
                        root.layout_split_selected_leaf(1, root.layout_editor_split_panel_kind);
                        root.show_layout_leaf_replace_submenu = false;
                        root.layout_leaf_replace_submenu_hover = false;
                        root.show_layout_leaf_panels_submenu = false;
                        root.layout_leaf_panels_submenu_hover = false;
                        root.show_layout_leaf_presets_submenu = false;
                        root.layout_leaf_presets_submenu_hover = false;
                        root.show_layout_leaf_context_menu = false;
                    }
                }
            }

            Rectangle {
                height: 24px;
                border-radius: 3px;
                background: split-horizontal-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    text: "Split panel horizontally";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    x: 8px;
                    vertical-alignment: center;
                }
                split-horizontal-ta := TouchArea {
                    clicked => {
                        root.layout_split_selected_leaf(0, root.layout_editor_split_panel_kind);
                        root.show_layout_leaf_replace_submenu = false;
                        root.layout_leaf_replace_submenu_hover = false;
                        root.show_layout_leaf_panels_submenu = false;
                        root.layout_leaf_panels_submenu_hover = false;
                        root.show_layout_leaf_presets_submenu = false;
                        root.layout_leaf_presets_submenu_hover = false;
                        root.show_layout_leaf_context_menu = false;
                    }
                }
            }

            if root.layout-selected-panel-has-settings() : Rectangle {
                height: 24px;
                border-radius: 3px;
                background: panel-settings-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    text: "Panel Settings...";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    x: 8px;
                    vertical-alignment: center;
                }
                panel-settings-ta := TouchArea {
                    clicked => {
                        if root.layout_selected_leaf_index >= 0
                                && root.layout_selected_leaf_index < root.layout_leaf_ids.length {
                            let selected-panel-kind = root.layout-selected-panel-kind();
                            if (selected-panel-kind == root.panel_kind_button_cluster) {
                                root.open_control_cluster_menu_for_leaf(
                                    root.layout_leaf_ids[root.layout_selected_leaf_index],
                                    max(8, floor(root.layout_leaf_context_menu_x / 1px)),
                                    max(8, floor(root.layout_leaf_context_menu_y / 1px))
                                );
                            } else if (selected-panel-kind == root.panel_kind_playlist_switcher
                                    || selected-panel-kind == root.panel_kind_track_list) {
                                root.open_collection_panel_settings_for_leaf(
                                    root.layout_leaf_ids[root.layout_selected_leaf_index],
                                    selected-panel-kind,
                                    max(8, floor(root.layout_leaf_context_menu_x / 1px)),
                                    max(8, floor(root.layout_leaf_context_menu_y / 1px))
                                );
                            } else if (selected-panel-kind == root.panel_kind_metadata_viewer
                                    || selected-panel-kind == root.panel_kind_album_art_viewer) {
                                root.open_viewer_panel_settings_for_leaf(
                                    root.layout_leaf_ids[root.layout_selected_leaf_index],
                                    selected-panel-kind,
                                    max(8, floor(root.layout_leaf_context_menu_x / 1px)),
                                    max(8, floor(root.layout_leaf_context_menu_y / 1px))
                                );
                            }
                        }
                        root.show_layout_leaf_replace_submenu = false;
                        root.layout_leaf_replace_submenu_hover = false;
                        root.show_layout_leaf_panels_submenu = false;
                        root.layout_leaf_panels_submenu_hover = false;
                        root.show_layout_leaf_presets_submenu = false;
                        root.layout_leaf_presets_submenu_hover = false;
                        root.show_layout_leaf_context_menu = false;
                    }
                }
            }

            Rectangle {
                height: 1px;
                background: AppPalette.separator;
            }

            Rectangle {
                height: 24px;
                border-radius: 3px;
                background: delete-panel-ta.has-hover ? AppPalette.danger.mix(AppPalette.panel-bg, 0.82) : transparent;
                Text {
                    text: "Delete panel";
                    color: AppPalette.danger;
                    font-size: 12px;
                    x: 8px;
                    vertical-alignment: center;
                }
                delete-panel-ta := TouchArea {
                    clicked => {
                        root.layout_delete_selected_leaf();
                        root.show_layout_leaf_replace_submenu = false;
                        root.layout_leaf_replace_submenu_hover = false;
                        root.show_layout_leaf_panels_submenu = false;
                        root.layout_leaf_panels_submenu_hover = false;
                        root.show_layout_leaf_presets_submenu = false;
                        root.layout_leaf_presets_submenu_hover = false;
                        root.show_layout_leaf_context_menu = false;
                    }
                }
            }

        }

        if root.show_layout_leaf_replace_submenu : Rectangle {
            z: 141;
            x: (root.layout_leaf_context_menu_x + parent.width + 4px + self.width <= root.width - 8px) ? parent.width + 4px : -self.width - 4px;
            y: 6px;
            width: 268px;
            height: 92px;
            border-radius: 6px;
            background: AppPalette.panel-bg-elevated;
            border-width: 1px;
            border-color: AppPalette.border;

            submenu-hover-ta := TouchArea {
                changed has-hover => {
                    root.layout_leaf_replace_submenu_hover = self.has-hover;
                }
            }

            VerticalLayout {
                padding: 6px;
                spacing: 2px;
                Rectangle {
                    height: 24px;
                    border-radius: 3px;
                    background: spacer-action-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                    Text {
                        text: "Spacer";
                        color: AppPalette.text-primary;
                        font-size: 12px;
                        x: 8px;
                        vertical-alignment: center;
                    }
                    spacer-action-ta := TouchArea {
                        clicked => {
                            root.layout_editor_replace_panel_kind = root.panel_kind_spacer;
                            root.layout_replace_selected_leaf(10);
                            root.show_layout_leaf_replace_submenu = false;
                            root.layout_leaf_replace_submenu_hover = false;
                            root.show_layout_leaf_panels_submenu = false;
                            root.layout_leaf_panels_submenu_hover = false;
                            root.show_layout_leaf_presets_submenu = false;
                            root.layout_leaf_presets_submenu_hover = false;
                            root.show_layout_leaf_context_menu = false;
                        }
                    }
                }

                Rectangle {
                    height: 24px;
                    border-radius: 3px;
                    background: panels-action-ta.has-hover || root.show_layout_leaf_panels_submenu ? AppPalette.control-hover-bg : transparent;
                    Text {
                        text: "Panels";
                        color: AppPalette.text-primary;
                        font-size: 12px;
                        x: 8px;
                        vertical-alignment: center;
                    }
                    Image {
                        source: AppIcons.arrow-right;
                        width: 10px;
                        height: 10px;
                        x: parent.width - self.width - 8px;
                        y: (parent.height - self.height) / 2;
                        image-fit: contain;
                        colorize: AppPalette.text-muted;
                    }
                    panels-action-ta := TouchArea {
                        changed has-hover => {
                            if (self.has-hover) {
                                root.show_layout_leaf_panels_submenu = true;
                                root.show_layout_leaf_presets_submenu = false;
                            }
                        }
                        moved => {
                            root.show_layout_leaf_panels_submenu = true;
                            root.show_layout_leaf_presets_submenu = false;
                        }
                        clicked => {
                            root.show_layout_leaf_panels_submenu = true;
                            root.show_layout_leaf_presets_submenu = false;
                        }
                    }
                }

                Rectangle {
                    height: 24px;
                    border-radius: 3px;
                    background: presets-action-ta.has-hover || root.show_layout_leaf_presets_submenu ? AppPalette.control-hover-bg : transparent;
                    Text {
                        text: "Presets";
                        color: AppPalette.text-primary;
                        font-size: 12px;
                        x: 8px;
                        vertical-alignment: center;
                    }
                    Image {
                        source: AppIcons.arrow-right;
                        width: 10px;
                        height: 10px;
                        x: parent.width - self.width - 8px;
                        y: (parent.height - self.height) / 2;
                        image-fit: contain;
                        colorize: AppPalette.text-muted;
                    }
                    presets-action-ta := TouchArea {
                        changed has-hover => {
                            if (self.has-hover) {
                                root.show_layout_leaf_presets_submenu = true;
                                root.show_layout_leaf_panels_submenu = false;
                            }
                        }
                        moved => {
                            root.show_layout_leaf_presets_submenu = true;
                            root.show_layout_leaf_panels_submenu = false;
                        }
                        clicked => {
                            root.show_layout_leaf_presets_submenu = true;
                            root.show_layout_leaf_panels_submenu = false;
                        }
                    }
                }
            }

            if root.show_layout_leaf_panels_submenu : Rectangle {
                z: 142;
                x: (root.layout_leaf_context_menu_x + parent.x + parent.width + 4px + self.width <= root.width - 8px) ? parent.width + 4px : -self.width - 4px;
                y: 32px;
                width: 252px;
                height: max(
                    24px,
                    min(
                        min(220px, root.layout_panel_submenu_labels.length * 24px + 12px),
                        root.height - root.layout_leaf_context_menu_y - 54px
                    )
                );
                border-radius: 6px;
                background: AppPalette.panel-bg-elevated;
                border-width: 1px;
                border-color: AppPalette.border;

                VerticalLayout {
                    padding: 6px;
                    spacing: 0px;
                    ScrollView {
                        vertical-stretch: 1;
                        viewport-width: max(24px, parent.width - 8px);
                        viewport-height: max(24px, root.layout_panel_submenu_labels.length * 24px);
                        Rectangle {
                            x: 4px;
                            width: max(0px, parent.width - 8px);
                            height: max(24px, root.layout_panel_submenu_labels.length * 24px);
                            background: transparent;
                            for panel-option[index] in root.layout_panel_submenu_labels : Rectangle {
                                x: 0px;
                                y: index * 24px;
                                width: parent.width;
                                height: 24px;
                                border-radius: 3px;
                                background: panel-option-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                                Text {
                                    text: panel-option;
                                    color: AppPalette.text-primary;
                                    font-size: 12px;
                                    x: 10px;
                                    width: max(0px, parent.width - 20px);
                                    height: parent.height;
                                    overflow: elide;
                                    vertical-alignment: center;
                                    horizontal-alignment: left;
                                }
                                panel-option-ta := TouchArea {
                                    scroll-event(event) => {
                                        return EventResult.reject;
                                    }
                                    clicked => {
                                        let panel-code = root.layout_panel_submenu_codes[index];
                                        root.layout_editor_replace_panel_kind = panel-code;
                                        root.layout_replace_selected_leaf(panel-code);
                                        root.show_layout_leaf_replace_submenu = false;
                                        root.layout_leaf_replace_submenu_hover = false;
                                        root.show_layout_leaf_panels_submenu = false;
                                        root.layout_leaf_panels_submenu_hover = false;
                                        root.show_layout_leaf_presets_submenu = false;
                                        root.layout_leaf_presets_submenu_hover = false;
                                        root.show_layout_leaf_context_menu = false;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            if root.show_layout_leaf_presets_submenu : Rectangle {
                z: 142;
                x: (root.layout_leaf_context_menu_x + parent.x + parent.width + 4px + self.width <= root.width - 8px) ? parent.width + 4px : -self.width - 4px;
                y: 58px;
                width: 252px;
                height: max(
                    24px,
                    min(
                        min(360px, root.layout_replace_preset_labels.length * 24px + 12px),
                        root.height - root.layout_leaf_context_menu_y - 72px
                    )
                );
                border-radius: 6px;
                background: AppPalette.panel-bg-elevated;
                border-width: 1px;
                border-color: AppPalette.border;

                VerticalLayout {
                    padding: 6px;
                    spacing: 0px;
                    ScrollView {
                        vertical-stretch: 1;
                        viewport-width: max(24px, parent.width - 8px);
                        viewport-height: max(24px, root.layout_replace_preset_labels.length * 24px);
                        Rectangle {
                            x: 4px;
                            width: max(0px, parent.width - 8px);
                            height: max(24px, root.layout_replace_preset_labels.length * 24px);
                            background: transparent;
                            for preset-option[index] in root.layout_replace_preset_labels : Rectangle {
                                y: index * 24px;
                                width: parent.width;
                                height: 24px;
                                border-radius: 3px;
                                property <int> preset-code: index < root.layout_replace_preset_codes.length ? root.layout_replace_preset_codes[index] : -999;
                                property <bool> is-header: self.preset-code < 0;
                                background: self.is-header ? transparent : (preset-option-ta.has-hover ? AppPalette.control-hover-bg : transparent);
                                Text {
                                    text: preset-option;
                                    color: parent.is-header ? AppPalette.text-primary : AppPalette.text-primary;
                                    font-size: 12px;
                                    font-weight: parent.is-header ? 700 : 400;
                                    x: parent.is-header ? 8px : 18px;
                                    width: max(0px, parent.width - 20px);
                                    overflow: elide;
                                    vertical-alignment: center;
                                }
                                if self.is-header && preset-option != "" : Rectangle {
                                    x: 8px;
                                    y: parent.height - 1px;
                                    width: max(0px, parent.width - 16px);
                                    height: 1px;
                                    background: AppPalette.separator;
                                }
                                preset-option-ta := TouchArea {
                                    enabled: !parent.is-header;
                                    scroll-event(event) => {
                                        return EventResult.reject;
                                    }
                                    clicked => {
                                        let panel-code = parent.preset-code;
                                        root.layout_editor_replace_panel_kind = panel-code;
                                        root.layout_replace_selected_leaf(panel-code);
                                        root.show_layout_leaf_presets_submenu = false;
                                        root.layout_leaf_presets_submenu_hover = false;
                                        root.show_layout_leaf_panels_submenu = false;
                                        root.layout_leaf_panels_submenu_hover = false;
                                        root.show_layout_leaf_replace_submenu = false;
                                        root.layout_leaf_replace_submenu_hover = false;
                                        root.show_layout_leaf_context_menu = false;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    if root.layout_edit_mode && root.show_layout_splitter_context_menu : Rectangle {
        z: 140;
        x: root.layout_splitter_context_menu_x;
        y: root.layout_splitter_context_menu_y;
        width: 210px;
        height: 102px;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: AppPalette.border;

        VerticalLayout {
            padding: 10px;
            spacing: 8px;

            Text {
                text: "Divider Actions";
                color: AppPalette.text-primary;
                font-size: 13px;
                font-weight: 700;
            }
            Button {
                text: "Reset To 50 / 50";
                clicked => {
                    if (root.layout_context_splitter_id != "") {
                        root.commit_layout_splitter_ratio(root.layout_context_splitter_id, 0.5);
                    }
                    root.show_layout_splitter_context_menu = false;
                }
            }
            Button {
                text: "Undo";
                clicked => {
                    root.layout_undo_last_action();
                    root.show_layout_splitter_context_menu = false;
                }
            }
        }
    }

    if root.show_control_cluster_menu : Rectangle {
        z: 145;
        background: transparent;
        TouchArea {
            clicked => {
                root.show_control_cluster_menu = false;
            }
        }
    }

    if root.show_viewer_panel_settings_menu : Rectangle {
        z: 145;
        background: transparent;
        TouchArea {
            clicked => {
                root.show_viewer_panel_settings_menu = false;
                root.show_template_language_reference = false;
            }
        }
    }

    if root.show_collection_panel_settings_menu : Rectangle {
        z: 145;
        background: transparent;
        TouchArea {
            clicked => {
                root.show_collection_panel_settings_menu = false;
            }
        }
    }

    if root.show_viewer_panel_settings_menu : Rectangle {
        z: 146;
        x: root.viewer_panel_settings_x;
        y: root.viewer_panel_settings_y;
        width: 360px;
        height: root.viewer_panel_settings_target_panel_kind == root.panel_kind_metadata_viewer
            ? (root.viewer_panel_settings_metadata_source_index == 3 ? 304px : 126px)
            : 126px;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: AppPalette.border;

        VerticalLayout {
            alignment: start;
            padding: 10px;
            spacing: 8px;

            Text {
                text: (root.viewer_panel_settings_target_panel_kind == root.panel_kind_album_art_viewer
                    ? "Image Panel"
                    : "Text Panel") + " Settings";
                color: AppPalette.text-primary;
                font-size: 13px;
                font-weight: 700;
            }

            Rectangle { height: 1px; background: AppPalette.separator; }

            HorizontalLayout {
                spacing: 8px;
                label-host := Rectangle {
                    horizontal-stretch: 1;
                    height: 24px;
                    background: transparent;
                    Text {
                        text: "Display Priority";
                        color: AppPalette.text-primary;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: left;
                        width: parent.width;
                    }
                    label-tooltip-ta := TooltipHoverArea {
                        width: parent.width;
                        height: parent.height;
                        tooltip-text: "Balanced (Default): latest event wins (selection or playback).\nPrefer Selection: selection first, then now playing.\nPrefer Now Playing: now playing first, then selection.\nSelection Only: only selection is shown.\nNow Playing Only: only now playing is shown.";
                        tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                            root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                        }
                    }
                }
                Rectangle {
                    width: 190px;
                    height: 30px;
                    ComboBox {
                        width: parent.width;
                        height: parent.height;
                        model: root.viewer_panel_display_priority_options;
                        current-index <=> root.viewer_panel_settings_display_priority_index;
                        selected(_) => {
                            root.set_viewer_panel_display_priority(
                                root.viewer_panel_settings_target_leaf_id,
                                root.viewer_panel_settings_display_priority_index
                            );
                        }
                    }
                }
            }

            if root.viewer_panel_settings_target_panel_kind == root.panel_kind_metadata_viewer : HorizontalLayout {
                spacing: 8px;
                Rectangle {
                    horizontal-stretch: 1;
                    height: 24px;
                    background: transparent;
                    Text {
                        text: "Text Source";
                        color: AppPalette.text-primary;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: left;
                        width: parent.width;
                    }
                }
                Rectangle {
                    width: 190px;
                    height: 30px;
                    ComboBox {
                        width: parent.width;
                        height: parent.height;
                        model: root.viewer_panel_metadata_source_options;
                        current-index <=> root.viewer_panel_settings_metadata_source_index;
                        selected(_) => {
                            root.set_viewer_panel_metadata_source(
                                root.viewer_panel_settings_target_leaf_id,
                                root.viewer_panel_settings_metadata_source_index
                            );
                        }
                    }
                }
            }

            if root.viewer_panel_settings_target_panel_kind == root.panel_kind_metadata_viewer
                    && root.viewer_panel_settings_metadata_source_index == 3 : VerticalLayout {
                spacing: 6px;
                Rectangle {
                    height: 24px;
                    background: transparent;
                    HorizontalLayout {
                        spacing: 8px;
                        Text {
                            horizontal-stretch: 1;
                            text: "Custom Text Format";
                            color: AppPalette.text-primary;
                            font-size: 12px;
                            vertical-alignment: center;
                            horizontal-alignment: left;
                        }
                        Button {
                            width: 28px;
                            text: "?";
                            clicked => {
                                root.show_template_language_reference = true;
                            }
                        }
                    }
                }
                Rectangle {
                    height: 138px;
                    background: transparent;
                    TextEdit {
                        width: parent.width;
                        height: parent.height;
                        enabled: true;
                        wrap: word-wrap;
                        text: root.viewer_panel_settings_metadata_text_format;
                        placeholder-text: "[size=title][b]{title}[/b][/size]\\n[size=body]{artist}[/size]\\n[size=body]{album}[/size]\\n[size=caption]{date;year} • {genre}[/size]";
                        edited => {
                            root.viewer_panel_settings_metadata_text_format = self.text;
                            root.set_viewer_panel_metadata_text_format(
                                root.viewer_panel_settings_target_leaf_id,
                                self.text
                            );
                        }
                    }
                }
            }

            if root.viewer_panel_settings_target_panel_kind == root.panel_kind_album_art_viewer : HorizontalLayout {
                spacing: 8px;
                Rectangle {
                    horizontal-stretch: 1;
                    height: 24px;
                    background: transparent;
                    Text {
                        text: "Image Source";
                        color: AppPalette.text-primary;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: left;
                        width: parent.width;
                    }
                }
                Rectangle {
                    width: 190px;
                    height: 30px;
                    ComboBox {
                        width: parent.width;
                        height: parent.height;
                        model: root.viewer_panel_image_source_options;
                        current-index <=> root.viewer_panel_settings_image_source_index;
                        selected(_) => {
                            root.set_viewer_panel_image_source(
                                root.viewer_panel_settings_target_leaf_id,
                                root.viewer_panel_settings_image_source_index
                            );
                        }
                    }
                }
            }
        }
    }

    if root.show_collection_panel_settings_menu : Rectangle {
        z: 146;
        x: root.collection_panel_settings_x;
        y: root.collection_panel_settings_y;
        width: 320px;
        height: 98px;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: AppPalette.border;

        VerticalLayout {
            alignment: start;
            padding: 10px;
            spacing: 8px;

            Text {
                text: (root.collection_panel_settings_target_panel_kind == root.panel_kind_track_list
                    ? "Track List"
                    : "Collection Panel") + " Settings";
                color: AppPalette.text-primary;
                font-size: 13px;
                font-weight: 700;
            }

            Rectangle { height: 1px; background: AppPalette.separator; }

            HorizontalLayout {
                spacing: 8px;
                Rectangle {
                    horizontal-stretch: 1;
                    height: 24px;
                    background: transparent;
                    Text {
                        text: "Mode";
                        color: AppPalette.text-primary;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: left;
                        width: parent.width;
                    }
                }
                Rectangle {
                    width: 190px;
                    height: 30px;
                    ComboBox {
                        width: parent.width;
                        height: parent.height;
                        model: root.collection_panel_mode_options;
                        current-index <=> root.collection_panel_settings_mode_index;
                        selected(_) => {
                            root.set_collection_panel_mode(
                                root.collection_panel_settings_target_leaf_id,
                                root.collection_panel_settings_mode_index
                            );
                        }
                    }
                }
            }
        }
    }

    if root.show_settings_menu : Rectangle {
        z: 147;
        background: transparent;
        TouchArea {
            clicked => {
                root.show_settings_menu = false;
            }
        }
    }

    if root.show_settings_menu : Rectangle {
        z: 148;
        x: root.settings_menu_x;
        y: root.settings_menu_y;
        width: 210px;
        height: 70px;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: root.theme_border;

        VerticalLayout {
            padding: 4px;
            spacing: 2px;

            Rectangle {
                height: 28px;
                border-radius: 4px;
                background: layout-edit-toggle-ta.has-hover
                    ? AppPalette.control-hover-bg
                    : transparent;
                HorizontalLayout {
                    padding-left: 10px;
                    padding-right: 10px;
                    spacing: 6px;
                    Text {
                        text: "Layout Editing Mode";
                        color: root.theme_text_primary;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-stretch: 1;
                        overflow: elide;
                    }
                    quick-layout-toggle := Switch {
                        width: 36px;
                        text: "";
                        checked: root.layout_edit_mode;
                        toggled => {
                            root.show_settings_menu = false;
                            root.open_layout_editor();
                        }
                    }
                }
                layout-edit-toggle-ta := TouchArea {
                    clicked => {
                        quick-layout-toggle.checked = !quick-layout-toggle.checked;
                        root.show_settings_menu = false;
                        root.open_layout_editor();
                    }
                }
            }

            Rectangle {
                height: 28px;
                border-radius: 4px;
                background: open-settings-ta.has-hover
                    ? AppPalette.control-hover-bg
                    : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Settings";
                    color: root.theme_text_primary;
                    font-size: 12px;
                    vertical-alignment: center;
                }
                open-settings-ta := TouchArea {
                    clicked => {
                        root.show_settings_menu = false;
                        root.open_settings();
                    }
                }
            }
        }
    }

    if root.show_library_folder_menu : Rectangle {
        z: 149;
        background: transparent;
        TouchArea {
            clicked => {
                root.show_library_folder_menu = false;
            }
        }
    }

    if root.show_cast_menu : Rectangle {
        z: 149;
        background: transparent;
        TouchArea {
            clicked => {
                root.show_cast_menu = false;
            }
        }
    }

    if root.show_cast_menu : Rectangle {
        z: 150;
        x: root.cast_menu_x;
        y: root.cast_menu_y;
        width: 300px;
        height: 250px;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: root.theme_border;

        VerticalLayout {
            padding: 8px;
            spacing: 6px;

            Text {
                text: "Cast";
                color: root.theme_text_primary;
                font-size: 13px;
                font-weight: 700;
            }

            Text {
                text: root.cast_connection_label;
                color: root.theme_text_muted;
                font-size: 11px;
                overflow: elide;
            }

            Rectangle { height: 1px; background: root.theme_border; }

            ScrollView {
                vertical-stretch: 1;
                VerticalLayout {
                    spacing: 2px;
                    if root.cast_device_names.length == 0 : Rectangle {
                        height: 28px;
                        Text {
                            x: 8px;
                            width: parent.width - 16px;
                            text: "No cast devices found";
                            color: root.theme_text_muted;
                            font-size: 11px;
                            vertical-alignment: center;
                            overflow: elide;
                        }
                    }
                    for cast-device-label[index] in root.cast_device_names : Rectangle {
                        height: 26px;
                        border-radius: 4px;
                        background: cast-device-ta.has-hover
                            ? AppPalette.control-hover-bg
                            : transparent;
                        Text {
                            x: 8px;
                            width: parent.width - 16px;
                            text: cast-device-label;
                            color: root.theme_text_primary;
                            font-size: 11px;
                            vertical-alignment: center;
                            overflow: elide;
                        }
                        cast-device-ta := TouchArea {
                            clicked => {
                                if index < root.cast_device_ids.length {
                                    root.cast_connect_device(root.cast_device_ids[index]);
                                }
                            }
                        }
                    }
                }
            }

            Rectangle { height: 1px; background: root.theme_border; }

            HorizontalLayout {
                spacing: 8px;
                Button {
                    text: "Refresh";
                    clicked => { root.cast_refresh_devices(); }
                }
                Button {
                    text: "Disconnect";
                    enabled: root.cast_connected || root.cast_connecting;
                    clicked => { root.cast_disconnect(); }
                }
                Rectangle { horizontal-stretch: 1; }
                Button {
                    text: "Close";
                    clicked => { root.show_cast_menu = false; }
                }
            }
        }
    }

    if root.show_library_folder_menu : Rectangle {
        z: 150;
        x: root.library_folder_menu_x;
        y: root.library_folder_menu_y;
        width: root.library_folder_menu_width;
        height: root.library_folder_menu_height;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: root.theme_border;

        VerticalLayout {
            padding: 4px;
            spacing: 2px;

            Rectangle {
                height: 28px;
                border-radius: 4px;
                background: library-menu-add-folder-ta.has-hover
                    ? AppPalette.control-hover-bg
                    : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Add folder";
                    color: root.theme_text_primary;
                    font-size: 12px;
                    vertical-alignment: center;
                }
                library-menu-add-folder-ta := TouchArea {
                    clicked => {
                        root.show_library_folder_menu = false;
                        root.library_add_folder();
                    }
                }
            }

            Rectangle {
                height: 28px;
                border-radius: 4px;
                background: library-menu-configure-folders-ta.has-hover
                    ? AppPalette.control-hover-bg
                    : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Configure folders ...";
                    color: root.theme_text_primary;
                    font-size: 12px;
                    vertical-alignment: center;
                }
                library-menu-configure-folders-ta := TouchArea {
                    clicked => {
                        root.show_library_folder_menu = false;
                        root.open_settings();
                        root.settings_dialog_tab_index = 2;
                    }
                }
            }
        }
    }

    if root.show_import_menu : Rectangle {
        z: 149;
        background: transparent;
        TouchArea {
            clicked => {
                root.show_import_menu = false;
            }
        }
    }

    if root.show_import_menu : Rectangle {
        z: 150;
        x: root.import_menu_x;
        y: root.import_menu_y;
        width: root.import_menu_width;
        height: root.import_menu_height;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: AppPalette.border;

        VerticalLayout {
            padding: 4px;
            spacing: 2px;

            Rectangle {
                height: 28px;
                border-radius: 4px;
                background: add-files-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Add files";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    vertical-alignment: center;
                }
                add-files-ta := TouchArea {
                    clicked => {
                        root.show_import_menu = false;
                        root.open_file();
                    }
                }
            }

            Rectangle {
                height: 28px;
                border-radius: 4px;
                background: add-folder-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Add folders";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    vertical-alignment: center;
                }
                add-folder-ta := TouchArea {
                    clicked => {
                        root.show_import_menu = false;
                        root.open_folder();
                    }
                }
            }

            Rectangle {
                height: 28px;
                border-radius: 4px;
                background: create-playlist-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Create new playlist";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    vertical-alignment: center;
                }
                create-playlist-ta := TouchArea {
                    clicked => {
                        root.show_import_menu = false;
                        root.create_playlist();
                    }
                }
            }
        }
    }

    if root.show_playlist_track_context_menu : Rectangle {
        z: 151;
        background: transparent;
        TouchArea {
            clicked => {
                root.show_playlist_track_context_menu = false;
            }
        }
    }

    if root.show_playlist_track_context_menu : Rectangle {
        z: 152;
        x: root.playlist_track_context_menu_x;
        y: root.playlist_track_context_menu_y;
        width: 170px;
        height: root.context-menu-height;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: AppPalette.border;

        VerticalLayout {
            padding: 4px;
            spacing: 2px;
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: playlist-properties-ta.has-hover && root.playlist_properties_enabled ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Properties";
                    color: root.playlist_properties_enabled ? AppPalette.text-primary : AppPalette.text-disabled;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                playlist-properties-ta := TouchArea {
                    enabled: root.playlist_properties_enabled;
                    clicked => {
                        root.show_playlist_track_context_menu = false;
                        root.open_properties_for_current_selection();
                    }
                }
            }
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: playlist-open-location-ta.has-hover && root.playlist_properties_enabled ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Open File Location";
                    color: root.playlist_properties_enabled ? AppPalette.text-primary : AppPalette.text-disabled;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                playlist-open-location-ta := TouchArea {
                    enabled: root.playlist_properties_enabled;
                    clicked => {
                        root.show_playlist_track_context_menu = false;
                        root.open_file_location();
                    }
                }
            }
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: playlist-cut-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Cut";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                playlist-cut-ta := TouchArea {
                    clicked => {
                        root.show_playlist_track_context_menu = false;
                        root.cut_selected_tracks();
                    }
                }
            }
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: playlist-copy-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Copy";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                playlist-copy-ta := TouchArea {
                    clicked => {
                        root.show_playlist_track_context_menu = false;
                        root.copy_selected_tracks();
                    }
                }
            }
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: playlist-paste-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Paste";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                playlist-paste-ta := TouchArea {
                    clicked => {
                        root.show_playlist_track_context_menu = false;
                        root.paste_copied_tracks();
                    }
                }
            }
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: playlist-delete-ta.has-hover ? AppPalette.danger.mix(AppPalette.panel-bg, 0.82) : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Delete";
                    color: AppPalette.danger;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                playlist-delete-ta := TouchArea {
                    clicked => {
                        root.show_playlist_track_context_menu = false;
                        root.delete_selected_tracks();
                    }
                }
            }
        }
    }

    if root.show_library_context_menu : Rectangle {
        z: 153;
        background: transparent;
        TouchArea {
            clicked => {
                root.show_library_context_menu = false;
            }
        }
    }

    if root.show_library_context_menu : Rectangle {
        z: 154;
        x: root.library_context_menu_x;
        y: root.library_context_menu_y;
        width: 190px;
        height: root.context-menu-height;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: AppPalette.border;

        VerticalLayout {
            padding: 4px;
            spacing: 2px;
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: library-properties-ta.has-hover && root.library_properties_enabled ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Properties";
                    color: root.library_properties_enabled ? AppPalette.text-primary : AppPalette.text-disabled;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                library-properties-ta := TouchArea {
                    enabled: root.library_properties_enabled;
                    clicked => {
                        root.show_library_context_menu = false;
                        root.open_properties_for_current_selection();
                    }
                }
            }
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: library-open-location-ta.has-hover && root.library_properties_enabled ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Open File Location";
                    color: root.library_properties_enabled ? AppPalette.text-primary : AppPalette.text-disabled;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                library-open-location-ta := TouchArea {
                    enabled: root.library_properties_enabled;
                    clicked => {
                        root.show_library_context_menu = false;
                        root.open_file_location();
                    }
                }
            }
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: add-to-playlists-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Add to playlists...";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                add-to-playlists-ta := TouchArea {
                    clicked => {
                        root.show_library_context_menu = false;
                        root.library_prepare_add_to_playlists();
                    }
                }
            }
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: library-cut-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Cut";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                library-cut-ta := TouchArea {
                    clicked => {
                        root.show_library_context_menu = false;
                        root.cut_selected_tracks();
                    }
                }
            }
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: library-copy-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Copy";
                    color: AppPalette.text-primary;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                library-copy-ta := TouchArea {
                    clicked => {
                        root.show_library_context_menu = false;
                        root.copy_selected_tracks();
                    }
                }
            }
            Rectangle {
                height: 24px;
                border-radius: 4px;
                background: library-delete-ta.has-hover ? AppPalette.danger.mix(AppPalette.panel-bg, 0.82) : transparent;
                Text {
                    x: 10px;
                    width: parent.width - 20px;
                    text: "Remove from library";
                    color: AppPalette.danger;
                    font-size: 12px;
                    vertical-alignment: center;
                    overflow: elide;
                }
                library-delete-ta := TouchArea {
                    clicked => {
                        root.show_library_context_menu = false;
                        root.delete_selected_tracks();
                    }
                }
            }
        }
    }

    if root.library_add_to_dialog_visible : Rectangle {
        z: 155;
        background: AppPalette.overlay-scrim;
        TouchArea {
            clicked => {
                root.library_cancel_add_to_playlists();
            }
        }
    }

    if root.library_add_to_dialog_visible : Rectangle {
        z: 156;
        width: min(root.width - 24px, 460px);
        height: min(root.height - 24px, 420px);
        x: (root.width - self.width) / 2;
        y: (root.height - self.height) / 2;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: AppPalette.border;

        VerticalLayout {
            padding: 14px;
            spacing: 10px;

            Text {
                text: "Add To Playlists";
                color: AppPalette.text-primary;
                font-size: 15px;
                font-weight: 700;
            }

            Text {
                text: root.library_selected_count == 1
                    ? "1 library item selected"
                    : root.library_selected_count + " library items selected";
                color: AppPalette.text-muted;
                font-size: 11px;
            }

            Rectangle { height: 1px; background: AppPalette.separator; }

            ScrollView {
                vertical-stretch: 1;
                VerticalLayout {
                    alignment: start;
                    spacing: 2px;
                    for playlist-label[index] in root.library_add_to_playlist_labels : playlist-option-row := Rectangle {
                        property <bool> row-checked: index < root.library_add_to_playlist_checked.length
                            ? root.library_add_to_playlist_checked[index]
                            : false;
                        height: 28px;
                        border-radius: 3px;
                        background: playlist-option-ta.has-hover ? AppPalette.control-hover-bg : transparent;
                        HorizontalLayout {
                            padding-left: 8px;
                            padding-right: 8px;
                            spacing: 8px;
                            playlist-toggle := Switch {
                                width: 36px;
                                text: "";
                                checked: playlist-option-row.row-checked;
                                toggled => {
                                    root.library_toggle_add_to_playlist(index);
                                }
                            }
                            Text {
                                text: playlist-label;
                                color: AppPalette.text-primary;
                                font-size: 12px;
                                vertical-alignment: center;
                                overflow: elide;
                                horizontal-stretch: 1;
                            }
                        }
                        playlist-option-ta := TouchArea {
                            x: 30px;
                            width: parent.width - 30px;
                            clicked => {
                                root.library_toggle_add_to_playlist(index);
                            }
                        }
                    }
                }
            }

            Rectangle { height: 1px; background: AppPalette.separator; }

            HorizontalLayout {
                spacing: 10px;
                Rectangle { horizontal-stretch: 1; }
                Button {
                    text: "Cancel";
                    clicked => {
                        root.library_cancel_add_to_playlists();
                    }
                }
                Button {
                    text: "Add";
                    enabled: root.library_add_to_confirm_enabled;
                    primary: true;
                    clicked => {
                        root.library_add_to_dialog_visible = false;
                        root.library_confirm_add_to_playlists();
                    }
                }
            }
        }
    }

    if root.show_control_cluster_menu : Rectangle {
        z: 146;
        x: root.control_cluster_menu_x;
        y: root.control_cluster_menu_y;
        width: 300px;
        height: 340px;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: AppPalette.border;

        VerticalLayout {
            padding: 10px;
            spacing: 8px;

            Text {
                text: root.control-cluster-label() + " Buttons";
                color: AppPalette.text-primary;
                font-size: 13px;
                font-weight: 700;
            }

            Rectangle { height: 1px; background: AppPalette.separator; }

            ScrollView {
                vertical-stretch: 1;
                HorizontalLayout {
                    Rectangle {
                        width: 1px;
                    }
                    VerticalLayout {
                        spacing: 2px;

                        Rectangle {
                            height: max(22px, root.control_cluster_menu_actions.length * 24px);
                            background: transparent;
                            VerticalLayout {
                                spacing: 2px;
                                for action-id[index] in root.control_cluster_menu_actions : Rectangle {
                                    height: 22px;
                                    border-radius: 2px;
                                    background: transparent;
                                    HorizontalLayout {
                                        padding-left: 6px;
                                        padding-right: 4px;
                                        spacing: 8px;
                                        Text {
                                            text: root.control-action-label(action-id);
                                            color: AppPalette.text-primary;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                            horizontal-stretch: 1;
                                            overflow: elide;
                                        }
                                        Rectangle {
                                            width: 18px;
                                            height: 18px;
                                            border-radius: 2px;
                                            background: delete-action-ta.has-hover ? AppPalette.danger.mix(AppPalette.panel-bg, 0.82) : transparent;
                                            Image {
                                                source: AppIcons.close;
                                                width: 10px;
                                                height: 10px;
                                                x: (parent.width - self.width) / 2;
                                                y: (parent.height - self.height) / 2;
                                                image-fit: contain;
                                                colorize: AppPalette.danger;
                                            }
                                            delete-action-ta := TouchArea {
                                                clicked => {
                                                    if root.control_cluster_menu_target_leaf_id != "" {
                                                        root.remove_control_cluster_button(
                                                            root.control_cluster_menu_target_leaf_id,
                                                            index
                                                        );
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    Rectangle {
                        width: 1px;
                    }
                }
            }

            Rectangle { height: 1px; background: AppPalette.separator; }

            HorizontalLayout {
                spacing: 8px;
                Rectangle {
                    horizontal-stretch: 1;
                    height: 32px;
                    ComboBox {
                        width: parent.width;
                        height: parent.height;
                        model: [
                            "Import (+)",
                            "Back",
                            "Play",
                            "Pause",
                            "Stop",
                            "Next",
                            "Shuffle",
                            "Repeat",
                            "Layout Editor",
                            "Settings",
                            "Cast",
                            "Favorite"
                        ];
                        current-index <=> root.control_cluster_add_option_index;
                    }
                }
                Button {
                    text: "Add";
                    clicked => {
                        root.add_control_cluster_button(
                            root.control_cluster_menu_target_leaf_id,
                            root.control_cluster_add_option_index + 1
                        );
                    }
                }
            }
        }
    }

    // Modal overlay for confirmation
    confirm_overlay := ConfirmationDialog {
        is-visible: root.show_confirm_dialog;
        message: root.delete_confirm_message;
        confirmed => {
            root.delete_playlist(root.delete_target_index);
            root.show_confirm_dialog = false;
            root.refocus_main();
        }
        cancelled => {
            root.show_confirm_dialog = false;
            root.refocus_main();
        }
    }

    remote_detach_overlay := ConfirmationDialog {
        is-visible: root.show_remote_detach_confirm;
        message: root.remote_detach_confirm_message;
        confirm-button-text: "Detach";
        confirmed => {
            root.remote_detach_confirm(root.remote_detach_target_playlist_id);
            root.show_remote_detach_confirm = false;
            root.refocus_main();
        }
        cancelled => {
            root.remote_detach_cancel(root.remote_detach_target_playlist_id);
            root.show_remote_detach_confirm = false;
            root.refocus_main();
        }
    }

    apply_filter_view_overlay := ConfirmationDialog {
        is-visible: root.show_apply_filter_view_confirm;
        message: root.apply_filter_view_confirm_message;
        confirm-button-text: "Overwrite";
        confirmed => {
            root.apply_filter_view_to_playlist();
            root.show_apply_filter_view_confirm = false;
            root.refocus_main();
        }
        cancelled => {
            root.show_apply_filter_view_confirm = false;
            root.refocus_main();
        }
    }

    library_remove_overlay := ConfirmationDialog {
        is-visible: root.show_library_remove_confirm;
        message: root.library_remove_confirm_message;
        confirm-button-text: "Remove";
        confirmed => {
            root.library_confirm_remove_selection();
            root.show_library_remove_confirm = false;
            root.refocus_main();
        }
        cancelled => {
            root.library_cancel_remove_selection();
            root.show_library_remove_confirm = false;
            root.refocus_main();
        }
    }

    custom_column_delete_overlay := ConfirmationDialog {
        is-visible: root.show_delete_custom_column_confirm;
        message: root.delete_custom_column_message;
        confirmed => {
            root.delete_custom_playlist_column(root.delete_custom_column_index);
            root.show_delete_custom_column_confirm = false;
            root.delete_custom_column_index = -1;
            root.refocus_main();
        }
        cancelled => {
            root.show_delete_custom_column_confirm = false;
            root.delete_custom_column_index = -1;
            root.refocus_main();
        }
    }

    restart_notice_overlay := InfoDialog {
        is-visible: root.show_settings_restart_notice;
        title: "Restart Required";
        message: root.settings_restart_notice_message;
        dismissed => {
            root.show_settings_restart_notice = false;
            root.refocus_main();
        }
    }

    subsonic_keyring_notice_overlay := InfoDialog {
        is-visible: root.show_subsonic_keyring_notice;
        title: "OpenSubsonic Credential Store Unavailable";
        message: root.subsonic_keyring_notice_message;
        dismissed => {
            root.show_subsonic_keyring_notice = false;
            root.refocus_main();
        }
    }

    if root.show_subsonic_session_password_prompt : Rectangle {
        background: AppPalette.overlay-scrim;
        z: 112;

        TouchArea {}

        Rectangle {
            width: min(root.width - 40px, 520px);
            height: 300px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            border-radius: 6px;
            background: AppPalette.panel-bg-elevated;
            border-width: 1px;
            border-color: AppPalette.border;

            VerticalLayout {
                padding: 16px;
                spacing: 10px;

                HorizontalLayout {
                    spacing: 10px;

                    Rectangle {
                        width: 36px;
                        height: 36px;
                        border-radius: 18px;
                        background: AppPalette.accent-soft-bg;
                        border-width: 1px;
                        border-color: AppPalette.accent-soft-border;
                        Image {
                            source: AppIcons.opensubsonic;
                            width: 18px;
                            height: 18px;
                            x: (parent.width - self.width) / 2;
                            y: (parent.height - self.height) / 2;
                            image-fit: contain;
                            colorize: AppPalette.accent;
                        }
                    }

                    VerticalLayout {
                        spacing: 2px;
                        Text {
                            text: "OpenSubsonic Session Sign-In";
                            color: root.theme_text_primary;
                            font-size: 16px;
                            font-weight: 700;
                        }
                        Text {
                            text: root.subsonic_session_prompt_endpoint;
                            color: root.theme_text_secondary;
                            font-size: 11px;
                            wrap: word-wrap;
                        }
                    }
                }

                Text {
                    text: "System keyring is unavailable. Enter your password to use OpenSubsonic for this session only.";
                    color: root.theme_text_secondary;
                    font-size: 12px;
                    wrap: word-wrap;
                }

                HorizontalLayout {
                    spacing: 10px;
                    Text {
                        text: "Username";
                        width: 110px;
                        color: root.theme_text_primary;
                        font-size: 12px;
                        vertical-alignment: center;
                    }
                    Text {
                        text: root.subsonic_session_prompt_username;
                        color: root.theme_text_primary;
                        font-size: 12px;
                        vertical-alignment: center;
                        wrap: word-wrap;
                    }
                }

                HorizontalLayout {
                    spacing: 10px;
                    Text {
                        text: "Password";
                        width: 110px;
                        color: root.theme_text_primary;
                        font-size: 12px;
                        vertical-alignment: center;
                    }
                    subsonic-session-password-input := LineEdit {
                        text <=> root.subsonic_session_prompt_password;
                        input-type: password;
                        placeholder-text: "session only";
                        accepted => {
                            root.subsonic_session_password_submit(root.subsonic_session_prompt_password);
                        }
                    }
                }

                Text {
                    text: root.subsonic_session_prompt_status;
                    color: AppPalette.warning;
                    font-size: 11px;
                    wrap: word-wrap;
                    vertical-stretch: 1;
                }

                HorizontalLayout {
                    spacing: 10px;
                    Rectangle { horizontal-stretch: 1; }
                    Button {
                        text: "Not Now";
                        clicked => {
                            root.subsonic_session_password_cancel();
                        }
                    }
                    Button {
                        text: "Continue";
                        primary: true;
                        clicked => {
                            root.subsonic_session_password_submit(root.subsonic_session_prompt_password);
                        }
                    }
                }
            }
        }
    }

    if root.show_custom_column_dialog : Rectangle {
        background: AppPalette.overlay-scrim;
        z: 110;

        TouchArea {}

        Rectangle {
            width: min(root.width - 40px, 560px);
            height: min(root.height - 40px, 420px);
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            border-radius: 6px;
            background: AppPalette.panel-bg-elevated;
            border-width: 1px;
            border-color: AppPalette.border;

            VerticalLayout {
                padding: 16px;
                spacing: 10px;

                Text {
                    text: "Custom Playlist Column";
                    color: AppPalette.text-primary;
                    font-size: 16px;
                    font-weight: 700;
                }

                Text {
                    text: "Column Name";
                    color: AppPalette.text-secondary;
                    font-size: 12px;
                }

                LineEdit {
                    text <=> root.custom_column_name;
                    placeholder-text: "Example: Album & Year";
                }

                Text {
                    text: "Format String";
                    color: AppPalette.text-secondary;
                    font-size: 12px;
                }

                HorizontalLayout {
                    spacing: 8px;
                    Rectangle { horizontal-stretch: 1; }
                    Button {
                        width: 28px;
                        text: "?";
                        clicked => {
                            root.show_template_language_reference = true;
                        }
                    }
                }

                Rectangle {
                    height: 112px;
                    background: transparent;
                    TextEdit {
                        width: parent.width;
                        height: parent.height;
                        wrap: word-wrap;
                        text <=> root.custom_column_format;
                        placeholder-text: "Example: [size=body]{album}[/size]\\n[size=caption]{year} - {genre}[/size]";
                    }
                }

                Rectangle { vertical-stretch: 1; }

                HorizontalLayout {
                    spacing: 10px;
                    Rectangle { horizontal-stretch: 1; }
                    Button {
                        text: "Cancel";
                        clicked => {
                            root.show_custom_column_dialog = false;
                            root.show_template_language_reference = false;
                        }
                    }
                    Button {
                        text: "Add";
                        primary: true;
                        clicked => {
                            root.add_custom_playlist_column(root.custom_column_name, root.custom_column_format);
                            root.show_custom_column_dialog = false;
                            root.show_template_language_reference = false;
                        }
                    }
                }
            }
        }
    }

    if root.show_template_language_reference : Rectangle {
        z: 170;
        width: min(root.width - 24px, 560px);
        height: min(root.height - 24px, 460px);
        x: max(12px, root.width - self.width - 12px);
        y: 12px;
        border-radius: 6px;
        background: AppPalette.panel-bg-elevated;
        border-width: 1px;
        border-color: AppPalette.border;

        VerticalLayout {
            padding: 12px;
            spacing: 8px;

            HorizontalLayout {
                spacing: 10px;
                Text {
                    horizontal-stretch: 1;
                    text: "Template Reference";
                    color: AppPalette.text-primary;
                    font-size: 14px;
                    font-weight: 700;
                    vertical-alignment: center;
                    horizontal-alignment: left;
                }
                Button {
                    text: "Close";
                    clicked => {
                        root.show_template_language_reference = false;
                    }
                }
            }

            Rectangle { height: 1px; background: AppPalette.separator; }

            ScrollView {
                vertical-stretch: 1;
                Rectangle {
                    background: transparent;
                    width: max(parent.width - 12px, 0px);
                    Text {
                        width: parent.width;
                        text: root.template_language_reference_text;
                        color: AppPalette.text-primary;
                        font-size: 12px;
                        wrap: word-wrap;
                    }
                }
            }
        }
    }

    if root.show_properties_dialog : Rectangle {
        background: AppPalette.overlay-scrim;
        z: 111;

        TouchArea {
            clicked => {
                if (!root.properties_busy) {
                    root.properties_cancel();
                }
            }
        }

        properties-dialog-panel := Rectangle {
            z: 1;
            width: min(root.width - 40px, 760px);
            height: min(root.height - 40px, 560px);
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            border-radius: 6px;
            background: AppPalette.panel-bg-elevated;
            border-width: 1px;
            border-color: AppPalette.border;

            // Consume clicks in the panel body so backdrop click handling only applies outside.
            TouchArea {}

            VerticalLayout {
                padding: 16px;
                spacing: 10px;

                HorizontalLayout {
                    Text {
                        text: "Properties";
                        color: AppPalette.text-primary;
                        font-size: 16px;
                        font-weight: 700;
                    }
                    Rectangle { horizontal-stretch: 1; }
                    if root.properties_busy : Text {
                        text: "Working...";
                        color: AppPalette.text-secondary;
                        font-size: 11px;
                        vertical-alignment: center;
                    }
                }

                Text {
                    text: root.properties_target_title;
                    color: AppPalette.text-secondary;
                    font-size: 12px;
                    overflow: elide;
                }

                Rectangle {
                    height: 28px;
                    border-radius: 4px;
                    background: AppPalette.panel-bg-alt;
                    HorizontalLayout {
                        padding-left: 8px;
                        padding-right: 10px;
                        spacing: 8px;
                        Text {
                            width: 220px;
                            text: "Field";
                            color: AppPalette.text-primary;
                            font-size: 12px;
                            font-weight: 700;
                            vertical-alignment: center;
                            overflow: elide;
                        }
                        Text {
                            text: "Value";
                            color: AppPalette.text-primary;
                            font-size: 12px;
                            font-weight: 700;
                            horizontal-stretch: 1;
                            vertical-alignment: center;
                            overflow: elide;
                        }
                    }
                }

                ScrollView {
                    vertical-stretch: 1;
                    VerticalLayout {
                        spacing: 2px;
                        for field[index] in root.properties_fields : Rectangle {
                            height: 30px;
                            border-radius: 3px;
                            background: Math.mod(index, 2) == 0 ? transparent : AppPalette.panel-bg-alt.mix(AppPalette.panel-bg-elevated, 0.5);

                            HorizontalLayout {
                                padding-left: 8px;
                                padding-right: 8px;
                                spacing: 8px;

                                Text {
                                    width: 220px;
                                    text: field.field_name;
                                    color: field.common ? AppPalette.text-primary : AppPalette.text-secondary;
                                    font-size: 12px;
                                    vertical-alignment: center;
                                    overflow: elide;
                                }

                                value-input-frame := Rectangle {
                                    horizontal-stretch: 1;
                                    height: 24px;
                                    border-radius: 4px;
                                    border-width: 1px;
                                    border-color: value-input.has-focus ? AppPalette.focus-ring : AppPalette.border;
                                    background: value-input.has-focus ? AppPalette.control-hover-bg : AppPalette.panel-bg;

                                    TouchArea {
                                        clicked => {
                                            if (!root.properties_busy) {
                                                value-input.focus();
                                            }
                                        }
                                    }

                                    value-input := LineEdit {
                                        x: 1px;
                                        y: 1px;
                                        width: max(0px, parent.width - 2px);
                                        height: max(0px, parent.height - 2px);
                                        text: field.value;
                                        enabled: !root.properties_busy;
                                        edited(text) => {
                                            root.properties_field_edited(index, text);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                if root.properties_error_text != "" : Text {
                    text: root.properties_error_text;
                    color: AppPalette.danger;
                    font-size: 11px;
                    wrap: word-wrap;
                }

                HorizontalLayout {
                    spacing: 10px;
                    Rectangle { horizontal-stretch: 1; }
                    Button {
                        text: "Cancel";
                        enabled: !root.properties_busy;
                        clicked => {
                            root.properties_cancel();
                        }
                    }
                    Button {
                        text: "Save";
                        primary: true;
                        enabled: !root.properties_busy;
                        clicked => {
                            if (root.properties_save_enabled) {
                                root.properties_save();
                            }
                        }
                    }
                }
            }
        }
    }

    if root.show_settings_dialog : Rectangle {
        background: AppPalette.overlay-scrim;
        z: 100;

        TouchArea {}

        settings-dialog-panel := Rectangle {
            width: min(root.width - 40px, 620px);
            height: min(root.height - 40px, 460px);
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            border-radius: 6px;
            background: AppPalette.panel-bg-elevated;
            border-width: 1px;
            border-color: root.theme_border;
            property <length> label_column_width: 230px;
            property <length> control_min_width: 170px;
            property <length> control_max_width: 270px;
            property <length> button_height: 30px;
            property <length> button_width: 104px;
            property <length> settings_row_width: self.label_column_width + self.control_max_width + 10px;

            VerticalLayout {
                padding: 16px;
                spacing: 12px;

                HorizontalLayout {
                    Text {
                        text: "Settings";
                        color: root.theme_text_primary;
                        font-size: 16px;
                        font-weight: 700;
                        vertical-alignment: center;
                    }
                    Rectangle { horizontal-stretch: 1; }
                    PlayerButton {
                        icon-source: AppIcons.close;
                        icon-text: "";
                        font-size: 14px;
                        tooltip-text: "Close settings";
                        tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                            root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                        }
                        clicked => {
                            root.show_settings_dialog = false;
                        }
                    }
                }

                Rectangle { height: 1px; background: root.theme_separator; }

                ModeTabs {
                    labels: ["General", "Audio", "Library", "Integrations"];
                    selected_index: root.settings_dialog_tab_index;
                    selected(tab_index) => {
                        root.settings_dialog_tab_index = tab_index;
                    }
                }

                Rectangle {
                    vertical-stretch: 1;
                    clip: true;

                    if root.settings_dialog_tab_index == 0 : ScrollView {
                        width: parent.width;
                        height: parent.height;

                        VerticalLayout {
                            alignment: start;
                            spacing: 8px;

                            Text {
                                text: "Behavior";
                                color: root.theme_text_primary;
                                font-size: 12px;
                                font-weight: 700;
                            }

                            Rectangle {
                                height: 32px;
                                background: settings-layout-intro-toggle-ta.has-hover
                                    ? AppPalette.control-hover-bg
                                    : transparent;
                                border-radius: 4px;
                                HorizontalLayout {
                                    spacing: 10px;
                                    Text {
                                        text: "Show layout editing mode tutorial";
                                        color: root.theme_text_primary;
                                        font-size: 12px;
                                        width: settings-dialog-panel.label_column_width + 24px;
                                        vertical-alignment: center;
                                        horizontal-alignment: left;
                                    }
                                    Rectangle {
                                        width: settings-dialog-panel.control_max_width;
                                        height: parent.height;
                                        background: transparent;
                                        settings-layout-intro-toggle := Switch {
                                            x: parent.width - self.width - 8px;
                                            y: (parent.height - self.height) / 2;
                                            width: 36px;
                                            text: "";
                                            checked <=> root.settings_show_layout_edit_tutorial;
                                        }
                                    }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                                settings-layout-intro-toggle-ta := TouchArea {
                                    clicked => {
                                        settings-layout-intro-toggle.checked = !settings-layout-intro-toggle.checked;
                                    }
                                }
                            }

                            Rectangle {
                                height: 32px;
                                background: settings-tooltips-toggle-ta.has-hover
                                    ? AppPalette.control-hover-bg
                                    : transparent;
                                border-radius: 4px;
                                HorizontalLayout {
                                    spacing: 10px;
                                    Text {
                                        text: "Show tooltips";
                                        color: root.theme_text_primary;
                                        font-size: 12px;
                                        width: settings-dialog-panel.label_column_width + 24px;
                                        vertical-alignment: center;
                                        horizontal-alignment: left;
                                    }
                                    Rectangle {
                                        width: settings-dialog-panel.control_max_width;
                                        height: parent.height;
                                        background: transparent;
                                        settings-tooltips-toggle := Switch {
                                            x: parent.width - self.width - 8px;
                                            y: (parent.height - self.height) / 2;
                                            width: 36px;
                                            text: "";
                                            checked <=> root.settings_show_tooltips;
                                        }
                                    }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                                settings-tooltips-toggle-ta := TouchArea {
                                    clicked => {
                                        settings-tooltips-toggle.checked = !settings-tooltips-toggle.checked;
                                    }
                                }
                            }

                            Rectangle {
                                height: 32px;
                                background: settings-auto-scroll-toggle-ta.has-hover
                                    ? AppPalette.control-hover-bg
                                    : transparent;
                                border-radius: 4px;
                                HorizontalLayout {
                                    spacing: 10px;
                                    auto-scroll-label-host := Rectangle {
                                        width: settings-dialog-panel.label_column_width + 24px;
                                        height: parent.height;
                                        background: transparent;
                                        Text {
                                            text: "Auto scroll to playing track";
                                            color: root.theme_text_primary;
                                            font-size: 12px;
                                            width: parent.width;
                                            height: parent.height;
                                            vertical-alignment: center;
                                            horizontal-alignment: left;
                                        }
                                    }
                                    Rectangle {
                                        width: settings-dialog-panel.control_max_width;
                                        height: parent.height;
                                        background: transparent;
                                        settings-auto-scroll-toggle := Switch {
                                            x: parent.width - self.width - 8px;
                                            y: (parent.height - self.height) / 2;
                                            width: 36px;
                                            text: "";
                                            checked <=> root.settings_auto_scroll_to_playing_track;
                                        }
                                    }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                                settings-auto-scroll-toggle-ta := TouchArea {
                                    changed has-hover => {
                                        root.tooltip_hover_changed(
                                            self.has-hover,
                                            "When enabled, track list views auto-scroll to keep the playing track centered.",
                                            floor((auto-scroll-label-host.absolute-position.x + auto-scroll-label-host.width / 2) / 1px),
                                            floor((auto-scroll-label-host.absolute-position.y + auto-scroll-label-host.height) / 1px)
                                        );
                                    }
                                    clicked => {
                                        settings-auto-scroll-toggle.checked = !settings-auto-scroll-toggle.checked;
                                    }
                                }
                            }

                            Rectangle { height: 1px; background: root.theme_separator; }

                            Text {
                                text: "Appearance";
                                color: root.theme_text_primary;
                                font-size: 12px;
                                font-weight: 700;
                            }

                            Rectangle {
                                height: 32px;
                                background: settings-theme-mode-toggle-ta.has-hover
                                    ? AppPalette.control-hover-bg
                                    : transparent;
                                border-radius: 4px;
                                HorizontalLayout {
                                    spacing: 10px;
                                    Text {
                                        text: "Dark mode";
                                        color: root.theme_text_primary;
                                        font-size: 12px;
                                        width: settings-dialog-panel.label_column_width + 24px;
                                        vertical-alignment: center;
                                        horizontal-alignment: left;
                                    }
                                    Rectangle {
                                        width: settings-dialog-panel.control_max_width;
                                        height: parent.height;
                                        background: transparent;
                                        settings-theme-mode-toggle := Switch {
                                            x: parent.width - self.width - 8px;
                                            y: (parent.height - self.height) / 2;
                                            width: 36px;
                                            text: "";
                                            checked <=> root.settings_prefer_dark_mode;
                                            changed checked => {
                                                root.settings_theme_mode_filter_changed(self.checked);
                                            }
                                        }
                                    }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                                settings-theme-mode-toggle-ta := TouchArea {
                                    clicked => {
                                        settings-theme-mode-toggle.checked = !settings-theme-mode-toggle.checked;
                                    }
                                }
                            }

                            Rectangle {
                                height: 32px;
                                background: transparent;
                                border-radius: 4px;
                                HorizontalLayout {
                                    spacing: 10px;
                                    color-scheme-label-host := Rectangle {
                                        width: settings-dialog-panel.label_column_width + 24px;
                                        height: parent.height;
                                        background: transparent;
                                        Text {
                                            text: "Color Scheme";
                                            color: root.theme_text_primary;
                                            font-size: 12px;
                                            width: parent.width;
                                            height: parent.height;
                                            vertical-alignment: center;
                                            horizontal-alignment: left;
                                        }
                                        settings-theme-label-tooltip-ta := TooltipHoverArea {
                                            tooltip-text: "Choose a preset UI theme. Select Custom to edit named color components.";
                                            tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                                root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                            }
                                        }
                                    }
                                    Rectangle {
                                        width: settings-dialog-panel.control_max_width;
                                        height: parent.height;
                                        background: transparent;
                                        settings-theme-picker := ComboBox {
                                            x: max(0px, parent.width - self.width - 8px);
                                            y: (parent.height - self.height) / 2;
                                            width: min(parent.width - 8px, 220px);
                                            model: root.settings_color_scheme_options;
                                            current-index <=> root.settings_color_scheme_index;
                                            selected(_) => {
                                                if (root.settings_color_scheme_index >= 0
                                                        && root.settings_color_scheme_index < root.settings_color_scheme_option_ids.length) {
                                                    root.settings_selected_color_scheme_id = root.settings_color_scheme_option_ids[root.settings_color_scheme_index];
                                                }
                                                if (root.settings_selected_color_scheme_id == root.settings_custom_color_scheme_id) {
                                                    root.settings_custom_color_draft_values = root.settings_custom_color_values;
                                                    root.show_custom_color_scheme_dialog = true;
                                                }
                                            }
                                        }
                                    }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                            }

                            if root.settings_selected_color_scheme_id == root.settings_custom_color_scheme_id : Rectangle {
                                height: 32px;
                                background: custom-theme-button-ta.has-hover
                                    ? AppPalette.control-hover-bg
                                    : transparent;
                                border-radius: 4px;
                                HorizontalLayout {
                                    spacing: 10px;
                                    Rectangle {
                                        width: settings-dialog-panel.label_column_width + 24px;
                                        height: parent.height;
                                        Text {
                                            text: "Custom Colors";
                                            color: root.theme_text_primary;
                                            font-size: 12px;
                                            width: parent.width;
                                            height: parent.height;
                                            vertical-alignment: center;
                                            horizontal-alignment: left;
                                        }
                                    }
                                    Rectangle {
                                        width: settings-dialog-panel.control_max_width;
                                        height: parent.height;
                                        Button {
                                            text: "Edit Components...";
                                            x: max(0px, parent.width - self.width - 8px);
                                            y: (parent.height - self.height) / 2;
                                            clicked => {
                                                root.settings_custom_color_draft_values = root.settings_custom_color_values;
                                                root.show_custom_color_scheme_dialog = true;
                                            }
                                        }
                                    }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                                custom-theme-button-ta := TouchArea {
                                    clicked => {
                                        root.settings_custom_color_draft_values = root.settings_custom_color_values;
                                        root.show_custom_color_scheme_dialog = true;
                                    }
                                }
                            }
                        }
                    }

                    if root.settings_dialog_tab_index == 1 : ScrollView {
                        width: parent.width;
                        height: parent.height;

                        VerticalLayout {
                            alignment: start;
                            spacing: 8px;

                            Text {
                                width: settings-dialog-panel.settings_row_width;
                                text: "Audio setting changes are staged during playback and only applied after playback is stopped and started again.";
                                color: AppPalette.warning;
                                font-size: 11px;
                                wrap: word-wrap;
                            }

                            SettingsDropdownControl {
                                width: settings-dialog-panel.settings_row_width;
                                label: "Output Device";
                                tooltip_text: "Select which audio output device roqtune uses. Auto follows your system default.";
                                options: root.settings_output_device_options;
                                selected_index <=> root.settings_output_device_index;
                                custom_value <=> root.settings_output_device_custom_value;
                                custom_placeholder: "Enter output device name";
                                allow_custom_input: true;
                                label_width: settings-dialog-panel.label_column_width;
                                control_min_width: settings-dialog-panel.control_min_width;
                                control_max_width: settings-dialog-panel.control_max_width;
                                tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                    root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                }
                            }

                            SettingsDropdownControl {
                                width: settings-dialog-panel.settings_row_width;
                                label: "Output Channels";
                                tooltip_text: "Choose output channel layout. Auto uses the best verified channel count for your device.";
                                options: root.settings_channel_options;
                                selected_index <=> root.settings_channel_index;
                                custom_value <=> root.settings_channel_custom_value;
                                custom_placeholder: "Enter channel count";
                                allow_custom_input: true;
                                label_width: settings-dialog-panel.label_column_width;
                                control_min_width: settings-dialog-panel.control_min_width;
                                control_max_width: settings-dialog-panel.control_max_width;
                                tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                    root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                }
                            }

                            SettingsDropdownControl {
                                width: settings-dialog-panel.settings_row_width;
                                label: "Output Sample Rate";
                                tooltip_text: "Match Content switches output rate per track when supported. Manual keeps one fixed output rate.";
                                options: root.settings_sample_rate_mode_options;
                                selected_index <=> root.settings_sample_rate_mode_index;
                                custom_value: "";
                                custom_placeholder: "";
                                allow_custom_input: false;
                                label_width: settings-dialog-panel.label_column_width;
                                control_min_width: settings-dialog-panel.control_min_width;
                                control_max_width: settings-dialog-panel.control_max_width;
                                tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                    root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                }
                            }

                            Text {
                                width: settings-dialog-panel.settings_row_width;
                                text: root.settings_verified_sample_rates_summary;
                                color: AppPalette.text-secondary;
                                font-size: 11px;
                                wrap: no-wrap;
                                overflow: elide;
                            }

                            if root.settings_sample_rate_mode_index == 1 : SettingsDropdownControl {
                                width: settings-dialog-panel.settings_row_width;
                                label: "Output Sample Rate";
                                tooltip_text: "Only used in Manual mode. Match Content ignores this and switches based on track/sample support.";
                                options: root.settings_sample_rate_options;
                                selected_index <=> root.settings_sample_rate_index;
                                custom_value <=> root.settings_sample_rate_custom_value;
                                custom_placeholder: "Enter sample rate in Hz";
                                allow_custom_input: true;
                                label_width: settings-dialog-panel.label_column_width;
                                control_min_width: settings-dialog-panel.control_min_width;
                                control_max_width: settings-dialog-panel.control_max_width;
                                tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                    root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                }
                            }

                            SettingsDropdownControl {
                                width: settings-dialog-panel.settings_row_width;
                                label: "Output Bits Per Sample";
                                tooltip_text: "Preferred output bit depth. Auto picks the most compatible high-quality format.";
                                options: root.settings_bits_per_sample_options;
                                selected_index <=> root.settings_bits_per_sample_index;
                                custom_value <=> root.settings_bits_per_sample_custom_value;
                                custom_placeholder: "Enter bit depth";
                                allow_custom_input: true;
                                label_width: settings-dialog-panel.label_column_width;
                                control_min_width: settings-dialog-panel.control_min_width;
                                control_max_width: settings-dialog-panel.control_max_width;
                                tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                    root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                }
                            }

                            SettingsDropdownControl {
                                width: settings-dialog-panel.settings_row_width;
                                label: "Resampler Quality";
                                tooltip_text: "Used only when sample rate conversion is required. High uses sinc linear; Highest uses sinc cubic.";
                                options: root.settings_resampler_quality_options;
                                selected_index <=> root.settings_resampler_quality_index;
                                custom_value: "";
                                custom_placeholder: "";
                                allow_custom_input: false;
                                label_width: settings-dialog-panel.label_column_width;
                                control_min_width: settings-dialog-panel.control_min_width;
                                control_max_width: settings-dialog-panel.control_max_width;
                                tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                    root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                }
                            }

                            Rectangle {
                                height: 32px;
                                background: settings-dither-toggle-ta.has-hover
                                    ? AppPalette.control-hover-bg
                                    : transparent;
                                border-radius: 4px;
                                HorizontalLayout {
                                    spacing: 10px;
                                    dither-label-host := Rectangle {
                                        width: settings-dialog-panel.label_column_width + 24px;
                                        height: parent.height;
                                        background: transparent;
                                        Text {
                                            text: "Dither bit-depth conversion";
                                            color: root.theme_text_primary;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                            horizontal-alignment: left;
                                        }
                                        settings-dither-label-tooltip-ta := TooltipHoverArea {
                                            tooltip-text: "Adds low-level noise when reducing bit depth to reduce quantization distortion.";
                                            tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                                root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                            }
                                        }
                                    }
                                    Rectangle {
                                        width: settings-dialog-panel.control_max_width;
                                        height: parent.height;
                                        background: transparent;
                                        settings-dither-toggle := Switch {
                                            x: parent.width - self.width - 8px;
                                            y: (parent.height - self.height) / 2;
                                            width: 36px;
                                            text: "";
                                            checked <=> root.settings_dither_on_bitdepth_reduce;
                                        }
                                    }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                                settings-dither-toggle-ta := TouchArea {
                                    changed has-hover => {
                                        root.tooltip_hover_changed(
                                            self.has-hover,
                                            "Adds low-level noise when reducing bit depth to reduce quantization distortion.",
                                            floor((dither-label-host.absolute-position.x + dither-label-host.width / 2) / 1px),
                                            floor((dither-label-host.absolute-position.y + dither-label-host.height) / 1px)
                                        );
                                    }
                                    clicked => {
                                        settings-dither-toggle.checked = !settings-dither-toggle.checked;
                                    }
                                }
                            }

                            Rectangle {
                                height: 32px;
                                background: settings-downmix-toggle-ta.has-hover
                                    ? AppPalette.control-hover-bg
                                    : transparent;
                                border-radius: 4px;
                                HorizontalLayout {
                                    spacing: 10px;
                                    downmix-label-host := Rectangle {
                                        width: settings-dialog-panel.label_column_width + 24px;
                                        height: parent.height;
                                        background: transparent;
                                        Text {
                                            text: "Downmix tracks with higher channel counts";
                                            color: root.theme_text_primary;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                            horizontal-alignment: left;
                                        }
                                        settings-downmix-label-tooltip-ta := TooltipHoverArea {
                                            tooltip-text: "When source channels exceed output channels, use weighted downmixing instead of legacy channel mapping.";
                                            tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                                root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                            }
                                        }
                                    }
                                    Rectangle {
                                        width: settings-dialog-panel.control_max_width;
                                        height: parent.height;
                                        background: transparent;
                                        settings-downmix-toggle := Switch {
                                            x: parent.width - self.width - 8px;
                                            y: (parent.height - self.height) / 2;
                                            width: 36px;
                                            text: "";
                                            checked <=> root.settings_downmix_higher_channel_tracks;
                                        }
                                    }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                                settings-downmix-toggle-ta := TouchArea {
                                    changed has-hover => {
                                        root.tooltip_hover_changed(
                                            self.has-hover,
                                            "When source channels exceed output channels, use weighted downmixing instead of legacy channel mapping.",
                                            floor((downmix-label-host.absolute-position.x + downmix-label-host.width / 2) / 1px),
                                            floor((downmix-label-host.absolute-position.y + downmix-label-host.height) / 1px)
                                        );
                                    }
                                    clicked => {
                                        settings-downmix-toggle.checked = !settings-downmix-toggle.checked;
                                    }
                                }
                            }

                            Rectangle {
                                height: 32px;
                                background: settings-cast-fallback-toggle-ta.has-hover
                                    ? AppPalette.control-hover-bg
                                    : transparent;
                                border-radius: 4px;
                                HorizontalLayout {
                                    spacing: 10px;
                                    cast-fallback-label-host := Rectangle {
                                        width: settings-dialog-panel.label_column_width + 24px;
                                        height: parent.height;
                                        background: transparent;
                                        Text {
                                            text: "Cast transcode fallback";
                                            color: root.theme_text_primary;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                            horizontal-alignment: left;
                                        }
                                        settings-cast-fallback-label-tooltip-ta := TooltipHoverArea {
                                            tooltip-text: "When direct cast is unsupported by the receiver, fall back to WAV PCM transcoding. Off preserves original source or fails.";
                                            tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                                root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                            }
                                        }
                                    }
                                    Rectangle {
                                        width: settings-dialog-panel.control_max_width;
                                        height: parent.height;
                                        background: transparent;
                                        settings-cast-fallback-toggle := Switch {
                                            x: parent.width - self.width - 8px;
                                            y: (parent.height - self.height) / 2;
                                            width: 36px;
                                            text: "";
                                            checked <=> root.settings_cast_allow_transcode_fallback;
                                        }
                                    }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                                settings-cast-fallback-toggle-ta := TouchArea {
                                    changed has-hover => {
                                        root.tooltip_hover_changed(
                                            self.has-hover,
                                            "When direct cast is unsupported by the receiver, fall back to WAV PCM transcoding. Off preserves original source or fails.",
                                            floor((cast-fallback-label-host.absolute-position.x + cast-fallback-label-host.width / 2) / 1px),
                                            floor((cast-fallback-label-host.absolute-position.y + cast-fallback-label-host.height) / 1px)
                                        );
                                    }
                                    clicked => {
                                        settings-cast-fallback-toggle.checked = !settings-cast-fallback-toggle.checked;
                                    }
                                }
                            }
                        }
                    }

                    if root.settings_dialog_tab_index == 2 : VerticalLayout {
                        width: parent.width;
                        height: parent.height;
                        spacing: 8px;

                        Text {
                            text: "Library Folders";
                            color: root.theme_text_primary;
                            font-size: 12px;
                            font-weight: 700;
                        }

                        Rectangle {
                            vertical-stretch: 1;
                            border-width: 1px;
                            border-color: root.theme_border;
                            border-radius: 4px;
                            background: AppPalette.panel-bg;
                            clip: true;
                            settings-library-folder-list := ListView {
                                x: 1px;
                                y: 1px;
                                width: max(0px, parent.width - 2px);
                                height: max(0px, parent.height - 2px);
                                for folder[index] in root.settings_library_folders : Rectangle {
                                    horizontal-stretch: 1;
                                    height: 26px;
                                    border-radius: 3px;
                                    background: root.settings_library_selected_folder_index == index
                                        ? AppPalette.selection-bg
                                        : settings-library-folder-ta.has-hover
                                            ? AppPalette.control-hover-bg
                                            : transparent;
                                    Text {
                                        x: 8px;
                                        width: max(0px, parent.width - 16px);
                                        text: folder;
                                        color: root.settings_library_selected_folder_index == index
                                            ? AppPalette.text-primary
                                            : root.theme_text_secondary;
                                        font-size: 12px;
                                        vertical-alignment: center;
                                        overflow: elide;
                                    }
                                    settings-library-folder-ta := TouchArea {
                                        clicked => { root.settings_select_library_folder(index); }
                                    }
                                }
                            }
                        }

                        HorizontalLayout {
                            spacing: 8px;
                            Button {
                                text: "Add Folder";
                                width: settings-dialog-panel.button_width;
                                height: settings-dialog-panel.button_height;
                                clicked => { root.library_add_folder(); }
                            }
                            Button {
                                text: "Remove";
                                width: settings-dialog-panel.button_width;
                                height: settings-dialog-panel.button_height;
                                enabled: root.settings_library_selected_folder_index >= 0;
                                clicked => {
                                    root.library_remove_folder(root.settings_library_selected_folder_index);
                                }
                            }
                            Rectangle { horizontal-stretch: 1; }
                            Button {
                                text: "Rescan";
                                width: settings-dialog-panel.button_width;
                                height: settings-dialog-panel.button_height;
                                clicked => { root.library_rescan(); }
                            }
                        }

                        Rectangle {
                            height: 1px;
                            background: root.theme_separator;
                        }

                        Text {
                            text: "Online Metadata (Display-Only)";
                            color: root.theme_text_primary;
                            font-size: 12px;
                            font-weight: 700;
                        }

                        Rectangle {
                            height: 32px;
                            background: settings-library-online-toggle-ta.has-hover
                                ? AppPalette.control-hover-bg
                                : transparent;
                            border-radius: 4px;
                            HorizontalLayout {
                                spacing: 10px;
                                metadata-label-host := Rectangle {
                                    width: max(
                                        settings-dialog-panel.label_column_width,
                                        parent.width - settings-dialog-panel.control_max_width - 10px
                                    );
                                    height: parent.height;
                                    background: transparent;
                                    Text {
                                        text: "Fetch metadata for artist/album pages from internet";
                                        width: parent.width;
                                        color: root.theme_text_primary;
                                        font-size: 12px;
                                        vertical-alignment: center;
                                        horizontal-alignment: left;
                                    }
                                    metadata-label-tooltip-ta := TooltipHoverArea {
                                        tooltip-text: "Internet metadata only affects displayed artwork/text in Library views and never edits audio file tags.";
                                        tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                            root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                        }
                                    }
                                }
                                Rectangle {
                                    width: settings-dialog-panel.control_max_width;
                                    height: parent.height;
                                    background: transparent;
                                    settings-library-online-toggle := Switch {
                                        x: parent.width - self.width - 8px;
                                        y: (parent.height - self.height) / 2;
                                        width: 36px;
                                        text: "";
                                        checked <=> root.settings_library_online_metadata_enabled;
                                    }
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }
                            settings-library-online-toggle-ta := TouchArea {
                                changed has-hover => {
                                    root.tooltip_hover_changed(
                                        self.has-hover,
                                        "Internet metadata only affects displayed artwork/text in Library views and never edits audio file tags.",
                                        floor((metadata-label-host.absolute-position.x + metadata-label-host.width / 2) / 1px),
                                        floor((metadata-label-host.absolute-position.y + metadata-label-host.height) / 1px)
                                    );
                                }
                                clicked => {
                                    settings-library-online-toggle.checked = !settings-library-online-toggle.checked;
                                    root.settings_set_library_online_metadata_enabled(settings-library-online-toggle.checked);
                                }
                            }
                        }

                        Rectangle {
                            height: 32px;
                            background: settings-library-include-playlist-toggle-ta.has-hover
                                ? AppPalette.control-hover-bg
                                : transparent;
                            border-radius: 4px;
                            HorizontalLayout {
                                spacing: 10px;
                                include-playlist-label-host := Rectangle {
                                    width: max(
                                        settings-dialog-panel.label_column_width,
                                        parent.width - settings-dialog-panel.control_max_width - 10px
                                    );
                                    height: parent.height;
                                    background: transparent;
                                    Text {
                                        text: "Include playlist tracks in Library";
                                        width: parent.width;
                                        color: root.theme_text_primary;
                                        font-size: 12px;
                                        vertical-alignment: center;
                                        horizontal-alignment: left;
                                    }
                                    include-playlist-label-tooltip-ta := TooltipHoverArea {
                                        tooltip-text: "When enabled, tracks from all playlists appear in Library categories even if folder scanning is empty.";
                                        tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                                            root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
                                        }
                                    }
                                }
                                Rectangle {
                                    width: settings-dialog-panel.control_max_width;
                                    height: parent.height;
                                    background: transparent;
                                    settings-library-include-playlist-toggle := Switch {
                                        x: parent.width - self.width - 8px;
                                        y: (parent.height - self.height) / 2;
                                        width: 36px;
                                        text: "";
                                        checked <=> root.settings_library_include_playlist_tracks_in_library;
                                    }
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }
                            settings-library-include-playlist-toggle-ta := TouchArea {
                                changed has-hover => {
                                    root.tooltip_hover_changed(
                                        self.has-hover,
                                        "When enabled, tracks from all playlists appear in Library categories even if folder scanning is empty.",
                                        floor((include-playlist-label-host.absolute-position.x + include-playlist-label-host.width / 2) / 1px),
                                        floor((include-playlist-label-host.absolute-position.y + include-playlist-label-host.height) / 1px)
                                    );
                                }
                                clicked => {
                                    settings-library-include-playlist-toggle.checked = !settings-library-include-playlist-toggle.checked;
                                    root.settings_set_library_include_playlist_tracks_in_library(
                                        settings-library-include-playlist-toggle.checked
                                    );
                                }
                            }
                        }

                        HorizontalLayout {
                            spacing: 8px;
                            Button {
                                text: "Clear Internet Metadata Cache";
                                width: 228px;
                                height: settings-dialog-panel.button_height;
                                clicked => { root.clear_library_enrichment_cache(); }
                            }
                            Rectangle { horizontal-stretch: 1; }
                        }
                    }

                    if root.settings_dialog_tab_index == 3 : VerticalLayout {
                        width: parent.width;
                        height: parent.height;
                        spacing: 10px;

                        HorizontalLayout {
                            spacing: 6px;
                            Rectangle {
                                width: 18px;
                                height: 18px;
                                border-radius: 9px;
                                border-width: 1px;
                                border-color: AppPalette.accent-soft-border;
                                background: AppPalette.accent-soft-bg;
                                Image {
                                    source: AppIcons.opensubsonic;
                                    width: 10px;
                                    height: 10px;
                                    x: (parent.width - self.width) / 2;
                                    y: (parent.height - self.height) / 2;
                                    image-fit: contain;
                                    colorize: AppPalette.accent;
                                }
                            }
                            Text {
                                text: "OpenSubsonic";
                                color: root.theme_text_primary;
                                font-size: 12px;
                                font-weight: 700;
                                vertical-alignment: center;
                            }
                        }

                        Rectangle {
                            width: settings-dialog-panel.settings_row_width;
                            height: 30px;
                            background: settings-subsonic-enabled-ta.has-hover
                                ? AppPalette.control-hover-bg
                                : transparent;
                            border-radius: 4px;
                            HorizontalLayout {
                                spacing: 10px;
                                Text {
                                    text: "Enable OpenSubsonic backend";
                                    color: root.theme_text_primary;
                                    font-size: 12px;
                                    width: settings-dialog-panel.label_column_width + 24px;
                                    vertical-alignment: center;
                                }
                                Rectangle {
                                    width: settings-dialog-panel.control_max_width;
                                    height: parent.height;
                                    settings-subsonic-enabled := Switch {
                                        x: parent.width - self.width - 8px;
                                        y: (parent.height - self.height) / 2;
                                        width: 36px;
                                        text: "";
                                        checked <=> root.settings_subsonic_enabled;
                                    }
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }
                            settings-subsonic-enabled-ta := TouchArea {
                                clicked => {
                                    settings-subsonic-enabled.checked = !settings-subsonic-enabled.checked;
                                }
                            }
                        }

                        HorizontalLayout {
                            width: settings-dialog-panel.settings_row_width;
                            spacing: 10px;
                            Text {
                                text: "Server URL";
                                width: settings-dialog-panel.label_column_width;
                                color: root.theme_text_primary;
                                font-size: 12px;
                                vertical-alignment: center;
                            }
                            LineEdit {
                                text <=> root.settings_subsonic_endpoint;
                                placeholder-text: "https://your-server.example.com";
                            }
                        }

                        HorizontalLayout {
                            width: settings-dialog-panel.settings_row_width;
                            spacing: 10px;
                            Text {
                                text: "Username";
                                width: settings-dialog-panel.label_column_width;
                                color: root.theme_text_primary;
                                font-size: 12px;
                                vertical-alignment: center;
                            }
                            LineEdit {
                                text <=> root.settings_subsonic_username;
                                placeholder-text: "username";
                            }
                        }

                        HorizontalLayout {
                            width: settings-dialog-panel.settings_row_width;
                            spacing: 10px;
                            Text {
                                text: "Password";
                                width: settings-dialog-panel.label_column_width;
                                color: root.theme_text_primary;
                                font-size: 12px;
                                vertical-alignment: center;
                            }
                            LineEdit {
                                text <=> root.settings_subsonic_password;
                                input-type: password;
                                placeholder-text: "stored in secure credential store";
                            }
                        }

                        Text {
                            width: settings-dialog-panel.settings_row_width;
                            text: root.settings_subsonic_status;
                            color: AppPalette.text-secondary;
                            font-size: 11px;
                            wrap: word-wrap;
                        }

                        HorizontalLayout {
                            width: settings-dialog-panel.settings_row_width;
                            spacing: 8px;
                            Button {
                                text: "Save";
                                width: settings-dialog-panel.button_width;
                                height: settings-dialog-panel.button_height;
                                clicked => {
                                    root.settings_save_subsonic_profile(
                                        root.settings_subsonic_enabled,
                                        root.settings_subsonic_endpoint,
                                        root.settings_subsonic_username,
                                        root.settings_subsonic_password
                                    );
                                }
                            }
                            Button {
                                text: "Test";
                                width: settings-dialog-panel.button_width;
                                height: settings-dialog-panel.button_height;
                                clicked => { root.settings_test_subsonic_connection(); }
                            }
                            Button {
                                text: "Sync Now";
                                width: settings-dialog-panel.button_width;
                                height: settings-dialog-panel.button_height;
                                clicked => { root.settings_sync_subsonic_now(); }
                            }
                            Button {
                                text: "Disconnect";
                                width: settings-dialog-panel.button_width;
                                height: settings-dialog-panel.button_height;
                                clicked => { root.settings_disconnect_subsonic(); }
                            }
                            Rectangle { horizontal-stretch: 1; }
                        }
                    }
                }

            Rectangle { height: 1px; background: root.theme_separator; }

            HorizontalLayout {
                spacing: 10px;
                Rectangle { horizontal-stretch: 1; }
                Button {
                    text: "Cancel";
                    width: settings-dialog-panel.button_width;
                    height: settings-dialog-panel.button_height;
                    clicked => {
                        root.show_settings_dialog = false;
                    }
                }
                Button {
                    text: "Apply";
                    primary: true;
                    width: settings-dialog-panel.button_width;
                    height: settings-dialog-panel.button_height;
                    clicked => {
                        root.apply_settings(
                            root.settings_output_device_index,
                            root.settings_channel_index,
                            root.settings_sample_rate_index,
                            root.settings_bits_per_sample_index,
                            root.settings_output_device_custom_value,
                            root.settings_channel_custom_value,
                            root.settings_sample_rate_custom_value,
                            root.settings_bits_per_sample_custom_value,
                            root.settings_show_layout_edit_tutorial,
                            root.settings_show_tooltips,
                            root.settings_auto_scroll_to_playing_track,
                            root.settings_sample_rate_mode_index,
                            root.settings_resampler_quality_index,
                            root.settings_dither_on_bitdepth_reduce,
                            root.settings_downmix_higher_channel_tracks,
                            root.settings_cast_allow_transcode_fallback,
                            root.settings_selected_color_scheme_id,
                            root.settings_custom_color_values
                        );
                        root.show_settings_dialog = false;
                    }
                }
            }
        }
    }
    }

    if root.show_custom_color_scheme_dialog : Rectangle {
        z: 155;
        background: AppPalette.overlay-scrim;
        TouchArea {}

        Rectangle {
            width: min(700px, max(420px, root.width - 24px));
            height: min(560px, max(260px, root.height - 24px));
            x: max(0px, (parent.width - self.width) / 2);
            y: max(0px, (parent.height - self.height) / 2);
            background: AppPalette.panel-bg-elevated;
            border-width: 1px;
            border-color: AppPalette.border;
            border-radius: 6px;

            VerticalLayout {
                padding: 14px;
                spacing: 10px;

                Text {
                    text: "Custom Color Components";
                    color: AppPalette.text-primary;
                    font-size: 15px;
                    font-weight: 700;
                }

                Text {
                    text: "Use Pick... for an interactive color editor, or type a hex color.";
                    color: AppPalette.text-secondary;
                    font-size: 11px;
                }

                Rectangle {
                    horizontal-stretch: 1;
                    vertical-stretch: 1;
                    border-width: 1px;
                    border-color: AppPalette.border;
                    border-radius: 4px;
                    background: AppPalette.panel-bg;

                    ScrollView {
                        width: parent.width;
                        height: parent.height;
                        VerticalLayout {
                            padding: 8px;
                            spacing: 6px;
                            for label[i] in root.settings_custom_color_labels : HorizontalLayout {
                                spacing: 8px;
                                Rectangle {
                                    width: 200px;
                                    height: 30px;
                                    Text {
                                        text: label;
                                        color: AppPalette.text-primary;
                                        font-size: 12px;
                                        vertical-alignment: center;
                                        horizontal-alignment: left;
                                        width: parent.width;
                                        height: parent.height;
                                    }
                                }
                                LineEdit {
                                    width: 150px;
                                    height: 30px;
                                    text: i < root.settings_custom_color_draft_values.length
                                        ? root.settings_custom_color_draft_values[i]
                                        : "";
                                    placeholder-text: "#RRGGBB";
                                    edited => {
                                        root.settings_custom_theme_color_draft_edited(i, self.text);
                                    }
                                }
                                Rectangle {
                                    width: 30px;
                                    height: 30px;
                                    border-radius: 4px;
                                    border-width: 1px;
                                    border-color: AppPalette.border;
                                    background: i < root.settings_custom_color_draft_preview_colors.length
                                        ? root.settings_custom_color_draft_preview_colors[i]
                                        : AppPalette.panel-bg;
                                }
                                Button {
                                    text: "Pick...";
                                    width: 74px;
                                    height: 30px;
                                    clicked => {
                                        root.settings_open_custom_color_picker(
                                            i,
                                            label,
                                            i < root.settings_custom_color_draft_values.length
                                                ? root.settings_custom_color_draft_values[i]
                                                : ""
                                        );
                                    }
                                }
                                Rectangle { horizontal-stretch: 1; }
                            }
                        }
                    }
                }

                HorizontalLayout {
                    spacing: 10px;
                    Button {
                        text: "Reset...";
                        clicked => {
                            root.show_custom_color_reset_confirm = true;
                        }
                    }
                    Rectangle { horizontal-stretch: 1; }
                    Button {
                        text: "Cancel";
                        clicked => {
                            root.show_custom_color_scheme_dialog = false;
                            root.show_custom_color_picker_dialog = false;
                            root.show_custom_color_reset_confirm = false;
                            root.settings_custom_color_draft_values = root.settings_custom_color_values;
                        }
                    }
                    Button {
                        text: "Save";
                        primary: true;
                        clicked => {
                            root.settings_custom_color_values = root.settings_custom_color_draft_values;
                            root.show_custom_color_picker_dialog = false;
                            root.show_custom_color_reset_confirm = false;
                            root.show_custom_color_scheme_dialog = false;
                        }
                    }
                }
            }
        }
    }

    custom_color_reset_overlay := ConfirmationDialog {
        z: 157;
        is-visible: root.show_custom_color_reset_confirm;
        message: "Reset custom colors to roqtune (dark) defaults?\n\nThis discards unsaved color edits in this dialog.";
        confirm-button-text: "Reset";
        confirmed => {
            root.settings_reset_custom_colors();
            root.show_custom_color_reset_confirm = false;
        }
        cancelled => {
            root.show_custom_color_reset_confirm = false;
        }
    }

    if root.show_custom_color_picker_dialog : Rectangle {
        z: 156;
        background: AppPalette.overlay-scrim;
        TouchArea {}

        Rectangle {
            width: min(520px, max(340px, root.width - 40px));
            height: min(360px, max(240px, root.height - 40px));
            x: max(0px, (parent.width - self.width) / 2);
            y: max(0px, (parent.height - self.height) / 2);
            background: AppPalette.panel-bg-elevated;
            border-width: 1px;
            border-color: AppPalette.border;
            border-radius: 6px;

            VerticalLayout {
                padding: 14px;
                spacing: 10px;

                Text {
                    text: root.settings_custom_color_picker_target_label == ""
                        ? "Pick Color"
                        : "Pick Color: " + root.settings_custom_color_picker_target_label;
                    color: AppPalette.text-primary;
                    font-size: 14px;
                    font-weight: 700;
                }

                Rectangle {
                    height: 58px;
                    border-width: 1px;
                    border-color: AppPalette.border;
                    border-radius: 5px;
                    background: rgb(
                        root.color-picker-channel(root.settings_custom_color_picker_r),
                        root.color-picker-channel(root.settings_custom_color_picker_g),
                        root.color-picker-channel(root.settings_custom_color_picker_b)
                    );
                }

                HorizontalLayout {
                    spacing: 8px;
                    Text {
                        width: 20px;
                        text: "R";
                        color: AppPalette.text-primary;
                        vertical-alignment: center;
                    }
                    Slider {
                        horizontal-stretch: 1;
                        minimum: 0;
                        maximum: 255;
                        step: 1;
                        value: root.settings_custom_color_picker_r;
                        changed(next-value) => { root.settings_custom_color_picker_r = next-value; }
                    }
                    Text {
                        width: 34px;
                        text: root.color-picker-channel(root.settings_custom_color_picker_r);
                        color: AppPalette.text-secondary;
                        horizontal-alignment: right;
                        vertical-alignment: center;
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Text {
                        width: 20px;
                        text: "G";
                        color: AppPalette.text-primary;
                        vertical-alignment: center;
                    }
                    Slider {
                        horizontal-stretch: 1;
                        minimum: 0;
                        maximum: 255;
                        step: 1;
                        value: root.settings_custom_color_picker_g;
                        changed(next-value) => { root.settings_custom_color_picker_g = next-value; }
                    }
                    Text {
                        width: 34px;
                        text: root.color-picker-channel(root.settings_custom_color_picker_g);
                        color: AppPalette.text-secondary;
                        horizontal-alignment: right;
                        vertical-alignment: center;
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Text {
                        width: 20px;
                        text: "B";
                        color: AppPalette.text-primary;
                        vertical-alignment: center;
                    }
                    Slider {
                        horizontal-stretch: 1;
                        minimum: 0;
                        maximum: 255;
                        step: 1;
                        value: root.settings_custom_color_picker_b;
                        changed(next-value) => { root.settings_custom_color_picker_b = next-value; }
                    }
                    Text {
                        width: 34px;
                        text: root.color-picker-channel(root.settings_custom_color_picker_b);
                        color: AppPalette.text-secondary;
                        horizontal-alignment: right;
                        vertical-alignment: center;
                    }
                }

                Rectangle { vertical-stretch: 1; }

                HorizontalLayout {
                    spacing: 10px;
                    Rectangle { horizontal-stretch: 1; }
                    Button {
                        text: "Cancel";
                        clicked => {
                            root.show_custom_color_picker_dialog = false;
                        }
                    }
                    Button {
                        text: "Apply";
                        primary: true;
                        clicked => {
                            root.settings_apply_custom_color_picker(
                                root.settings_custom_color_picker_target_index,
                                root.color-picker-channel(root.settings_custom_color_picker_r),
                                root.color-picker-channel(root.settings_custom_color_picker_g),
                                root.color-picker-channel(root.settings_custom_color_picker_b)
                            );
                            root.show_custom_color_picker_dialog = false;
                        }
                    }
                }
            }
        }
    }

    if root.show_tooltip
            && root.show_tooltips_enabled
            && root.tooltip_text != ""
            && !root.show_settings_menu
            && !root.show_cast_menu
            && !root.show_library_folder_menu
            && !root.show_import_menu
            && !root.show_library_context_menu
            && !root.show_playlist_track_context_menu
            && !root.show_properties_dialog
            && !root.show_control_cluster_menu : Rectangle {
        z: 200;
        property <length> tooltip-max-width: min(360px, root.width - 16px);
        width: min(
            self.tooltip-max-width,
            max(56px, tooltip-text-block.preferred-width + 16px)
        );
        x: min(root.width - self.width - 8px, max(8px, root.tooltip_anchor_x_px * 1px - self.width / 2));
        y: min(root.height - self.height - 8px, max(8px, root.tooltip_anchor_y_px * 1px + 8px));
        height: tooltip-text-block.preferred-height + 10px;
        border-radius: 4px;
        border-width: 1px;
        border-color: AppPalette.tooltip-border;
        background: AppPalette.tooltip-bg;

        tooltip-text-block := Text {
            x: 8px;
            y: 5px;
            width: max(0px, parent.width - 16px);
            text: root.tooltip_text;
            color: AppPalette.tooltip-text;
            font-size: 11px;
            wrap: word-wrap;
            overflow: clip;
        }
    }

    // Properties to communicate with Rust
    in-out property <[StandardListViewItem]> playlists: [];
    in-out property <[bool]> playlist_is_remote: [];
    in-out property <[bool]> playlist_can_sync_opensubsonic: [];
    in-out property <int> active_playlist_index: 0;
    in-out property <int> editing_playlist_index: -1;
    in-out property <int> new_playlist_edit_index: -1;
    in-out property <[TrackRowData]> track_model: [];
    in-out property <int> playback_order_index: 0;
    in-out property <int> repeat_mode: 0; // 0: Off, 1: Playlist, 2: Track
    in-out property <int> selected_track_index: -1;
    in-out property <int> playing_track_index: -1;
    in-out property <int> library_playing_track_index: -1;
    in-out property <bool> playlist_filter_active: false;
    in-out property <bool> playlist_filter_blocked_feedback: false;
    in-out property <bool> playlist_search_visible: false;
    in-out property <string> playlist_search_query: "";
    in-out property <string> library_search_query: "";
    in-out property <string> playlist_search_result_text: "0/0";
    in-out property <bool> library_search_visible: false;
    in-out property <int> library_search_focus_token: 0;
    in-out property <string> library_search_result_text: "0/0";
    in-out property <string> playlist_filter_summary: "";
    in-out property <[int]> playlist_column_sort_states: [];

    // Album art properties
    in-out property <image> current_cover_art;
    in-out property <bool> current_cover_art_available: false;

    // Metadata display properties
    in-out property <string> display_title: "";
    in-out property <string> display_artist: "";
    in-out property <string> display_album: "";
    in-out property <string> display_date: "";
    in-out property <string> display_genre: "";

    // Drag and drop state
    in-out property <int> pressed-index: -1;
    property <length> press-y: 0;
    in-out property <bool> is-dragging: false;
    in-out property <int> drop-index: -1;
    property <int> hover-index: -1;
    property <int> playlist-link-hover-row: -1;
    property <int> playlist-link-hover-column: -1;
    property <bool> playlist-link-modifier-active: false;
    property <bool> filter-blocked-shown: false;

    // Seek bar properties - raw integer values from Rust (no string allocations)
    in-out property <int> elapsed-ms: 0;
    in-out property <int> total-ms: 0;
    in-out property <float> position-percentage: 0.0; // between 0.0 and 1.0
    in-out property <float> volume-level: 1.0; // between 0.0 and 1.0
    in-out property <string> technical-info: "";
    in-out property <bool> show_settings_dialog: false;
    in-out property <bool> show_settings_restart_notice: false;
    in-out property <string> settings_restart_notice_message: "";
    in-out property <bool> show_subsonic_keyring_notice: false;
    in-out property <string> subsonic_keyring_notice_message: "";
    in-out property <bool> show_subsonic_session_password_prompt: false;
    in-out property <string> subsonic_session_prompt_username: "";
    in-out property <string> subsonic_session_prompt_endpoint: "";
    in-out property <string> subsonic_session_prompt_password: "";
    in-out property <string> subsonic_session_prompt_status: "";
    in-out property <bool> cast_connected: false;
    in-out property <bool> cast_connecting: false;
    in-out property <bool> has_current_track_context: false;
    in-out property <bool> now_playing_favorited: false;
    in-out property <string> cast_connection_label: "Not Connected";
    in-out property <[string]> cast_device_names: [];
    in-out property <[string]> cast_device_ids: [];
    in-out property <[string]> playlist_visible_column_headers: [];
    in-out property <[int]> playlist_visible_column_kinds: [];
    in-out property <int> playlist_row_height_px: 30;
    in-out property <[string]> playlist_column_menu_labels: [];
    in-out property <[bool]> playlist_column_menu_checked: [];
    in-out property <[bool]> playlist_column_menu_is_custom: [];
    in-out property <[string]> settings_output_device_options: [];
    in-out property <[string]> settings_channel_options: [];
    in-out property <[string]> settings_sample_rate_options: [];
    in-out property <[string]> settings_bits_per_sample_options: [];
    in-out property <[string]> settings_sample_rate_mode_options: [];
    in-out property <[string]> settings_resampler_quality_options: [];
    in-out property <int> settings_output_device_index: 0;
    in-out property <int> settings_channel_index: 0;
    in-out property <int> settings_sample_rate_index: 0;
    in-out property <int> settings_bits_per_sample_index: 0;
    in-out property <int> settings_sample_rate_mode_index: 0;
    in-out property <int> settings_resampler_quality_index: 0;
    in-out property <string> settings_output_device_custom_value: "";
    in-out property <string> settings_channel_custom_value: "";
    in-out property <string> settings_sample_rate_custom_value: "";
    in-out property <string> settings_bits_per_sample_custom_value: "";
    in-out property <string> settings_verified_sample_rates_summary: "Verified rates: (none)";
    in-out property <bool> settings_show_layout_edit_tutorial: true;
    in-out property <bool> settings_show_tooltips: true;
    in-out property <bool> settings_auto_scroll_to_playing_track: true;
    in-out property <bool> settings_prefer_dark_mode: true;
    in-out property <[string]> settings_color_scheme_options: [];
    in-out property <[string]> settings_color_scheme_option_ids: [];
    in-out property <int> settings_color_scheme_index: 0;
    in-out property <string> settings_selected_color_scheme_id: "";
    property <string> settings_custom_color_scheme_id: "custom";
    in-out property <[string]> settings_custom_color_labels: [];
    in-out property <[string]> settings_custom_color_values: [];
    in-out property <[string]> settings_custom_color_draft_values: [];
    in-out property <[color]> settings_custom_color_draft_preview_colors: [];
    in-out property <bool> show_custom_color_scheme_dialog: false;
    in-out property <bool> show_custom_color_reset_confirm: false;
    in-out property <bool> show_custom_color_picker_dialog: false;
    in-out property <int> settings_custom_color_picker_target_index: -1;
    in-out property <string> settings_custom_color_picker_target_label: "";
    in-out property <float> settings_custom_color_picker_r: 42;
    in-out property <float> settings_custom_color_picker_g: 109;
    in-out property <float> settings_custom_color_picker_b: 239;
    in-out property <bool> settings_dither_on_bitdepth_reduce: true;
    in-out property <bool> settings_downmix_higher_channel_tracks: true;
    in-out property <bool> settings_cast_allow_transcode_fallback: false;
    in-out property <bool> settings_subsonic_enabled: false;
    in-out property <string> settings_subsonic_endpoint: "";
    in-out property <string> settings_subsonic_username: "";
    in-out property <string> settings_subsonic_password: "";
    in-out property <string> settings_subsonic_status: "Not configured";
    in-out property <bool> show_tooltips_enabled: true;
    in-out property <int> settings_dialog_tab_index: 0;
    in-out property <bool> show_tooltip: false;
    in-out property <string> tooltip_text: "";
    in-out property <int> tooltip_anchor_x_px: 0;
    in-out property <int> tooltip_anchor_y_px: 0;

    changed settings_custom_color_draft_values => {
        root.settings_refresh_custom_color_previews();
    }

    changed show_custom_color_scheme_dialog => {
        if (root.show_custom_color_scheme_dialog) {
            root.settings_refresh_custom_color_previews();
        } else {
            root.show_custom_color_reset_confirm = false;
            root.show_custom_color_picker_dialog = false;
        }
    }

    changed layout_edit_mode => {
        if (root.layout_edit_mode) {
            root.layout_exit_editor_button_x =
                min(max(0px, (root.width - root.layout_exit_editor_button_width) / 2), max(0px, root.width - root.layout_exit_editor_button_width));
            root.layout_exit_editor_button_y = 8px;
        } else {
            root.layout_exit_editor_dragging = false;
        }
    }
    
    // Computed time display strings (derived from integer ms values)
    // These are computed in Slint to avoid Rust string allocations
    pure function format-time-component(value: int) -> string {
        if value < 10 {
            return "0" + value;
        }
        return value;
    }
    
    pure function format-time(ms: int) -> string {
        if ms <= 0 {
            return "0:00";
        }
        return floor(ms / 60000) + ":" + root.format-time-component(mod(floor(ms / 1000), 60));
    }
    
    pure function format-time-range(elapsed: int, total: int) -> string {
        return root.format-time(elapsed) + " / " + root.format-time(total);
    }

    pure function color-picker-channel(value: float) -> int {
        let rounded = floor(value + 0.5);
        if rounded < 0 {
            return 0;
        }
        if rounded > 255 {
            return 255;
        }
        return rounded;
    }

    // Callback declarations
    callback open_file();
    callback open_folder();
    callback play();
    callback pause();
    callback stop();
    callback next();
    callback previous();
    callback switch_collection_mode(int);
    callback library_select_root(int);
    callback open_global_library_search();
    callback library_back();
    callback library_select_list_item(int, bool, bool, bool);
    callback library_item_activated(int);
    callback toggle_favorite_for_library_row(int);
    callback library_prepare_add_to_playlists();
    callback library_toggle_add_to_playlist(int);
    callback library_confirm_add_to_playlists();
    callback library_cancel_add_to_playlists();
    callback library_confirm_remove_selection();
    callback library_cancel_remove_selection();
    callback open_properties_for_current_selection();
    callback properties_field_edited(int, string);
    callback properties_save();
    callback properties_cancel();
    callback library_add_folder();
    callback library_remove_folder(int);
    callback library_rescan();
    callback settings_select_library_folder(int);
    callback library_online_metadata_prompt_accept();
    callback library_online_metadata_prompt_deny();
    callback settings_set_library_online_metadata_enabled(bool);
    callback settings_set_library_include_playlist_tracks_in_library(bool);
    callback activate_metadata_link(int, string, string, string, string, bool);
    callback settings_save_subsonic_profile(bool, string, string, string);
    callback settings_test_subsonic_connection();
    callback settings_sync_subsonic_now();
    callback settings_disconnect_subsonic();
    callback subsonic_session_password_submit(string);
    callback subsonic_session_password_cancel();
    callback clear_library_enrichment_cache();
    callback library_viewport_changed(int, int);
    callback playlist_viewport_changed(int, int);
    callback handle_track_click(int, bool, bool);
    callback on_pointer_down(int, bool, bool);
    callback on_drag_start(int);
    callback on_drag_move(int);
    callback on_drag_end(int, bool);
    callback playlist_item_double_click(int);
    callback toggle_favorite_for_playlist_row(int);
    callback toggle_favorite_now_playing();
    callback playback_order_changed(int);
    callback toggle_repeat();
    callback seek-to(float); // Position between 0.0 and 1.0
    callback volume-changed(float); // Volume between 0.0 and 1.0
    callback delete_selected_tracks();
    callback open_file_location();
    callback reorder_tracks([int], int); // indices, to
    callback copy_selected_tracks();
    callback cut_selected_tracks();
    callback paste_copied_tracks();
    callback undo_last_action();
    callback redo_last_action();
    callback deselect_all();
    callback select_all();
    callback arrow_key_navigate(/* direction: */ int, /* shift: */ bool);
    callback page_navigate(/* action: 0=Home, 1=End, 2=PageUp, 3=PageDown */ int, /* shift: */ bool, /* visible_row_count: */ int);
    callback create_playlist();
    callback switch_playlist(int);
    callback rename_playlist(int, string);
    callback delete_playlist(int);
    callback sync_playlist_to_opensubsonic(int);
    callback remote_detach_confirm(string);
    callback remote_detach_cancel(string);
    callback toggle_playlist_column(int);
    callback add_custom_playlist_column(string, string);
    callback delete_custom_playlist_column(int);
    callback reorder_playlist_columns(int, int);
    callback playlist_header_column_at(int) -> int;
    callback playlist_header_gap_at(int) -> int;
    callback playlist_header_divider_at(int) -> int;
    callback playlist_header_column_min_width(int) -> int;
    callback playlist_header_column_max_width(int) -> int;
    callback preview_playlist_column_width(int, int);
    callback commit_playlist_column_width(int, int);
    callback reset_playlist_column_width(int);
    callback playlist_columns_viewport_resized(int);
    callback open_playlist_search();
    callback close_playlist_search();
    callback set_playlist_search_query(string);
    callback open_library_search();
    callback close_library_search();
    callback library_search_query_edited(string);
    callback clear_playlist_filter_view();
    callback cycle_playlist_sort_by_column(int);
    callback apply_filter_view_to_playlist();
    callback playlist_modification_blocked();
    callback open_control_cluster_menu_for_leaf(string, int, int);
    callback open_viewer_panel_settings_for_leaf(string, int, int, int);
    callback open_collection_panel_settings_for_leaf(string, int, int, int);
    callback add_control_cluster_button(string, int);
    callback remove_control_cluster_button(string, int);
    callback set_collection_panel_mode(string, int);
    callback set_viewer_panel_display_priority(string, int);
    callback set_viewer_panel_metadata_source(string, int);
    callback set_viewer_panel_metadata_text_format(string, string);
    callback set_viewer_panel_image_source(string, int);
    callback window_resized(int, int);
    callback layout_workspace_resized(int, int);
    callback open_layout_editor();
    callback layout_intro_proceed(bool);
    callback layout_intro_cancel(bool);
    callback layout_select_leaf(string);
    callback layout_replace_selected_leaf(int);
    callback layout_split_selected_leaf(int, int);
    callback layout_delete_selected_leaf();
    callback layout_add_root_leaf(int);
    callback preview_layout_splitter_ratio(string, float);
    callback commit_layout_splitter_ratio(string, float);
    callback layout_undo_last_action();
    callback layout_redo_last_action();
    callback reset_layout_default();
    callback open_settings();
    callback cast_refresh_devices();
    callback cast_connect_device(string);
    callback cast_disconnect();
    callback open_external_url(string);
    callback tooltip_hover_changed(bool, string, int, int);
    callback settings_custom_theme_color_draft_edited(int, string);
    callback settings_open_custom_color_picker(int, string, string);
    callback settings_apply_custom_color_picker(int, int, int, int);
    callback settings_refresh_custom_color_previews();
    callback settings_reset_custom_colors();
    callback settings_theme_mode_filter_changed(bool);
    callback apply_settings(int, int, int, int, string, string, string, string, bool, bool, bool, int, int, bool, bool, bool, string, [string]);
}
