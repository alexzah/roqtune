import { LineEdit, Palette } from "std-widgets.slint";

import { TrackRowData } from "../types.slint";
import { AppIcons } from "../icons.slint";
import { ContextMenu } from "menus.slint";

export component PlaylistRow inherits Rectangle {
    in property <string> name;
    in property <bool> is-active;
    in property <bool> is-editing;
    in property <bool> is-remote;
    in property <bool> is-new-playlist-edit;
    in property <bool> can-sync-opensubsonic;
    callback clicked();
    callback renamed(string);
    callback context-menu-rename();
    callback context-menu-delete();
    callback context-menu-sync();
    callback cancel-edit();

    property <length> menu-x;
    property <length> menu-y;
    private property <bool> dark: Palette.color-scheme == ColorScheme.dark;

    height: 24px;
    background: is-active
        ? (root.dark ? #3d3d3d : #d9e5f5)
        : ta.has-hover
            ? (root.dark ? #333 : #e5ecf5)
            : transparent;
    border-radius: 2px;

    if !is-editing : Text {
        x: 8px;
        width: max(0px, parent.width - (root.is-remote ? 32px : 12px));
        text: root.name;
        color: is-active ? (root.dark ? #eee : #223445) : (root.dark ? #aaa : #5a6877);
        font-size: 13px;
        vertical-alignment: center;
        horizontal-alignment: left;
        overflow: elide;
    }

    if !is-editing && root.is-remote : Rectangle {
        x: parent.width - self.width - 8px;
        y: (parent.height - self.height) / 2;
        width: 14px;
        height: 14px;
        border-radius: 7px;
        border-width: 1px;
        border-color: root.dark ? #3f5470 : #b4cde8;
        background: root.dark ? #1f3248 : #e2eefb;

        Image {
            source: AppIcons.opensubsonic;
            width: 8px;
            height: 8px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            image-fit: contain;
            colorize: root.dark ? #9fc3eb : #2d5f98;
        }
    }

    if is-editing : LineEdit {
        x: 4px;
        width: parent.width - 8px;
        height: parent.height - 4px;
        text: root.is-new-playlist-edit ? "" : root.name;
        placeholder-text: root.is-new-playlist-edit ? root.name : "";
        accepted => {
            root.renamed(self.text);
        }
        init => {
            self.focus();
        }
    }

    ta := TouchArea {
        visible: !is-editing;
        clicked => { root.clicked(); }
        pointer-event(event) => {
            if (event.button == PointerEventButton.right && event.kind == PointerEventKind.down) {
                root.menu-x = self.mouse-x;
                root.menu-y = self.mouse-y;
                menu.show();
            }
        }
    }

    menu := ContextMenu {
        is-playlist: true;
        show-sync-item: root.can-sync-opensubsonic;
        x: root.menu-x;
        y: root.menu-y;
        rename => {
            root.context-menu-rename();
        }
        sync-opensubsonic => {
            root.context-menu-sync();
        }
        delete => {
            root.context-menu-delete();
        }
    }

    FocusScope {
        visible: root.is-editing;
        key-pressed(event) => {
            if (event.text == Key.Escape) {
                root.cancel-edit();
                return accept;
            }
            reject
        }
    }
}

export component TrackRow inherits Rectangle {
    in property <TrackRowData> data;
    in property <bool> is-playing;
    in property <bool> is-hover;
    in property <[string]> headers: [];
    in property <[int]> column-kinds: [];
    in property <[int]> column-widths-px: [];
    in property <length> row-height: 30px;
    in property <length> null-column-width: 120px;
    in property <length> horizontal-padding: 8px;
    in property <length> column-spacing: 10px;
    in property <length> status-lane-width: 40px;
    private property <bool> dark: Palette.color-scheme == ColorScheme.dark;

    pure function column-width-for-index(index: int) -> length {
        if index >= 0 && index < root.column-widths-px.length {
            return max(1px, root.column-widths-px[index] * 1px);
        }
        return 140px;
    }

    height: root.row-height;
    property <brush> idle-background: data.selected
        ? (root.dark ? #3d3d3d : #dce8f7)
        : root.is-playing
            ? (root.dark ? #24384f : #d4e6fb)
            : transparent;
    background: root.data.unavailable
        ? (data.selected
            ? (root.dark ? #373737 : #dde2e9)
            : (root.dark ? #2d2d2d : #edf1f5))
        : is-hover
            ? data.selected
                ? (root.dark ? #474747 : #d2deed)
                : root.is-playing
                    ? (root.dark ? #2f4965 : #c8ddf5)
                    : (root.dark ? #333 : #e5ecf5)
            : root.idle-background;
    animate background { duration: 100ms; }
    opacity: root.data.unavailable ? 0.68 : 1.0;

    HorizontalLayout {
        padding-left: root.horizontal-padding;
        padding-right: root.horizontal-padding;
        spacing: root.column-spacing;

        Rectangle {
            width: root.status-lane-width;
            Text {
                text: root.data.status;
                color: root.data.unavailable ? (root.dark ? #7a7a7a : #7c8895) : #2a6def;
                font-size: 14px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        for column-value[index] in root.data.values : Rectangle {
            width: root.column-width-for-index(index);
            clip: true;
            property <int> column-kind: index < root.column-kinds.length ? root.column-kinds[index] : 0;

            if self.column-kind == 1 : Rectangle {
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                width: max(16px, min(parent.width, root.height - 8px));
                height: self.width;
                border-radius: 2px;
                background: root.dark ? #2a2a2a : #e3ebf5;
                Image {
                    source: root.data.album_art;
                    width: parent.width;
                    height: parent.height;
                    image-fit: contain;
                }
            }

            if self.column-kind == 2 : Rectangle {
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                width: 18px;
                height: 18px;
                Image {
                    source: root.data.favorited ? AppIcons.heart-filled : AppIcons.heart;
                    width: 14px;
                    height: 14px;
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    image-fit: contain;
                    colorize: root.data.favorited
                        ? (root.dark ? #ff91a8 : #d63a5f)
                        : (root.dark ? #99a2ae : #6e7b89);
                }
            }

            if self.column-kind != 1 && self.column-kind != 2 : Text {
                x: 0px;
                width: parent.width;
                text: column-value;
                color: root.data.unavailable
                    ? (root.dark ? #8a8a8a : #73808c)
                    : data.selected
                        ? (root.dark ? #ececec : #1f2f3f)
                        : root.is-playing
                            ? (index < root.headers.length && root.headers[index] == "Title")
                                ? (root.dark ? #d7e9ff : #21496f)
                                : (root.dark ? #b5c9e3 : #406487)
                            : (index < root.headers.length && root.headers[index] == "Title")
                                ? (root.dark ? #eee : #243444)
                                : (root.dark ? #aaa : #5a6877);
                font-size: 13px;
                vertical-alignment: center;
                overflow: elide;
                horizontal-alignment: left;
            }
        }

        Rectangle { horizontal-stretch: 1; }

        Rectangle {
            width: root.null-column-width;

            if root.data.source_badge != "" : Rectangle {
                x: parent.width - self.width - 8px;
                y: (parent.height - self.height) / 2;
                width: 26px;
                height: 18px;
                border-radius: 9px;
                border-width: 1px;
                border-color: root.dark ? #3f5470 : #b4cde8;
                background: root.dark ? #1f3248 : #e2eefb;

                Image {
                    source: AppIcons.opensubsonic;
                    width: 12px;
                    height: 12px;
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    image-fit: contain;
                    colorize: root.dark ? #9fc3eb : #2d5f98;
                }
            }
        }
    }
}
