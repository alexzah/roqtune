import { LineEdit } from "std-widgets.slint";

import { TrackRowData } from "../types.slint";
import { AppIcons } from "../icons.slint";
import { ContextMenu } from "menus.slint";
import { RichTextBlockView } from "media.slint";
import { AppPalette } from "../theme_palette.slint";

export component PlaylistRow inherits Rectangle {
    in property <string> name;
    in property <bool> is-active;
    in property <bool> is-editing;
    in property <bool> is-remote;
    in property <bool> is-new-playlist-edit;
    in property <bool> can-sync-opensubsonic;
    callback clicked();
    callback renamed(string);
    callback context-menu-rename();
    callback context-menu-delete();
    callback context-menu-sync();
    callback cancel-edit();

    property <length> menu-x;
    property <length> menu-y;

    height: 24px;
    background: is-active
        ? AppPalette.selection-bg
        : ta.has-hover
            ? AppPalette.control-hover-bg
            : transparent;
    border-radius: 2px;

    if !is-editing : Text {
        x: 8px;
        width: max(0px, parent.width - (root.is-remote ? 32px : 12px));
        text: root.name;
        color: is-active ? AppPalette.text-primary : AppPalette.text-secondary;
        font-size: 13px;
        vertical-alignment: center;
        horizontal-alignment: left;
        overflow: elide;
    }

    if !is-editing && root.is-remote : Rectangle {
        x: parent.width - self.width - 8px;
        y: (parent.height - self.height) / 2;
        width: 14px;
        height: 14px;
        border-radius: 7px;
        border-width: 1px;
        border-color: AppPalette.accent-soft-border;
        background: AppPalette.accent-soft-bg;

        Image {
            source: AppIcons.opensubsonic;
            width: 8px;
            height: 8px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            image-fit: contain;
            colorize: AppPalette.accent;
        }
    }

    if is-editing : LineEdit {
        x: 4px;
        width: parent.width - 8px;
        height: parent.height - 4px;
        text: root.is-new-playlist-edit ? "" : root.name;
        placeholder-text: root.is-new-playlist-edit ? root.name : "";
        accepted => {
            root.renamed(self.text);
        }
        init => {
            self.focus();
        }
    }

    ta := TouchArea {
        visible: !is-editing;
        clicked => { root.clicked(); }
        pointer-event(event) => {
            if (event.button == PointerEventButton.right && event.kind == PointerEventKind.down) {
                root.menu-x = self.mouse-x;
                root.menu-y = self.mouse-y;
                menu.show();
            }
        }
    }

    menu := ContextMenu {
        is-playlist: true;
        show-sync-item: root.can-sync-opensubsonic;
        x: root.menu-x;
        y: root.menu-y;
        rename => {
            root.context-menu-rename();
        }
        sync-opensubsonic => {
            root.context-menu-sync();
        }
        delete => {
            root.context-menu-delete();
        }
    }

    FocusScope {
        visible: root.is-editing;
        key-pressed(event) => {
            if (event.text == Key.Escape) {
                root.cancel-edit();
                return accept;
            }
            reject
        }
    }
}

export component TrackRow inherits Rectangle {
    in property <TrackRowData> data;
    in property <bool> is-playing;
    in property <bool> is-hover;
    in property <[string]> headers: [];
    in property <[int]> column-kinds: [];
    in property <[int]> column-widths-px: [];
    in property <length> row-height: 30px;
    in property <length> null-column-width: 120px;
    in property <length> horizontal-padding: 8px;
    in property <length> column-spacing: 10px;
    in property <length> status-lane-width: 40px;

    pure function column-width-for-index(index: int) -> length {
        if index >= 0 && index < root.column-widths-px.length {
            return max(1px, root.column-widths-px[index] * 1px);
        }
        return 140px;
    }

    height: root.row-height;
    property <brush> idle-background: data.selected
        ? AppPalette.selection-bg
        : transparent;
    background: root.data.unavailable
        ? (data.selected
            ? AppPalette.panel-bg-alt
            : AppPalette.panel-bg-elevated)
        : is-hover
            ? data.selected
                ? AppPalette.selection-border.mix(AppPalette.selection-bg, 0.6)
                : AppPalette.control-hover-bg
            : root.idle-background;
    animate background { duration: 100ms; }
    opacity: root.data.unavailable ? 0.68 : 1.0;

    HorizontalLayout {
        padding-left: root.horizontal-padding;
        padding-right: root.horizontal-padding;
        spacing: root.column-spacing;

        Rectangle {
            width: root.status-lane-width;
            Text {
                text: root.data.status;
                color: root.data.unavailable ? AppPalette.text-disabled : AppPalette.accent;
                font-size: 14px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        for column-value[index] in root.data.values : Rectangle {
            width: root.column-width-for-index(index);
            clip: true;
            property <int> column-kind: index < root.column-kinds.length ? root.column-kinds[index] : 0;

            if self.column-kind == 1 : Rectangle {
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                width: max(16px, min(parent.width, root.height - 8px));
                height: self.width;
                border-radius: 2px;
                background: AppPalette.panel-bg-alt;
                Image {
                    source: root.data.album_art;
                    width: parent.width;
                    height: parent.height;
                    image-fit: contain;
                }
            }

            if self.column-kind == 2 : Rectangle {
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                width: 18px;
                height: 18px;
                Image {
                    source: root.data.favorited ? AppIcons.heart-filled : AppIcons.heart;
                    width: 14px;
                    height: 14px;
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    image-fit: contain;
                    colorize: root.data.favorited
                        ? AppPalette.accent
                        : AppPalette.text-muted;
                }
            }

            if self.column-kind != 1 && self.column-kind != 2 : Rectangle {
                width: parent.width;
                height: parent.height;
                clip: true;
                property <color> base-text-color: root.data.unavailable
                    ? AppPalette.text-disabled
                    : data.selected
                        ? AppPalette.text-primary
                        : (index < root.headers.length && root.headers[index] == "Title")
                            ? AppPalette.text-primary
                            : AppPalette.text-secondary;
                property <bool> has-rich-value: index >= 0 && index < root.data.rich_values.length;

                if self.has-rich-value : RichTextBlockView {
                    x: 0px;
                    y: 0px;
                    width: parent.width;
                    height: parent.height;
                    block: root.data.rich_values[index];
                    default-color: parent.base-text-color;
                    compact: root.row-height <= 32px;
                    max-lines: 6;
                    clip-lines: true;
                }

                if !self.has-rich-value : Text {
                    x: 0px;
                    width: parent.width;
                    text: column-value;
                    color: parent.base-text-color;
                    font-size: 13px;
                    vertical-alignment: center;
                    overflow: elide;
                    horizontal-alignment: left;
                }
            }
        }

        Rectangle { horizontal-stretch: 1; }

        Rectangle {
            width: root.null-column-width;

            if root.data.source_badge != "" : Rectangle {
                x: parent.width - self.width - 8px;
                y: (parent.height - self.height) / 2;
                width: 26px;
                height: 18px;
                border-radius: 9px;
                border-width: 1px;
                border-color: AppPalette.accent-soft-border;
                background: AppPalette.accent-soft-bg;

                Image {
                    source: AppIcons.opensubsonic;
                    width: 12px;
                    height: 12px;
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    image-fit: contain;
                    colorize: AppPalette.accent;
                }
            }
        }
    }
}
