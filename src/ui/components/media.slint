import { AppIcons } from "../icons.slint";
import { AppPalette } from "../theme_palette.slint";
import { RichTextBlock } from "../types.slint";

export component VolumeSliderControl inherits Rectangle {
    in-out property <float> value: 1.0;
    callback changed(float);

    private property <length> icon-slot-width: 18px;
    private property <length> track-height: 6px;
    private property <length> handle-base-size: 10px;
    private property <length> handle-hover-size: 12px;
    background: transparent;

    HorizontalLayout {
        spacing: 6px;

        icon-slot := Rectangle {
            width: root.icon-slot-width;
            height: root.height;
            background: transparent;
            Image {
                source: AppIcons.volume;
                width: max(9px, min(12px, root.height * 0.45));
                height: self.width;
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                image-fit: contain;
                colorize: AppPalette.text-muted;
            }
        }

        slider-area := Rectangle {
            horizontal-stretch: 1;
            height: root.height;
            background: transparent;

            volume-track := Rectangle {
                x: 0px;
                y: (parent.height - self.height) / 2;
                width: parent.width;
                height: root.track-height;
                border-radius: 3px;
                background: AppPalette.separator;
            }

            Rectangle {
                x: volume-track.x;
                y: volume-track.y;
                width: volume-track.width * root.value;
                height: volume-track.height;
                background: AppPalette.accent;
                border-radius: 3px;
            }

            volume-handle := Rectangle {
                width: root.handle-base-size;
                height: root.handle-base-size;
                x: volume-track.width > 0px ? volume-track.x + (volume-track.width * root.value) - self.width / 2 : volume-track.x;
                y: volume-track.y + (volume-track.height - self.height) / 2;
                background: AppPalette.accent-on;
                border-radius: 5px;
                animate x { duration: 100ms; easing: ease-out; }
            }

            states [
                hover when ta-volume.has-hover || ta-volume.pressed: {
                    volume-handle.width: root.handle-hover-size;
                    volume-handle.height: root.handle-hover-size;
                }
            ]

            ta-volume := TouchArea {
                x: 0px;
                y: 0px;
                width: parent.width;
                height: parent.height;
                mouse-cursor: pointer;
                clicked => {
                    if (volume-track.width > 0px) {
                        root.value = max(0, min(1, self.mouse-x / volume-track.width));
                        root.changed(root.value);
                    }
                }
                moved => {
                    if (self.pressed && volume-track.width > 0px) {
                        root.value = max(0, min(1, self.mouse-x / volume-track.width));
                        root.changed(root.value);
                    }
                }
            }

            if ta-volume.pressed : Rectangle {
                width: 32px;
                height: 12px;
                x: min(
                    volume-track.x + volume-track.width - self.width - 2px,
                    max(volume-track.x + 2px, volume-handle.x - self.width / 2)
                );
                y: max(0px, volume-track.y - self.height - 2px);
                z: 10;
                border-radius: 3px;
                background: AppPalette.panel-bg-elevated;
                border-width: 1px;
                border-color: AppPalette.border;
                Text {
                    text: floor(root.value * 100) + "%";
                    color: AppPalette.text-primary;
                    font-size: 8px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }
    }
}

export component SeekBarControl inherits Rectangle {
    in property <float> position-percentage: 0.0;
    in property <string> elapsed-text: "0:00";
    in property <string> total-text: "0:00";
    callback seek-requested(float);
    in property <color> panel-bg: AppPalette.panel-bg;
    in property <color> text-muted: AppPalette.text-muted;
    in property <color> track-bg: AppPalette.separator;
    in property <color> progress-bg: AppPalette.accent;
    in property <color> handle-bg: AppPalette.accent-on;
    in property <color> handle-border: AppPalette.border;
    in property <color> handle-shadow: AppPalette.overlay-scrim;
    private property <bool> scrub-active: false;
    private property <float> scrub-position: max(0, min(1, root.position-percentage));
    private property <bool> pending-seek-active: false;
    private property <float> pending-seek-position: max(0, min(1, root.position-percentage));
    private property <int> pending-seek-updates-remaining: 0;
    private property <float> display-position: root.scrub-active
        ? root.scrub-position
        : root.pending-seek-active
            ? root.pending-seek-position
            : root.position-percentage;
    private property <length> side-padding: 12px;
    private property <length> vertical-padding: 8px;
    private property <length> time-font-size: 12px;
    private property <length> label-width: 52px;
    private property <length> seek-height: 6px;
    private property <length> handle-base-size: 12px;
    private property <length> handle-hover-size: 14px;

    changed position-percentage => {
        let clamped = max(0, min(1, root.position-percentage));
        if (root.scrub-active) {
            return;
        }
        if (root.pending-seek-active) {
            root.pending-seek-updates-remaining = max(0, root.pending-seek-updates-remaining - 1);
            if (abs(clamped - root.pending-seek-position) <= 0.02
                    || root.pending-seek-updates-remaining == 0) {
                root.pending-seek-active = false;
                root.pending-seek-position = clamped;
                root.scrub-position = clamped;
            } else {
                // Hold to avoid release jitter until playback position catches up.
                root.scrub-position = root.pending-seek-position;
            }
        } else {
            root.scrub-position = clamped;
        }
    }

    background: root.panel-bg;
    bar-row := HorizontalLayout {
        private property <length> time-slot-width: max(
            root.label-width,
            max(elapsed-label.preferred-width + 6px, total-label.preferred-width + 6px)
        );
        padding-left: root.side-padding;
        padding-right: root.side-padding;
        padding-top: root.vertical-padding;
        padding-bottom: root.vertical-padding;
        spacing: 10px;

        elapsed-label := Text {
            text: root.elapsed-text;
            color: root.text-muted;
            font-size: root.time-font-size;
            vertical-alignment: center;
            horizontal-alignment: right;
            width: bar-row.time-slot-width;
        }

        seekbar := Rectangle {
            height: root.seek-height;
            border-radius: 3px;
            background: root.track-bg;
            horizontal-stretch: 1;
            Rectangle {
                x: 0;
                y: 0;
                width: seekbar.width * root.display-position;
                height: parent.height;
                background: root.progress-bg;
                border-radius: 3px;
                animate width { duration: 150ms; easing: ease-out; }
            }
            handle := Rectangle {
                width: root.handle-base-size;
                height: root.handle-base-size;
                x: (seekbar.width * root.display-position) - self.width / 2;
                y: (parent.height - self.height) / 2;
                background: root.handle-bg;
                border-radius: 6px;
                border-width: 1px;
                border-color: root.handle-border;
                drop-shadow-offset-y: 1px;
                drop-shadow-blur: 2px;
                drop-shadow-color: root.handle-shadow;
                animate x { duration: 150ms; easing: ease-out; }
            }
            states [
                hover when ta-seek.has-hover || ta-seek.pressed: {
                    handle.background: root.handle-bg;
                    handle.width: root.handle-hover-size;
                    handle.height: root.handle-hover-size;
                }
            ]
            ta-seek := TouchArea {
                width: parent.width;
                height: max(16px, root.handle-hover-size + 6px);
                mouse-cursor: pointer;
                changed pressed => {
                    if (seekbar.width <= 0px) {
                        if (!self.pressed) {
                            root.scrub-active = false;
                        }
                        return;
                    }

                    if (self.pressed) {
                        root.scrub-active = true;
                        root.pending-seek-active = false;
                        root.pending-seek-updates-remaining = 0;
                        root.scrub-position = max(0, min(1, self.mouse-x / seekbar.width));
                    } else if (root.scrub-active) {
                        root.scrub-active = false;
                        root.pending-seek-position = root.scrub-position;
                        root.pending-seek-active = true;
                        root.pending-seek-updates-remaining = 36;
                        root.seek-requested(root.scrub-position);
                    }
                }
                moved => {
                    if (self.pressed && seekbar.width > 0px) {
                        root.scrub-position = max(0, min(1, self.mouse-x / seekbar.width));
                    }
                }
            }
        }

        total-label := Text {
            text: root.total-text;
            color: root.text-muted;
            font-size: root.time-font-size;
            vertical-alignment: center;
            horizontal-alignment: left;
            width: bar-row.time-slot-width;
        }
    }
}

export component RichTextBlockView inherits Rectangle {
    in property <RichTextBlock> block;
    in property <color> default-color: AppPalette.text-secondary;
    in property <bool> compact: false;
    in property <int> max-lines: 0; // 0 means no limit
    in property <bool> clip-lines: true;

    pure function color-from-palette(code: int) -> color {
        if code == 1 {
            return AppPalette.accent;
        } else if code == 2 {
            return AppPalette.accent-on;
        } else if code == 3 {
            return AppPalette.warning;
        } else if code == 4 {
            return AppPalette.danger;
        } else if code == 5 {
            return AppPalette.success;
        } else if code == 6 {
            return AppPalette.text-primary;
        } else if code == 7 {
            return AppPalette.text-secondary;
        } else if code == 8 {
            return AppPalette.text-muted;
        } else if code == 9 {
            return AppPalette.text-disabled;
        } else if code == 10 {
            return AppPalette.border;
        } else if code == 11 {
            return AppPalette.panel-bg;
        } else if code == 12 {
            return AppPalette.panel-bg-alt;
        } else if code == 13 {
            return AppPalette.window-bg;
        } else if code == 14 {
            return AppPalette.selection-bg;
        } else if code == 15 {
            return AppPalette.selection-border;
        } else if code == 16 {
            return AppPalette.control-hover-bg;
        }
        return root.default-color;
    }

    pure function run-color(color-mode: int, palette-color: int, color-rgba: color) -> color {
        if color-mode == 2 {
            return color-rgba;
        } else if color-mode == 1 {
            return root.color-from-palette(palette-color);
        }
        return root.default-color;
    }

    background: transparent;
    clip: root.clip-lines;
    VerticalLayout {
        spacing: root.compact ? 1px : 2px;
        for line[index] in root.block.lines : Rectangle {
            visible: root.max-lines <= 0 || index < root.max-lines;
            clip: root.clip-lines;
            HorizontalLayout {
                spacing: 0px;
                for run in line.runs : Rectangle {
                    width: run-text.preferred-width;
                    height: run-text.preferred-height;
                    run-text := Text {
                        text: run.text;
                        color: root.run-color(run.color_mode, run.palette_color, run.color_rgba);
                        font-size: max(1px, run.font_size_px * 1px);
                        font-family: run.font_family;
                        font-weight: run.bold ? 700 : 400;
                        font-italic: run.italic;
                        vertical-alignment: center;
                        horizontal-alignment: left;
                        overflow: clip;
                    }
                    if run.underline : Rectangle {
                        y: run-text.y + run-text.height - 1px;
                        width: run-text.preferred-width;
                        height: 1px;
                        background: root.run-color(run.color_mode, run.palette_color, run.color_rgba);
                    }
                }
                Rectangle { horizontal-stretch: 1; }
            }
        }
    }
}

export component TextPanel inherits Rectangle {
    in property <RichTextBlock> display-text;
    private property <bool> has-metadata: root.display-text.plain_text != "";
    private property <bool> compact: root.width < 220px || root.height < 120px;
    in property <color> text-primary: AppPalette.text-primary;
    in property <color> text-secondary: AppPalette.text-secondary;
    in property <color> text-muted: AppPalette.text-muted;
    in property <color> text-disabled: AppPalette.text-disabled;

    background: transparent;
    if root.has-metadata : RichTextBlockView {
        width: parent.width;
        height: min(parent.height, self.preferred-height);
        y: (parent.height - self.height) / 2;
        block: root.display-text;
        compact: root.compact;
        default-color: root.text-secondary;
        clip-lines: true;
    }

    if !root.has-metadata : Rectangle {
        width: parent.width;
        height: parent.height;
        background: transparent;

        Text {
            text: "No track selected";
            color: root.text-disabled;
            font-size: root.compact ? 11px : 14px;
            font-weight: 600;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
}

export component ImagePanel inherits Rectangle {
    in property <image> art-source;
    in property <bool> has-art: false;
    in property <color> panel-bg: AppPalette.panel-bg-alt;
    in property <color> frame-border: AppPalette.border;
    in property <color> frame-bg: AppPalette.panel-bg-elevated;
    in property <color> frame-inner-border: AppPalette.separator;
    in property <color> frame-inner-bg: AppPalette.panel-bg-alt;
    in property <color> placeholder-icon: AppPalette.text-muted;
    in property <color> placeholder-text: AppPalette.text-disabled;
    private property <bool> compact: root.width < 180px || root.height < 140px;
    private property <bool> dense: root.width < 130px || root.height < 100px;
    private property <length> placeholder-padding: root.dense ? 8px : root.compact ? 12px : 24px;
    private property <length> placeholder-min-size: root.dense ? 24px : root.compact ? 36px : 72px;
    private property <length> placeholder-inner-padding: root.dense ? 4px : 8px;
    private property <length> placeholder-icon-size: root.dense ? 14px : root.compact ? 18px : 24px;
    private property <bool> show-placeholder-label: root.width >= 120px && root.height >= 96px;

    vertical-stretch: 1;
    background: root.panel-bg;
    border-radius: 4px;

    if root.has-art : Image {
        source: root.art-source;
        width: parent.width;
        height: parent.height;
        image-fit: contain;
    }

    if !root.has-art : Rectangle {
        width: max(
            root.placeholder-min-size,
            min(parent.width - root.placeholder-padding, parent.height - root.placeholder-padding)
        );
        height: self.width;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        border-radius: 6px;
        border-width: 1px;
        border-color: root.frame-border;
        background: root.frame-bg;

        Rectangle {
            x: root.placeholder-inner-padding;
            y: root.placeholder-inner-padding;
            width: max(0px, parent.width - root.placeholder-inner-padding * 2);
            height: max(0px, parent.height - root.placeholder-inner-padding * 2);
            border-radius: 4px;
            border-width: 1px;
            border-color: root.frame-inner-border;
            background: root.frame-inner-bg;

            VerticalLayout {
                width: parent.width;
                height: parent.height;
                spacing: root.dense ? 2px : 4px;

                Rectangle { vertical-stretch: 1; }
                Image {
                    source: AppIcons.music;
                    width: root.placeholder-icon-size;
                    height: root.placeholder-icon-size;
                    x: (parent.width - self.width) / 2;
                    image-fit: contain;
                    colorize: root.placeholder-icon;
                }
                if root.show-placeholder-label : Text {
                    text: "No album art";
                    color: root.placeholder-text;
                    font-size: root.dense ? 9px : 11px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
                Rectangle { vertical-stretch: 1; }
            }
        }
    }
}
