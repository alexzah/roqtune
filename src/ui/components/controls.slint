import { Palette } from "std-widgets.slint";
import { AppIcons } from "../icons.slint";

export component TooltipHoverArea inherits TouchArea {
    in property <string> tooltip-text: "";
    in property <bool> tooltip-enabled: true;
    callback tooltip_hover_changed(bool, string, int, int);

    changed has-hover => {
        if (root.tooltip-enabled && root.tooltip-text != "") {
            root.tooltip_hover_changed(
                self.has-hover,
                root.tooltip-text,
                floor((root.absolute-position.x + root.width / 2) / 1px),
                floor((root.absolute-position.y + root.height) / 1px)
            );
        }
    }

    changed tooltip-enabled => {
        if (!root.tooltip-enabled && root.has-hover) {
            root.tooltip_hover_changed(false, "", 0, 0);
        }
    }

    changed tooltip-text => {
        if (root.tooltip-text == "" && root.has-hover) {
            root.tooltip_hover_changed(false, "", 0, 0);
        }
    }
}

export component PlayerButton inherits Rectangle {
    width: 32px;
    height: 32px;
    private property <bool> dark: Palette.color-scheme == ColorScheme.dark;
    background: touch-area.pressed
        ? (root.dark ? #444 : #d4dde8)
        : touch-area.has-hover
            ? (root.dark ? #666 : #e2e9f1)
            : transparent;
    animate background { duration: 150ms; }
    private property <brush> icon-color: root.is-primary ? #2a6def : (root.dark ? #eee : #263443);
    private property <bool> has-icon: root.icon-source.width > 0 && root.icon-source.height > 0;
    in property <string> icon-text;
    in property <image> icon-source;
    in property <string> tooltip-text: "";
    in property <bool> enabled: true;
    in property <bool> is-primary: false;
    in property <length> font-size: 16px;
    callback clicked;
    callback tooltip_hover_changed(bool, string, int, int);

    if root.has-icon : Image {
        source: root.icon-source;
        width: root.font-size;
        height: root.font-size;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        image-fit: contain;
        colorize: root.icon-color;
        opacity: root.enabled ? 1.0 : 0.5;
    }

    if !root.has-icon : Text {
        text: root.icon-text;
        font-size: root.font-size;
        color: root.icon-color;
        horizontal-alignment: center;
        vertical-alignment: center;
        opacity: root.enabled ? 1.0 : 0.5;
    }

    touch-area := TouchArea {
        changed has-hover => {
            if root.tooltip-text != "" {
                root.tooltip_hover_changed(
                    self.has-hover,
                    root.tooltip-text,
                    floor((root.absolute-position.x + root.width / 2) / 1px),
                    floor((root.absolute-position.y + root.height) / 1px)
                );
            }
        }
        pointer-event(event) => {
            if (event.button == PointerEventButton.right && event.kind == PointerEventKind.down) {
                root.right-clicked();
            }
        }
        clicked => {
            if (root.enabled) {
                if root.tooltip-text != "" {
                    root.tooltip_hover_changed(false, "", 0, 0);
                }
                root.clicked();
            }
        }
    }
    callback right-clicked;
}

export component ControlActionButton inherits Rectangle {
    in property <int> action-id: 0;
    in property <string> cluster-leaf-id: "";
    in property <int> playback-order-index: 0;
    in property <int> repeat-mode: 0;
    in property <bool> cast-connected: false;
    in property <bool> cast-connecting: false;
    in property <int> collection-mode: 0;
    in property <bool> layout-edit-mode: false;
    in property <bool> has-current-track-context: false;
    in property <bool> now-playing-favorited: false;
    callback invoked(int);
    callback open-add-menu(string);
    callback tooltip_hover_changed(bool, string, int, int);

    pure function font-size-for-action(action: int) -> length {
        if action == 1 { return 18px; }
        if action == 10 { return 18px; }
        return 17px;
    }

    pure function primary-for-action(action: int) -> bool {
        if action == 3 { return true; }
        if action == 7 { return root.playback-order-index != 0; }
        if action == 8 { return root.repeat-mode != 0; }
        if action == 9 { return root.layout-edit-mode; }
        if action == 11 { return root.cast-connected || root.cast-connecting; }
        if action == 12 { return root.now-playing-favorited; }
        return false;
    }

    pure function tooltip-for-action(action: int) -> string {
        if action == 1 { return "Import tracks or folders"; }
        if action == 2 { return "Previous track"; }
        if action == 3 { return "Play"; }
        if action == 4 { return "Pause"; }
        if action == 5 { return "Stop"; }
        if action == 6 { return "Next track"; }
        if action == 7 {
            return "Playback order: "
                + (root.playback-order-index == 0 ? "Default"
                    : root.playback-order-index == 1 ? "Shuffle"
                    : "Random")
                + " (click to cycle)";
        }
        if action == 8 {
            return "Repeat mode: "
                + (root.repeat-mode == 0 ? "Off"
                    : root.repeat-mode == 1 ? "Playlist"
                    : "Track")
                + " (click to cycle)";
        }
        if action == 9 { return "Layout editor"; }
        if action == 10 { return "Settings menu"; }
        if action == 11 {
            return root.cast-connected
                ? "Cast connected (click to manage)"
                : root.cast-connecting
                    ? "Connecting to cast device..."
                    : "Cast to a device on your network";
        }
        if action == 12 {
            return root.now-playing-favorited
                ? "Unfavorite now playing track"
                : "Favorite now playing track";
        }
        return "";
    }

    pure function enabled-for-action(action: int) -> bool {
        if action == 1 {
            return root.collection-mode == 0;
        }
        if action == 12 {
            return root.has-current-track-context;
        }
        return true;
    }

    width: 32px;
    height: 32px;

    PlayerButton {
        icon-source: root.action-id == 1 ? AppIcons.plus
            : root.action-id == 2 ? AppIcons.player-prev
            : root.action-id == 3 ? AppIcons.player-play
            : root.action-id == 4 ? AppIcons.player-pause
            : root.action-id == 5 ? AppIcons.player-stop
            : root.action-id == 6 ? AppIcons.player-next
            : root.action-id == 7 ? AppIcons.shuffle
            : root.action-id == 8 ? AppIcons.repeat
            : root.action-id == 9 ? AppIcons.layout
            : root.action-id == 10 ? AppIcons.settings
            : root.action-id == 11 ? AppIcons.cast
            : root.action-id == 12
                ? (root.now-playing-favorited ? AppIcons.heart-filled : AppIcons.heart)
            : AppIcons.music;
        icon-text: "";
        tooltip-text: root.tooltip-for-action(root.action-id);
        enabled: root.enabled-for-action(root.action-id);
        font-size: root.font-size-for-action(root.action-id);
        is-primary: root.primary-for-action(root.action-id);
        clicked => { root.invoked(root.action-id); }
        right-clicked => {
            if (root.layout-edit-mode) {
                root.open-add-menu(root.cluster-leaf-id);
            }
        }
        tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
            root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
        }
    }

    if root.action-id == 7 && root.playback-order-index == 2 : Rectangle {
        width: 10px;
        height: 10px;
        x: 15px;
        y: 11px;
        border-radius: 5px;
        background: #2a6def;
        Text {
            text: "?";
            color: white;
            font-size: 7px;
            font-weight: 700;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }

    if root.action-id == 8 && root.repeat-mode == 2 : Rectangle {
        width: 10px;
        height: 10px;
        x: 15px;
        y: 11px;
        border-radius: 5px;
        background: #2a6def;
        Text {
            text: "1";
            color: white;
            font-size: 7px;
            font-weight: 700;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
}

export component ButtonCluster inherits Rectangle {
    in property <string> cluster-leaf-id: "";
    in property <[int]> button-actions: [];
    in property <int> playback-order-index: 0;
    in property <int> repeat-mode: 0;
    in property <bool> cast-connected: false;
    in property <bool> cast-connecting: false;
    in property <int> collection-mode: 0;
    in property <bool> layout-edit-mode: false;
    in property <bool> has-current-track-context: false;
    in property <bool> now-playing-favorited: false;
    callback action-invoked(int);
    callback request-add-menu(string);
    callback tooltip_hover_changed(bool, string, int, int);
    private property <bool> dark: Palette.color-scheme == ColorScheme.dark;

    width: max(32px, button-actions.length * 32px + max(0, button-actions.length - 1) * 8px);
    height: 32px;

    if root.button-actions.length == 0 : Rectangle {
        width: 32px;
        height: 32px;
        border-radius: 3px;
        border-width: 1px;
        border-color: root.dark ? #3d3d3d : #c3cdd9;
        background: empty-cluster-ta.has-hover
            ? (root.dark ? #333 : #dde5ef)
            : (root.dark ? #2a2a2a : #eef3f9);
        Text {
            text: "...";
            color: root.dark ? #999 : #5e6d7d;
            font-size: 16px;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
        empty-cluster-ta := TouchArea {
            pointer-event(event) => {
                if (root.layout-edit-mode
                    && event.button == PointerEventButton.right
                    && event.kind == PointerEventKind.down) {
                    root.request-add-menu(root.cluster-leaf-id);
                }
            }
        }
    }

    HorizontalLayout {
        spacing: 8px;
        for action in root.button-actions : ControlActionButton {
            action-id: action;
            cluster-leaf-id: root.cluster-leaf-id;
            playback-order-index: root.playback-order-index;
            repeat-mode: root.repeat-mode;
                cast-connected: root.cast-connected;
                cast-connecting: root.cast-connecting;
                collection-mode: root.collection-mode;
                layout-edit-mode: root.layout-edit-mode;
                has-current-track-context: root.has-current-track-context;
                now-playing-favorited: root.now-playing-favorited;
            invoked(action-id) => { root.action-invoked(action-id); }
            open-add-menu(cluster-leaf-id) => { root.request-add-menu(cluster-leaf-id); }
            tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px) => {
                root.tooltip_hover_changed(is-hovered, tooltip, anchor-x-px, anchor-y-px);
            }
        }
    }
}
